define(function(a,b,c){var d=a("jquery"),e=a("store"),f=a("handlebars"),g=a("rex"),h=a("util"),i=a("bus"),j=a("api"),k=a("moment");k.calendar={sameDay:"ha, dddd MMMM D",nextDay:"h:ssA [Tomorrow], dddd MMMM D",nextWeek:"dddd [at] LT",lastDay:"hA, dddd MMMM D",lastWeek:"hA, dddd MMMM D",sameElse:"L"},f.registerHelper("each",function(a,b){var c=b.fn,d=b.inverse,e="",f,g;if(a&&a.length)for(f=0,g=a.length;f<g;++f)a[f].__index__=f,e+=c(a[f]);else e=d(this);return e}),f.registerHelper("ifFalse",function(a,b){return f.helpers["if"].call(this,!a,b)}),f.registerHelper("avatarFilename",function(a,b){return a}),f.registerHelper("printName",function(a,b){return a||(a=b.match(/([^@]+)@[^@]+/)[1]),a}),f.registerHelper("printTime",function(a){var b=k(),c=b.format("Z"),d=a.begin_at,e=/(^[\+\-]\d\d:\d\d)/.exec(d.timezone)[1],f=k.utc(d.date+" "+d.time+" "+e,"YYYY-MM-DD HH:mm:ss Z"),g="",h,i=c===e;return a.outputformat?(g=a.origin,i||(g+=" "+e),g):(d.time_word&&(g+=d.time_word+" (at) "),g+=d.time,i||(g+=" ("+e+") "),d.date_word&&(g+=d.date_word+" (on) "),g+=" "+d.date,f.year()!==b.year()&&(g+=" "+y),f.calendar())}),f.registerHelper("printTime2",function(a,b){return a=f.helpers.crossItem.call(this,a,b),f.helpers.printTime4.call(this,a)}),f.registerHelper("printTime4",function(a){var b=k(),c=b.format("Z"),d=a.begin_at,e=/(^[\+\-]\d\d:\d\d)/.exec(d.timezone)[1],f=k.utc(d.date+" "+d.time+" "+e,"YYYY-MM-DD HH:mm:ss Z"),g="",h="",i=c===e;return a.outputformat?(g=a.origin,i||(g+=" "+e),g):(d.time!=="00:00:00"&&(h+="hA "),d.date&&(h+="ddd MMM D"),f.format(h))}),f.registerHelper("printTime3",function(a,b){var c=a.begin_at,d=/(^[\+\-][\d]{2}:[\d]{2})/.exec(c.timezone)[1],e=k.utc(c.date+" "+c.time+" "+d,"YYYY-MM-DD HH:mm:ss Z");return e.fromNow()}),f.registerHelper("rsvpAction",function(a,b){var c=g.filter(a,function(a){if(a.identity.id===b)return!0})[0],d="";if(c.rsvp_status!=="INTERESTED"){var d='<div><i class="';d+="icon-rsvp-"+c.rsvp_status.toLowerCase()+'"></i> ',d+=c.rsvp_status.charAt(0)+c.rsvp_status.substr(1).toLowerCase()+": "+c.identity.name+"</div>"}var e=g.map(a,function(a){if(a.by_identity.id===b&&a.identity.id!==b)return a.identity.name}).filter(function(a){if(a)return!0}).join(" ,");return d+='<div><i class="icon-invite"></i> ',d+="Invited: "+e,d+="</div>",d}),f.registerHelper("ifPlace",function(a){var b=f.helpers.crossItem.call(this,"place");return f.helpers["if"].call(this,b.length,a)}),f.registerHelper("ifOauthVerifying",function(a,b,c){var d=a==="twitter"&&b==="VERIFYING";return f.helpers["if"].call(this,d,c,c)}),f.registerHelper("makeDefault",function(a,b,c){var d=!a&&b==="CONNECTED";return f.helpers["if"].call(this,d,c,c)}),f.registerHelper("ifVerifying",function(a,b,c){var d=a==="email"&&b==="VERIFYING";return f.helpers["if"].call(this,d,c)}),f.registerHelper("atName",function(a,b){return b}),f.registerHelper("editable",function(a,b,c){var d=a==="email"&&b==="CONNECTED";return f.helpers["if"].call(this,d,c)});var l=function(a){if(!a)return;var b;a.response?b=a.response.user:a instanceof Array&&(b=a[0].response.user),e.set("user",b),d(".user-xstats .attended").html(b.cross_quantity),d("#user-name > span").html(b.name);var c=d("#jst-user-avatar"),h=f.compile(c.html()),i=h({avatar_filename:b.avatar_filename});d(".user-avatar").append(i),d(".user-name").find("h3").html(b.name);var j=d("#jst-identity-list"),h=f.compile(j.html()),k=b.default_identity;g.each(b.identities,function(a,b){a.id===k.id&&(a.__default__=!0)});var i=h({identities:b.identities});d(".identity-list").append(i)},m=function(a){if(!a)return;a=e.get("signin");if(!a)return;var b=a.user_id;return j.request("crosslist",{resources:{user_id:b}},function(a){var b=+(new Date);if(a.crosses.length){var c=d("#jst-crosses-container");f.registerHelper("confirmed_nums",function(a){return g.filter(a,function(a){if(a.rsvp_status==="ACCEPTED")return!0}).length}),f.registerHelper("total",function(a){return a.length}),f.registerHelper("confirmed_identities",function(a){var b=g(a).filter(function(a){if(a.rsvp_status==="ACCEPTED")return!0});return g(b.slice(0,7)).map(function(a,b){return a.identity.name}).join(", ")}),f.registerPartial("jst-cross-box",d("#jst-cross-box").html());var e=f.compile(c.html()),h="",i="upcoming<Upcoming> sometime<Sometime> sevendays<Next 7 days> later<Later> past<Past>",j={};g.map(a.crosses,function(a,b){j[a.sort]||(j[a.sort]={crosses:[]}),j[a.sort].crosses.push(a)});var k=a.more.join(" "),l=/<|>/;g.map(i.split(" "),function(a,b){a=a.split(l);var c=j[a[0]];c&&(c.cate=a[0],c.cate_date=a[1],c.hasMore=k.search(a[0])>-1,h+=e(c))}),d("#profile .crosses").append(h)}})},n=function(a){if(!a)return;a=e.get("signin");if(!a)return;var b=a.user_id,c=new Date;return c=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),j.request("crosses",{resources:{user_id:b}},function(a){var c=new Date,e=a.crosses,h=[],i=[],j,l=[],m={},n=[];g.each(e,function(a,c){a.exfee&&a.exfee.invitations&&a.exfee.invitations.length&&g.each(a.exfee.invitations,function(a,d){m[a.id]=[c,d],b===a.identity.connected_user_id&&a.rsvp_status==="NORESPONSE"&&(a.__crossIndex=c,a.__identityIndex=d,h.push(a))})}),f.registerHelper("crossItem",function(a){return a==="place"?e[this.__crossIndex][a].title:a==="invitationid"?e[this.__crossIndex].exfee.invitations[this.__identityIndex].id:a==="exfeeid"?e[this.__crossIndex].exfee.id:e[this.__crossIndex][a]}),f.registerHelper("conversation_nums",function(){return this.__conversation_nums}),f.registerHelper("humanTime",function(a){return k().from(a)});if(h.length){var o=d("#jst-invitations"),p=f.compile(o.html()),q=p({crosses:h});d("#profile .gr-b .invitations").removeClass("hide").append(q)}})},o=function(a){if(!a)return;a=e.get("signin");if(!a)return;var b=a.user_id,c=new Date;return c.setDate(c.getDate()-3),c=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),j.request("crosses",{resources:{user_id:b},params:{updated_at:c}},function(a){var e=a.crosses,h=[],i=[];e.length&&g.each(e,function(a,d){a.updated&&a.updated.conversation&&h.push(j.request("conversation",{resources:{exfee_id:a.exfee.id},params:{date:c}},function(c){var d=c.conversation;if(d&&d.length){var e=d[d.length-1];if(e.by_identity.connected_user_id===b)return;e.__conversation_nums=d.length,a.updated.conversation.item=e}}))});if(h.length){var k=d.when;k=k.apply(null,h),k.then(function(a){var b=d("#jst-updates").html(),c=f.compile(b),g=c({updates:e});d("#profile .ios-app").before(g)})}})},p=function(a){var b=+d(".user-xstats > .attended").text(),c=e.get("newbie_guide");if(!c&&b<=3){var f=document.createElement("script");f.type="text/javascript",f.async=!0,f.src="/static2/js/newbieguide/0.0.1/newbieguide.min.js";var g=document.body;g.appendChild(f)}},q=function(a){var b=e.get("iosapp_dismiss");b||d(".ios-app").removeClass("hide")},r="app:signinothers";i.on(r,function(a){a.then([m,n,o,q,p])});var s="app:signinsuccess";i.on(s,function(a){l(a)}),i.on("app:addidentity",function(a){var b=d("#jst-identity-list"),c=f.compile(b.html()),e=c({identities:[a.identity]});d(".identity-list").append(e)});var t=d(document.body);d(function(){t.on("hover.profile",".identity-list > li",function(a){d(this).find(".xbtn-reverify, .xbtn-reauthorize").toggleClass("hide")}),t.on("click.profile","i.icon-minus-sign",function(a){var b=d(this).parent().data("identity-id"),c=e.get("signin"),f=c.token;return}),t.on("dblclick.profile",".user-name h3",function(a){var b=d.trim(d(this).html()),c=d('<input type="text" value="'+b+'" class="pull-left" />');c.data("oldValue",b),d(this).after(c).hide(),c.focusend(),d(".xbtn-changepassword").addClass("hide")}),t.on("focusout.profile keydown.profile",".user-name input",function(a){var b=a.type,c=a.keyCode;if(b==="focusout"||c===9||!a.shiftKey&&c===13){var f=d.trim(d(this).val()),g=d(this).data("oldValue");d(this).hide().prev().html(f).show(),d(this).remove(),!d(".settings-panel").data("hoverout")&&d(".xbtn-changepassword").removeClass("hide");if(!f||f===g)return;j.request("updateUser",{type:"POST",data:{name:f}},function(a){e.set("user",a.user),i.emit("app:changename",f)})}}),t.on("dblclick.profile",".identity-list li.editable .username > em",function(a){var b=d.trim(d(this).html()),c=d('<input type="text" value="'+b+'" class="username-input" />');c.data("oldValue",b),d(this).after(c).hide(),c.focusend()}),t.on("focusout.profile keydown.profile",".identity-list .username-input",function(a){var b=a.type,c=a.keyCode;if(b==="focusout"||c===9||!a.shiftKey&&c===13){var f=d.trim(d(this).val()),g=d(this).data("oldValue"),h=d(this).parent().parent().data("identity-id");d(this).hide().prev().html(f).show(),d(this).remove();if(!f||f===g)return;j.request("updateIdentity",{resources:{identity_id:h},type:"POST",data:{name:f}},function(a){var b=e.get("user");for(var c=0,d=b.identities.length;c<d;++c)if(b.identities[c].id===a.identity_id){b.identities[c]=identity;break}e.set("user",b)})}}),t.on("click.profile",".xbtn-accept",function(a){a.preventDefault(),a.stopPropagation();var b=e.get("lastIdentity"),c=d(this).parent(),f=c.data("id"),g=c.data("invitationid"),h=d('.gr-a [data-id="'+f+'"]'),i=c.data("exfeeid");j.request("rsvp",{resources:{exfee_id:i},type:"POST",data:{rsvp:'[{"identity_id":'+b.id+', "rsvp_status": "ACCEPTED", "by_identity_id": '+b.id+"}]",by_identity_id:b.id}},function(a){var b=h.find(">div :first-child"),d=+b.text();b.text(d+1);var f=h.find(">div :last-child"),g=f.text(),i=e.get("lastIdentity");f.text(g+(g?", ":"")+i.name);var j;!c.parent().prev().length&&!c.parent().next().length&&(j=c.parents(".invitations")),c.parent().remove(),j&&j.remove()})}),t.on("click.profile.identity",".xbtn-addidentity",function(a){}),t.on("click.profile","#profile div.cross-type",function(a){a.preventDefault(),d(this).next().toggleClass("hide").next().toggleClass("hide"),d(this).find("span.arrow").toggleClass("lt rb")}),t.on("hover.profile",".settings-panel",function(a){var b=a.type;d(this).data("hoverout",b==="mouseleave"),b==="mouseenter"?d(this).find(".xbtn-changepassword").removeClass("hide"):d(this).find(".xbtn-changepassword").addClass("hide")}),t.on("click.profile",".more > a",function(a){a.preventDefault();var b=d(this),c=b.parent(),h=c.data("cate"),i=e.get("signin"),k=i.token,l=i.user_id,m=c.prev().find(" .cross-box").length,n=h;j.request("crosslist",{resources:{user_id:l},data:{more_category:n,more_position:m}},function(a){if(a.crosses.length){var d="{{#crosses}}{{> jst-cross-box}}{{/crosses}}",e=f.compile(d);c.prev().append(e(a));var i=g.filter(a.more,function(a){if(a===h)return!0});i.length||b.remove()}})})}),t.on("click.profile.iosapp",".ios-app > .exfe-dismiss",function(a){a.preventDefault(),e.set("iosapp_dismiss",!0),t.off("click.profile.iosapp"),d(this).parent().fadeOut()}),t.on("click.profile.uploader",".user-avatar",function(b){var c=a("uploader")();c.render()})});