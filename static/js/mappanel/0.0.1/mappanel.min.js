define("mappanel",function(e,t,n){var r=e("jquery"),i=e("rex"),s=e("config"),o=e("panel"),u=/[\r\n]+/g,a="\r",f=window.navigator.geolocation,l=o.extend({options:{template:'<div class="panel map-panel" tabindex="-1" data-widget="panel" id="map-panel"><div class="panel-body"><div class="map-container"><div class="map-box" id="gmap"></div><div class="map-place"><div class="place-editor"><i class="pointer icon24-enter place-submit"></i><textarea class="normal" name="place-text" id="place-text" placeholder="Enter place here."></textarea></div><div class="map-places hide"><ul class="unstyled places-list" tabindex="-1"></ul></div></div></div></div></div>',parentNode:null,srcNode:null,place:null},isGeoSupported:!!f,getGeoPosition:function(e){this.emit("set-geo",e)},getGeoPositionError:function(e){this.emit("set-geo",{coords:s.location})},getGeo:function(e){this.position=e,this.xmap.initMap()},init:function(){var e=this.options;this.render(),this.originPlace=e.place,this.place=r.extend({},e.place),delete e.place,this.placeInput=new c(this,"#place-text"),this.placesList=new h(this,".places-list"),this.xmap=new p(this,"#gmap"),this.listen()},listen:function(){var e=this,t=this.place;this.on("update-place",this.update),this.on("change-place",this.change),this.on("set-geo",this.getGeo),this.on("search-completed",this.searchCompleted),this.on("placeinput-tab",this.placeInputTab),this.on("placeslist-tab",this.placesListTab),this.element.on("click.mappanel",".place-submit",function(e){r("body").click()}),this.element.on("keydown.mappanel",r.proxy(this.keydown,this))},save:function(){this.$(".place-submit").trigger("click.mappanel")},keydown:function(e){var t=this;27===e.keyCode?t.revert():e.ctrlKey&&13===e.keyCode&&(t.emit("update-place",t.place),t.save())},searchCompleted:function(e){this.placesList.update(e)},placeInputTab:function(){var e=this.placesList,t=this.placeInput,n=e.status;if(n)var r=setTimeout(function(){t.$element.blur(),e.$element.focus(),clearTimeout(r)},0)},placesListTab:function(){var e=this,t=setTimeout(function(){e.placeInput.$element.focusend(),clearTimeout(t)},0)},change:function(e,t){t=!!t,this.place.title=e.title,this.place.description=e.description,this.place.lat=e.lat||"",this.place.lng=e.lng||"",this.emit("update-place",this.place),t?this.xmap.textSearch(e.title):(this.placeInput.$element.val(v(e.title,e.description)),this.xmap.updateCenter(e))},revert:function(e){this.emit("update-place",this.originPlace)},showPlace:function(){var e=this.place,t=e.title,n=e.description,i=!t&&!n,s=e.lat&&e.lng,o=this.$("#place-text");o.val(v(t,n)),i&&o.focusend(),s?this.getGeoPosition({coords:{latitude:e.lat,longitude:e.lng}}):!s&&this.isGeoSupported?f.getCurrentPosition(r.proxy(this.getGeoPosition,this),r.proxy(this.getGeoPositionError,this)):this.getGeoPositionError()},showBefore:function(){this.element.attr("editarea","date-panel")},showAfter:function(){var e=this.srcNode;if(e){var t=e.offset(),n=this.element.outerWidth();this.element.css({left:t.left-n-15,top:t.top})}this.showPlace()},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),c=function(e,t){this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.listen()};c.prototype={listen:function(){var e=this.$container,t=this.selector;e.on("blur.mappanel",t,r.proxy(this.blur,this)).on("keypress.mappanel",t,r.proxy(this.keypress,this)).on("keyup.mappanel",t,r.proxy(this.keyup,this)).on("keydown.mappanel",t,r.proxy(this.keydown,this)).on("focus.mappanel",t,r.proxy(this.focus,this))},lookup:function(){var e=r.trim(this.$element.val()),t=d(e);this.component.emit("change-place",t,!0)},click:function(e){},blur:function(e){this.$element.addClass("normal")},focus:function(e){this.$element.removeClass("normal")},mouseenter:function(e){},keyup:function(e){switch(e.keyCode){case 40:case 38:case 16:case 17:case 18:case 9:case 13:case 27:break;default:this.lookup()}e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this.component,n=e.keyCode;switch(n){case 9:t.emit("placeinput-tab"),e.preventDefault()}},keypress:function(e){if(this.suppressKeyPressRepeat)return;this.keyHandler(e)},keydown:function(e){this.suppressKeyPressRepeat=!!~i.indexOf([9],e.keyCode),this.keyHandler(e)}};var h=function(e,t){this.template='<li class="place-item" data-latitude="{{lat}}" data-longitude="{{lng}}"><div class="rank">{{i}}</div><address><div class="title">{{title}}</div><div class="description">{{address}}</div></address></li>',this.component=e,this.$container=this.component.element,this.selector=t,this.$element=this.component.$(t),this.$items=null,this.len=0,this.curr=0,this.viewportRows=12,this.viewportIndex=0,this.scrollIndexs=[0,11],this.scrollNum=1,this.itemPX=36,this.listen()};h.prototype={listen:function(){var e=this.$container,t=this.selector;e.on("blur.mappanel",t,r.proxy(this.blur,this)).on("keypress.mappanel",t,r.proxy(this.keypress,this)).on("keyup.mappanel",t,r.proxy(this.keyup,this)).on("keydown.mappanel",t,r.proxy(this.keydown,this)).on("focus.mappanel",t,r.proxy(this.focus,this)).on("click.mappanel",t+" > li",r.proxy(this.click,this))},update:function(e){this.status=!!e.length,this.$element.empty(),this.curr=0;var t="",n,r=this.template;this.status&&(i.each(e,function(e,i){n=r,t+=n.replace("{{i}}",i+1).replace("{{title}}",e.name).replace("{{address}}",e.formatted_address).replace("{{lat}}",e.geometry.location.Ya).replace("{{lng}}",e.geometry.location.Za)}),this.$element.html(t)),this.$element.parent().toggleClass("hide",!this.status)},blur:function(){this.removeCurrStyle("hover")},focus:function(e){this.$items=this.$element.find(" > li"),this.len=this.$items.length,this.addCurrStyle("hover")},addCurrStyle:function(e){this.$items.eq(this.curr).addClass(e)},removeCurrStyle:function(e){this.$items.eq(this.curr).removeClass(e)},setPlace:function(){var e=this.$items.eq(this.curr),t={title:e.find("div.title").text(),description:e.find("div.description").text(),lat:String(e.data("latitude")),lng:String(e.data("longitude"))};this.component.emit("change-place",t,!1)},scroll:function(e){var t=this.scrollIndexs,n=this.viewportRows,r=this.len,i=this.scrollNum,s=this.itemPX,o=this.curr,u=this.viewportIndex+=e;if(u===t[1]+1&&o===r-1)this.$element.scrollTop(0),this.viewportIndex=0;else if(u===t[0]-1&&o===0)this.$element.scrollTop((r-n)*s),this.viewportIndex=11;else if(u===t[0]-1&&o>t[0]||o<r-(n-t[1])&&u===t[1]+1){var a=this.$element.scrollTop();this.$element.scrollTop(a+=e*s*i),this.viewportIndex=t[(e+1)/2]}},prev:function(){this.removeCurrStyle("hover"),0===this.curr&&(this.curr=this.len),this.curr--,this.addCurrStyle("hover")},next:function(){this.removeCurrStyle("hover"),this.curr++,this.len===this.curr&&(this.curr=0),this.addCurrStyle("hover")},keyup:function(e){e.stopPropagation(),e.preventDefault()},keyHandler:function(e){var t=this,n=t.component,r=e.keyCode;switch(r){case 9:e.preventDefault(),n.emit("placeslist-tab");break;case 38:t.scroll(-1),t.prev(),e.preventDefault();break;case 40:t.scroll(1),t.next(),e.preventDefault();break;case 13:e.preventDefault(),t.setPlace(),t.component.save();break;case 32:e.preventDefault(),t.setPlace()}},keypress:function(e){if(this.suppressKeyPressRepeat)return;this.keyHandler(e)},keydown:function(e){this.suppressKeyPressRepeat=!!~i.indexOf([9,38,40,32,13],e.keyCode),this.keyHandler(e)},click:function(e){this.curr=r(e.currentTarget).index(),this.setPlace(),this.component.save()}};var p=function(e,t){this.component=e,this.selector=t,this.$element=this.component.$(t),this.cbid=0};p.prototype={initMap:function(){this.position=this.component.position;var e=this.position.coords;this._center=new google.maps.LatLng(e.latitude,e.longitude),this._request={radius:5e4,location:this._center},this._map=new google.maps.Map(this.$element[0],{zoom:16,center:this._center,MapTypeId:google.maps.MapTypeId.ROADMAP,zoomControl:!1,mapTypeControl:!1}),this._marker=new google.maps.Marker({position:this._center,map:this._map,title:e.title||""}),this._service=new google.maps.places.PlacesService(this._map)},updateCenter:function(e){this._center=new google.maps.LatLng(e.lat,e.lng),this._map.setCenter(this._center),this._marker.setPosition(this._center)},textSearch:function(e){var t=this,n=t.component,r=t._service,i=t._request,s;e&&e!==i.query?(i.query=e,s=function(e,r){s.id===t.cbid&&r===google.maps.places.PlacesServiceStatus.OK&&(t.cbid=0,n.emit("search-completed",e))},s.id=++t.cbid,r.textSearch(i,s)):n.emit("search-completed",[])}};var d=function(e){e||(e="");var t=e.split(u),n=t.length?t.shift():"",r=t.join(a);return{title:n,description:r}},v=function(e,t){return e+(t?a+t.replace(u,a):"")};return l});