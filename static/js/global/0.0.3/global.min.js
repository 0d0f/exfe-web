define(function(e,t,n){function c(e){return e.stopPropagation(),e.preventDefault(),!1}function p(e){r(h).removeClass("open")}function v(e){var t=r(this),n=t.data("timer"),i=t.data("clicked"),s=t.find("div.user-panel").addClass("show"),o=-s.outerHeight();e.preventDefault();if(e.type==="mouseleave"&&!i)return n=setTimeout(function(){d=!1,s.stop().animate({top:o},200,function(){t.prev().addClass("hide"),t.parent().removeClass("user")}),clearTimeout(n),t.data("timer",n=null)},500),t.data("timer",n),!1;if(i){t.data("clicked",!1);return}if(n)return clearTimeout(n),t.data("timer",n=null),!1;d||(s.css("top",o),t.find(".user-panel").addClass("show"),d=!0),t.prev().removeClass("hide"),t.parent().addClass("user"),s.stop().animate({top:56},100)}var r=e("jquery"),i=e("bus"),s=e("store"),o=e("dialog"),u=e("xdialog").dialogs,a=e("xdialog").Identification,f=e("xidentity"),l=r(document.body);l.on("drop",c).on("dragover",c);var h='[data-toggle="dropdown"]';l.on("click.dropdown.data-api",p);var d=!1;l.on("mouseenter.dropdown mouseleave.dropdown","#app-user-menu .dropdown-wrapper",v),l.on("click.usermenu",'#app-user-menu .dropdown-wrapper a[href^="/#"]',function(e){var t=r("#app-user-menu .dropdown-wrapper"),n=t.find("div.user-panel").addClass("show"),i=-n.outerHeight();n.css("top",i),t.prev().addClass("hide").end().parent().removeClass("user"),t.data("clicked",!0)}),l.on("click.usermenu","#app-signout",function(e){i.emit("xapp:cross:end"),r(".navbar .dropdown-wrapper").find(".user-panel").remove(),r("#app-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),s.remove("user"),s.remove("authorization"),window.location.href="/"}),l.on("click.data-link dblclick.data-link","[data-link]",function(e){var t=r(this).data("link"),n=r(this).data("event-ignore");if(e.type!==n){var i=s.get("authorization"),o=i&&i.token,u=r("#app-browsing-identity"),a=u.data("read-only"),f=u.data("settings"),l=r("#app-read-only"),c=u.data("token-type"),h=u.data("token"),p=u.data("action");if(u.size()&&a&&t==="nota")return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),l.size()||r("#app-main").append(l=r('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",f.browsing)),l.trigger("click"),!1;if(u.size())if(t===""||t==="nota"&&c==="user")return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),u.trigger("click"),!1}});var m=2;i.on("app:cross:edited",function(e){if(0===m)return;m--;var t=r("#app-browsing-identity"),n=t.data("settings"),i=r("#app-read-only"),o=t.data("action");e?e&&e.error==="no_permission"&&(i.size()||r("#app-main").append(i=r('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",n&&n.browsing||s.get("user"))),i.trigger("click")):o==="setup"&&r('[data-user-action="'+o+'"]').trigger("click")}),l.on("click.dialog.data-api",'[data-widget="dialog"]',function(e){var t=r(this),n=t.data("dialog"),i,s=t.data("dialog-type"),f=t.data("dialog-tab"),l=t.data("dialog-from"),c=t.data("dialog-settings"),h=t.data("source");e.preventDefault(),n||s&&(i=u[s],c&&(i=r.extend(!0,{},i,c)),n=new(s==="identification"?a:o)(i),n.options.srcNode=t,l&&(n.dialog_from=l),n.render(),t.data("dialog",n)),f&&n.switchTab(f),n.show(e)});var g=s.get("identities");!g&&(g=[]),l.on("focus.typeahead.data-api",'[data-typeahead-type="identity"]',function(e){var t=r(this);if(t.data("typeahead"))return;e.preventDefault(),t.data("typeahead",new f({options:{source:g,useCache:!0,target:t,onNothing:function(){this.target.parent().removeClass("identity-avatar"),i.emit("widget-dialog-identification-nothing")},"onAutocomplete:finish":function(e){var t;e&&(t=e.identity)?this.target.prev().attr("src",t.avatar_filename).parent().addClass("identity-avatar"):this.target.parent().removeClass("identity-avatar"),i.emit("widget-dialog-identification-auto",e)}}}))})});