define(function(e,t,n){function u(e){return e.stopPropagation(),e.preventDefault(),!1}function f(e){r(a).removeClass("open")}function c(e){var t=r(this),n=t.data("timer"),i=t.data("clicked"),s=t.find("div.user-panel").addClass("show"),o=-s.outerHeight();e.preventDefault();if(e.type==="mouseleave"&&!i)return n=setTimeout(function(){s.stop().animate({top:o},200,function(){t.prev().addClass("hide"),t.parent().removeClass("user")}),clearTimeout(n),t.data("timer",n=null)},500),t.data("timer",n),!1;if(i){t.data("clicked",!1);return}if(n)return clearTimeout(n),t.data("timer",n=null),!1;l||(s.css("top",o),t.find(".user-panel").addClass("show")),t.prev().removeClass("hide"),t.parent().addClass("user"),s.stop().animate({top:56},100)}var r=e("jquery"),i=e("bus"),s=e("store"),o=r(document.body);o.on("drop",u).on("dragover",u);var a='[data-toggle="dropdown"]';o.on("click.dropdown.data-api",f);var l=!1;o.on("mouseenter.dropdown mouseleave.dropdown","#app-user-menu .dropdown-wrapper",c),o.on("click.usermenu",'#app-user-menu .dropdown-wrapper a[href^="/#"]',function(e){var t=r("#app-user-menu .dropdown-wrapper"),n=t.find("div.user-panel").addClass("show"),i=-n.outerHeight();n.css("top",i),t.prev().addClass("hide").end().parent().removeClass("user"),t.data("clicked",!0)}),o.on("click.usermenu","#app-signout",function(e){i.emit("xapp:cross:end"),r(".navbar .dropdown-wrapper").find(".user-panel").remove(),r("#app-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),s.remove("authorization"),window.location.href="/"}),o.on("click.data-link dblclick.data-link","[data-link]",function(e){var t=r(this).data("link"),n=s.get("authorization"),i=n&&n.token,o=r("#app-browsing-identity"),u=o.data("read-only"),a=o.data("settings"),f=r("#app-read-only"),l=o.data("token-type"),c=o.data("token"),h=o.data("action");if(o.size()&&u&&t==="nota")return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),f.size()||r("#app-main").append(f=r('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",a.browsing)),f.trigger("click"),!1;if(o.size()){if(t!=="nota"||l!=="user")if(t==="")return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),o.trigger("click"),!1}else if(!i)return e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),f.size()||r("#app-main").append(f=r('<div id="app-read-only" data-widget="dialog" data-dialog-type="read_only"></div>').data("settings",s.get("user"))),f.trigger("click"),!1});var h=2;i.on("app:cross:edited",function(){if(0===h--)return;var e=r("#app-browsing-identity"),t=e.data("action");r('[data-user-action="'+t+'"]').trigger("click")})});