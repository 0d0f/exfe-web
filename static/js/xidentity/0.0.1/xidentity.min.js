define(function(e){var t=e("jquery"),n=e("util"),r=e("bus"),i=e("api"),s=t(document.body),o=e("store"),u=e("typeahead"),a=e("handlebars"),f=u.extend({itemRender:function(e){var n=a.compile(this.options.viewData.item);return t(n(e))},matcher:function(e){var t=e.external_id;return~t.toLowerCase().indexOf(this.query.toLowerCase())},focus:function(){var e=n.trim(this.target.val());e||this.emit("nothing",e)},options:{url:null,useCache:!1,delay:200,extraParams:{},autoClearResults:!1,dataType:"JSON",minLength:1,viewData:{item:'<li data-value="{{external_id}}"><i class="pull-right icon16-identity-{{provider}}"></i><span>{{external_id}}</span></li>'},onSelect:function(e){this.emit("search",e)},onClearCache:function(){delete this.cache},onSearch:function(e){var r=this,s=r.options,o,u;r.cache||(r.cache={}),r.source&&r.source.length&&(u=t.grep(r.source,function(e){return r.matcher(e)}),u.length?r.render(u.slice(0)).show():r.isShown?r.hide():r),r.timer&&(clearTimeout(r.timer),r.target.next().addClass("hide"));if((o=n.parseId(e)).provider){var a={provider:o.provider,external_username:o.external_identity};r.timer=setTimeout(function(){clearTimeout(r.timer),l(e)},s.delay);function f(e){r.ajaxDefer&&r.ajaxDefer.readyState<4&&r.ajaxDefer.abort(),r.emit("autocomplete:beforesend"),s.useCache&&r.cache[e]?r.emit("autocomplete:finish",r.cache[e]):r.ajaxDefer=i.request("getRegistrationFlag",{data:a,beforesend:function(e){r.target.next().removeClass("hide")},complete:function(e){r.target.next().addClass("hide")}},function(t){e===r.target.val()&&(s.useCache&&(r.cache[e]=t),r.emit("autocomplete:finish",t))})}function l(e){e.length>=r.options.minLength?(f(e),r.searchValue=e):r.emit("autocomplete:clear")}}else r.emit("autocomplete:finish",null)}}});t(function(){var e=o.get("user"),n;e&&(n=e.identities),s.on("focus.typeahead.data-api",'[data-typeahead-type="identity"]',function(e){var i=t(this);if(i.data("typeahead"))return;e.preventDefault(),i.data("typeahead",new f({options:{source:n,useCache:!0,target:i,onNothing:function(){this.target.parent().removeClass("identity-avatar"),r.emit("widget-dialog-identification-nothing")},"onAutocomplete:finish":function(e){var t;e&&(t=e.identity)?(t.avatar_filename==="default.png"&&(t.avatar_filename="/img/default_portraituserface_20.png"),this.target.prev().attr("src",t.avatar_filename).parent().addClass("identity-avatar")):this.target.parent().removeClass("identity-avatar"),r.emit("widget-dialog-identification-auto",e)}}}))})})});