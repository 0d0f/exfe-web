define("uploader",[],function(e,t,n){function l(e,t){if(window.URL&&window.URL.createObjectURL)e.src=window.URL.createObjectURL(t);else if(window.webkitURL.createObjectURL)e.src=window.webkitURL.createObjectURL(t);else{var n=new FileReader;n.onload=function(){e.src=this.result},n.readAsDataURL(t)}return e}function c(e,t){var n;e.split(",")[0].indexOf("base64")>=0?n=atob(e.split(",")[1]):n=unescape(e.split(",")[1]);var r=e.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(n.length),s=new Uint8Array(i);for(var o=0;o<n.length;o++)s[o]=n.charCodeAt(o);var u=window.WebKitBlobBuilder||window.MozBlobBuilder||window.BlobBuilder,a;if(u){var f=new u;f.append(i),a=f.getBlob(r)}else a=new Blob([i],{type:r});return a}function h(e,t){if(e.mozGetAsFile)return e.mozGetAsFile(t,"image/png");var n=e.toDataURL("image/png"),r=c(n);return r}function p(e,t){var n=h(e,t);return n}function d(e,t){this.x=e||0,this.y=t||0}function v(e){this.originalImage=e,this.width=e.width,this.height=e.height,this.regX=e.width/2,this.regY=e.height/2,this.x=0,this.y=0,this.alpha=1,this.visible=!0,this.rotation=0,this.scaleX=1,this.scaleY=1}function m(e){this.id=++m.UID,this.canvas=e instanceof HTMLCanvasElement?e:document.getElementById(e)}function g(e,t,n,r){var i=[];i[0]=Math.sqrt(Math.pow(e,2)+Math.pow(t,2));if(e<0||t<0)i[0]*=-1;return i[1]=i[0]/Math.sqrt(Math.pow(n,2)+Math.pow(r,2)),i}function y(){r(document).off("mousemove.photozone").off("mouseup.photozone")}function b(e){r(document).on("mousemove.photozone",function(t){t.preventDefault();var n=e;if(n&&n.dragging){var r=t.pageX-n.offset[0],i=t.pageY-n.offset[1],s=n.bitmap;switch(n.ri){case 0:s.x+=r,s.y+=i;break;case 1:s.x+=i,s.y-=r;break;case 2:s.x-=r,s.y-=i;break;case 3:s.x-=i,s.y+=r}return n.offset[0]=t.pageX,n.offset[1]=t.pageY,n.stage.update(),n.bitmap80.updateImage(n.stage.canvas),n.stage80.update(),!1}if(n&&n.resizing){var r=t.pageX-n.aoffset[0],i=t.pageY-n.aoffset[1],o,u,a,f,l=n.stage.canvas.width,c=n.stage.canvas.height,s=n.bitmap,h=s.originalImage,p=n.psx,d=n.psy,v=n.ri,m=n.aoffset,g=n.sss,y=n._canvasOffset;function b(e){v===0?(s.scaleY=d+e,s.scaleY<0&&(s.scaleY=g/h.height),s.y-=s.scaleY*h.height-s.height):v===1?(s.scaleX=p+e,s.scaleX<0&&(s.scaleX=g/h.width),s.x-=s.scaleX*h.width-s.width):v===2?(s.scaleY=d+e,s.scaleY<0&&(s.scaleY=g/h.height)):(s.scaleX=p+e,s.scaleX<0&&(s.scaleX=g/h.width))}function w(e){v===0?(s.scaleX=p+e,s.scaleX<0&&(s.scaleX=g/h.width),s.x-=s.scaleX*h.width-s.width):v===1?(s.scaleY=d+e,s.scaleY<0&&(s.scaleY=g/h.height)):v===2?(s.scaleX=p+e,s.scaleX<0&&(s.scaleX=g/h.width)):(s.scaleY=d+e,s.scaleY<0&&(s.scaleY=g/h.height),s.y-=s.scaleY*h.height-s.height)}function E(e){v===0?(s.scaleX=p+e,s.scaleX<0&&(s.scaleX=g/h.width)):v===1?(s.scaleY=d+e,s.scaleY<0&&(s.scaleY=g/h.height),s.y-=s.scaleY*h.height-s.height):v===2?(s.scaleX=p+e,s.scaleX<0&&(s.scaleX=g/h.width),s.x-=s.scaleX*h.width-s.width):(s.scaleY=d+e,s.scaleY<0&&(s.scaleY=g/h.height))}function S(e){v===0?(s.scaleY=d+e,s.scaleY<0&&(s.scaleY=g/h.height)):v===1?(s.scaleX=p+e,s.scaleY<0&&(s.scaleY=g/h.height)):v===2?(s.scaleY=d+e,s.scaleY<0&&(s.scaleY=g/h.height),s.y-=s.scaleY*h.height-s.height):(s.scaleX=p+e,s.scaleX<0&&(s.scaleX=g/h.width),s.x-=s.scaleX*h.width-s.width)}if(r||i){var x;switch(n.anchor){case 0:var T=Math.sqrt(Math.pow(t.pageX-l-y.left,2)+Math.pow(t.pageY-y.top-c,2)),N=Math.sqrt(Math.pow(l,2)+Math.pow(c,2));T-=n.dr,b(T/N*g),w(T/N*g);break;case 1:u=m[1]-t.pageY,f=u/c,b(f*g);break;case 2:var T=Math.sqrt(Math.pow(t.pageX-y.left,2)+Math.pow(t.pageY-y.top-c,2)),N=Math.sqrt(Math.pow(l,2)+Math.pow(c,2));T-=n.dr,b(T/N*g),w(T/N*g);break;case 3:o=m[0]-t.pageX,a=o/l,w(a*g);break;case 4:o=t.pageX-m[0],a=o/l,E(a*g);break;case 5:var T=Math.sqrt(Math.pow(t.pageX-l-y.left,2)+Math.pow(t.pageY-y.top,2)),N=Math.sqrt(Math.pow(l,2)+Math.pow(c,2));T-=n.dr,w(T/N*g),S(T/N*g);break;case 6:u=t.pageY-m[1],f=u/c,S(f*g);break;case 7:var T=Math.sqrt(Math.pow(t.pageX-y.left,2)+Math.pow(t.pageY-y.top,2)),N=Math.sqrt(Math.pow(l,2)+Math.pow(c,2));T-=n.dr,E(T/N*g),S(T/N*g)}n.stage.update(),n.bitmap80.updateImage(n.stage.canvas),n.stage80.update()}return!1}}).on("mouseup.photozone",function(t){e&&(e.resizing=!1,e.dragging=!1,e.anchor=null,e.bitmap&&(e.psx=e.bitmap.scaleX,e.psy=e.bitmap.scaleY))})}var r=e("jquery"),i=e("api"),s=e("config"),o=e("dialog"),u=e("filehtml5"),a=o.extend({_fileInputField:null,_buttonBinding:null,queue:null,init:function(){this._fileInputField=null,this.queue=null,this._buttonBinding=null,this._fileList=[]},sync:function(){var e=this.$(".dropbox");this._fileInputField=r(a.HTML5FILEFIELD_TEMPLATE),e.after(this._fileInputField),this._bindDropArea(),this._fileInputField.on("change",r.proxy(this._updateFileList,this))},_bindSelectFile:function(e){var t=this._fileInputField[0];t.click&&t.click()},_bindDropArea:function(e){var t=e||{prevVal:null};t.prevVal!==null&&(t.prevVal.detach("drop",this._ddEventhandler),t.prevVal.detach("dragenter",this._ddEventhandler),t.prevVal.detach("dragover",this._ddEventhandler),t.prevVal.detach("dragleave",this._ddEventhandler));var n=r.proxy(this._ddEventhandler,this);this.element.on("drop",".modal-main",n),this.element.on("dragenter",".modal-main",n),this.element.on("dragover",".modal-main",n),this.element.on("dragleave",".modal-main",n)},_ddEventhandler:function(e){e.stopPropagation(),e.preventDefault();switch(e.type){case"dragenter":this.emit("dragenter",e);break;case"dragover":this.emit("dragover",e);break;case"dragleave":this.emit("dragleave",e);break;case"drop":var t=this.$(".modal-main")[0];if(!r.contains(t,e.target)&&e.target!==t)return!1;this._fileselect(e.originalEvent.dataTransfer.files),this.emit("drop",e)}return!1},_fileselect:function(e){var t=e,n=[],r,i=this.fileFilterFunction,s=0,o=t.length;for(;s<o;s++)n.push(new u(t[s]));this.options.limit&&(n=n.slice(-this.options.limit)),n.length>0&&this.emit("fileselect",{fileList:n})},_updateFileList:function(e){this._fileselect(e.target.files)},fileFilterFunction:function(e){var t=!1;return/^image\/(png|gif|bmp|jpg|jpeg)$/.test(e._type)&&(t=!0),t}},{HTML5FILEFIELD_TEMPLATE:'<input type="file" style="visibility:hidden; width:0px; height:0px;" />'}),f={errors:{server:"Failed to open, please try again.",format:"File format not supported.",size:"File is too large."},checkFile:function(e){return this.checkFileFormat(e)?!1:this.checkFileSize(e)?!1:!0},checkFileSize:function(e){var t=3145728,n=!1;return this.emit("toggleError",n=e._size>t,"size"),n},checkFileFormat:function(e){var t=!this.fileFilterFunction(e);return this.emit("toggleError",t,"format"),t},sss:1,aoffset:[0,0],psx:1,psy:1,anchor:null,resizing:!1,dragging:!1,SCALE:80/240,ri:0,R:[0,0],filehtml5Bind:function(){var e=this;this.filehtml5._xhrHeaders={Accept:"application/json, text/javascript, */*; q=0.01"},this.filehtml5.on("uploadcomplete",function(t){var n=!0;e.$(".loading").addClass("hide"),data=JSON.parse(t.data),data&&data.meta.code===200&&(n=!1,data.response.type==="user"?r(".user-avatar .avatar, .user-panel .avatar").find("img").attr("src",data.response.avatars["80_80"]):r('.identity-list li[data-identity-id="'+data.response.identity_id+'"] .avatar').find("img").attr("src",data.response.avatars["80_80"])),e.emit("toggleError",n,"server"),e.hide()}),this.filehtml5.on("uploadstart",function(t){e.$(".loading").removeClass("hide")})},options:{limit:1,onShowBefore:function(){b(this)},onShowAfter:function(e){this._data=e,this._canvasOffset=this.$("#avatar240").offset();if(e.original){var t=document.createElement("input");t.type="file",this.filehtml5=new u(t.files),this.filehtml5Bind(),this.$(".overlay").addClass("hide"),this.$(".resizeable").removeClass("hide"),this.$(".upload-done").show(),this.$(".upload-clear").hide();var n=this;n.ri=0,n.R=[0,0];var r=document.getElementById("avatar240"),i=document.getElementById("avatar80"),s=n.r,o=new m(r),a,f=new m(i),l,c=document.createElement("img");c.onload=function(){var e=Math.min(c.width,c.height);n.sss=1,e>240&&(n.sss=240/e),a=new v(c),n.psx=a.scaleX=n.sss,n.psy=a.scaleY=n.sss,a.setPosition(r.width/2-(a.regX*=a.scaleX),r.height/2-(a.regY*=a.scaleY)),a.rotation=n.ri,a.updateContext=function(e){e.translate(r.width*n.R[0],r.height*n.R[1]),e.rotate(this.rotation*m.DEG_TO_RAD)},o.addChild(a),o.update(),n.bitmap=a,n.stage=o,l=new v(r),l.updateImage=function(e){l.originalImage=e},l.updateContext=function(e){e.scale(n.SCALE,n.SCALE)},f.addChild(l),f.update(),n.bitmap80=l,n.stage80=f},c.crossOrigin="anonymous",c.src=e.original}},onHideAfter:function(){var e=this.element;this.offSrcNode(),this.destory(),e.remove(),y()},onToggleError:function(e,t){e?this.$(".xalert-error").html(this.errors[t]).removeClass("hide"):this.$(".xalert-error").addClass("hide")},onDrop:function(e){},onFileselect:function(e){var t=e.fileList,n;if(t.length){n=this.filehtml5=t[0];if(!this.checkFile(n))return!1;this.filehtml5Bind(),this.$(".overlay").addClass("hide"),this.$(".resizeable").removeClass("hide"),this.$(".upload-done").show(),this.$(".upload-clear").hide();var r=this;r.ri=0,r.R=[0,0];var i=document.getElementById("avatar240"),s=document.getElementById("avatar80"),o=r.r,u=new m(i),a,f=new m(s),c,h=document.createElement("img");h.onload=function(){var e=h,t=Math.min(h.width,h.height);r.sss=1,t>240&&(r.sss=240/t);if(r.filehtml5._type==="image/gif"){var n=document.createElement("canvas"),s=n.getContext("2d");n.width=e.width,n.height=e.height,s.drawImage(e,0,0,n.width,n.height),e=n}a=new v(e),r.psx=a.scaleX=r.sss,r.psy=a.scaleY=r.sss,a.setPosition(i.width/2-(a.regX*=a.scaleX),i.height/2-(a.regY*=a.scaleY)),a.rotation=r.ri,a.updateContext=function(e){e.translate(i.width*r.R[0],i.height*r.R[1]),e.rotate(this.rotation*m.DEG_TO_RAD)},u.addChild(a),u.update(),r.bitmap=a,r.stage=u,c=new v(i),c.updateImage=function(e){c.originalImage=e},c.updateContext=function(e){e.scale(r.SCALE,r.SCALE)},f.addChild(c),f.update(),r.bitmap80=c,r.stage80=f},h.crossOrigin="anonymous",l(h,n._file)}},backdrop:!1,events:{"click .dropbox":function(e){e.preventDefault(),this._fileInputField[0].value=null,this._bindSelectFile()},"mousedown #avatar240":function(e){return e.preventDefault(),this.dragging=!0,this.offset=[e.pageX,e.pageY],!1},"click .upload":function(e){e.preventDefault(),this.$(".overlay").removeClass("hide"),this.$(".resizeable").addClass("hide"),this.$(".upload, .rotate, .upload-done").hide(),this.$(".back, .upload-clear").show()},"click .rotate":function(e){return this.ri++,this.ri===1?this.R=[1,0]:this.ri===2?this.R=[1,1]:this.ri===3?this.R=[0,1]:(this.ri=0,this.R=[0,0]),this.bitmap.rotation=90*this.ri,this.stage.update(),this.bitmap80.updateImage(this.stage.canvas),this.stage80.update(),!1},"hover .avatar240":function(e){e.type==="mouseenter"?this.$(".upload, .rotate").show():this.$(".upload, .rotate").hide()},"hover .overlay":function(e){var t=e.type==="mouseenter";r(e.currentTarget).hasClass("dropbox")?this.$(".back")[t?"show":"hide"]():this.$(".zoom")[t?"show":"hide"]()},"click .back":function(e){return this.$(".overlay").addClass("hide"),this.$(".resizeable").removeClass("hide"),this.$(".upload, .rotate, .upload-done").show(),this.$(".back, .upload-clear").hide(),!1},"click /*#avatar240,*/.smallphoto":function(e){e.preventDefault();var t="";if(!this.bitmap)return!1;if(r.browser.safari&&!/chrome/.test(navigator.userAgent.toLowerCase())){var n=document.createElement("canvas"),i=n.getContext("2d");n.width=this.bitmap.originalImage.width,n.height=this.bitmap.originalImage.height,i.drawImage(this.bitmap.originalImage,0,0,n.width,n.height),t=n.toDataURL("image/png")}else t=this.bitmap.originalImage.src;return window.open(t)},"mousedown .resizeable":function(e){e.preventDefault();var t=r(e.target),n=this.anchor=t.data("anchor");this.resizing=!0,this.aoffset=[e.pageX,e.pageY];var i=this._canvasOffset;return n===7?this.dr=Math.sqrt(Math.pow(e.pageX-i.left,2)+Math.pow(e.pageY-i.top,2)):n===5?this.dr=Math.sqrt(Math.pow(e.pageX-i.left-240,2)+Math.pow(e.pageY-i.top,2)):n===0?this.dr=Math.sqrt(Math.pow(e.pageX-i.left-240,2)+Math.pow(e.pageY-i.top-240,2)):n===2&&(this.dr=Math.sqrt(Math.pow(e.pageX-i.left,2)+Math.pow(e.pageY-i.top-240,2))),!1},"click .upload-clear":function(e){return this.$(".help-portrait").removeClass("hide"),this.$(".xbtn-yes, .xbtn-no").removeClass("hide"),!1},"click .xbtn-no":function(e){return this.$(".help-portrait").addClass("hide"),this.$(".xbtn-yes, .xbtn-no").addClass("hide"),!1},"click .xbtn-yes":function(e){var t={};return this._data.identity_id&&(t.identity_id=this._data.identity_id),this.filehtml5.startUpload(s.api_url+"/avatar/update?token="+i.getToken(),t),!1},"click .upload-done":function(e){var t=this,n=this.bitmap,r=n.originalImage,o=this.stage,u=this.stage80,a=240/this.sss,f=n.x/this.sss,l=n.y/this.sss,c=document.createElement("canvas");c.width=c.height=a;var h=new m(c),d=new v(r);d.setPosition(f,l),d.rotation=90*this.ri,d.scaleX=n.scaleX/this.sss,d.scaleY=n.scaleY/this.sss,d.updateContext=function(e){e.translate(c.width*t.R[0],c.height*t.R[1]),e.rotate(this.rotation*m.DEG_TO_RAD)},h.addChild(d),h.update();var g=p(h.canvas,"original.png"),y=p(u.canvas,"80_80.png"),b=this;setTimeout(function(){var e={original:g,"80_80":y};b._data.identity_id&&(e.identity_id=b._data.identity_id),b.filehtml5.startUpload(s.api_url+"/avatar/update?token="+i.getToken(),e)},15.6)}},viewData:{cls:"modal-uploader",title:"Portrait",body:'<div class="pull-right sider"><div class="pull-right smallphoto"><div class="avatar80"><canvas id="avatar80" width="80" height="80"></canvas></div><div class="overlay"><i class="icon20-zoom zoom"></i></div><div class="loading hide"></div></div><div class="uploader-form"><div class="xalert-error hide"></div><button class="pull-right xbtn xbtn-blue upload-done hide">Done</button><button class="pull-right xbtn xbtn-white upload-clear hide">Clear</button></div></div><div class="photozone"><div class="anchor-n resizeable hide" data-anchor="1"></div><div class="anchor-w resizeable hide" data-anchor="3"></div><div class="anchor-e resizeable hide" data-anchor="4"></div><div class="anchor-s resizeable hide" data-anchor="6"></div><div class="anchor-nw resizeable hide" data-anchor="0"></div><div class="anchor-ne resizeable hide" data-anchor="2"></div><div class="anchor-sw resizeable hide" data-anchor="5"></div><div class="anchor-se resizeable hide" data-anchor="7"></div><div class="avatar240"><i class="icon20-upload upload"></i><i class="icon20-rotate rotate"></i><canvas id="avatar240" width="240" height="240"></canvas></div><div class="loading hide"><img src="/static/img/loading.gif" alt="" width="36" height="39" /><p>Uploading...</p></div><div class="overlay dropbox"><i class="icon20-back back"></i><img class="bigupload" src="/static/img/upload_128.png" alt="" width="128" height="128" /><div class="droptips">Drop your photo <span class="hide">or URL</span> here.<br />Alternatively, <span class="underline">open</span> local file.</div></div></div>',footer:'<button class="pull-right xbtn xbtn-white xbtn-yes hide">Yes</button><button class="pull-right xbtn xbtn-blue xbtn-no hide">No</button>',others:'<div class="help-portrait hide"><div class="modal-body"><div class="shadow title">Use default portrait?</div><p>You have no portrait set, thus a default one will be assigned automatically. It means you will lose your primary visual identification, consequently poor recognizability confuse your friends.</p><p>Confirm using default portrait?</p></div></div>'}}};v.prototype={setPosition:function(e,t){this.x=e||0,this.y=t||0},updateContext:function(e){},updateRect:function(){this.width=this.originalImage.width*this.scaleX,this.width<0&&(this.width=1,this.scaleX=this.width/this.originalImage.width),this.height=this.originalImage.height*this.scaleY,this.height<0&&(this.height=1,this.scaleY=this.height/this.originalImage.height)},draw:function(e){this.updateRect(),e.drawImage(this.originalImage,this.x,this.y,this.width,this.height)}},m.UID=0,m.DEG_TO_RAD=Math.PI/180,m.prototype={toDataURL:function(){},clear:function(){var e=this.canvas.getContext("2d");e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,this.canvas.width,this.canvas.height)},addChild:function(e){return this._children||(this._children=[]),this.parent=this,this._children.push(e),e},draw:function(){var e,t,n,r=this._children;if(!r)return;if(t=this._children.length){n=this.canvas.getContext("2d"),this.clear();for(e=0;e<t;e++){var i=r[e];n.save(),i.updateContext(n),i.draw(n),n.restore()}}},update:function(){this.draw()}},t.Uploader=a,t.uploadSettings=f});