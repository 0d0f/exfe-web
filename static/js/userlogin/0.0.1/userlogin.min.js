define(function(e){function w(e,n){if(n){t("#js-signin").hide();var r=t(".nav li.dropdown").show(),i=u.compile(l[n]);t(i(e)).appendTo(r.find(".dropdown-wrapper"))}}var t=e("jquery"),n=e("rex"),r=e("api"),i=e("bus"),s=e("util"),o=e("store"),u=e("handlebars"),a=window.location,f=s.tokenRegExp,l={1:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body"><div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon16-identity-{{provider}}"></i><span>{{external_id}}</span></div></div><div class="footer"><button class="xbtn xbtn-signin" data-widget="dialog" data-identity-id={{id}} data-dialog-tab="{{__tab__}}" data-dialog-type="{{__dialogtype__}}" data-source="{{external_id}}">Sign In</button></div></div>',2:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body"><div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon-envelope"></i><span>{{external_id}}</span></div><div class="set-up"><a href="#" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d02" data-source="{{external_id}}">Set Up</a> as your independent new <span class="x-sign">EXFE</span> identity.</div></div><div class="footer"><button class="xbtn xbtn-gather" id="js-xgather">Gather</button></div></div>',3:'<div class="dropdown-menu user-panel"><div class="header"><div class="meta"><a class="pull-right avatar" href="/s/profile"><img width="40" height="40" alt="" src="{{avatar_filename}}" /></a><a class="attended" href="/s/profile"><span class="attended-nums">{{cross_quantity}}</span><span class="attended-x"><em class="x-sign">X</em> attended</span></a></div></div><div class="body"></div><div class="footer"><a href="/x/gather" class="xbtn xbtn-gather" id="js-xgather">Gather</a><div class="spliterline"></div><div class="actions"><a href="/s/logout" class="pull-right" id="js-signout">Sign out</a></div></div></div>'},c="xapp:login",h="xapp:logindone",p="xapp:loginfail",d="xapp:cannotlogin",v="xapp:userstatus",m="xapp:usertoken",g="xapp:userpanel",y="xapp:crosstoken",b="xapp:crossfetch";i.on(d,function(){t("#js-signin").show()}),i.on(y,function(e){var n=e.type,s=e.tokens,o=s[0],u=e.status[s],a=u.identity_id,f=u.identity_registration,l="identification",c="",h;switch(f){case"VERIFY":c="d01";break;case"SIGN_UP":c="d02",n=e.type=2;break;case"SIGN_IN":c="d01"}h=r.request("getIdentityById",{resources:{identity_id:a}},function(e){var r=e.identity.external_id;t("#user-name > span").html(e.identity.name||r.split("@")[0]),"verification"===l&&(l+="_"+e.identity.provider),e.identity.__dialogtype__=l,e.identity.__tab__=c,w(e.identity,n)}),h.done(function(e){i.emit(b,o,u)})}),i.on(g,function(e,i){w(i,e),t("#user-name > span").html(i.name);var s=o.get("signin"),a=s.user_id;r.request("crosslist",{resources:{user_id:a}},function(e){var r=e.crosses;if(0===r.length)return;var i=+(new Date),s=i+108e5,o=i-864e5,f=5,l={crosses:[]};n.map(r,function(e,t){if(e.exfee&&e.exfee.invitations&&e.exfee.invitations.length){var r=n.filter(e.exfee.invitations,function(e,t){if(e.rsvp_status==="ACCEPTED"&&e.identity.connected_user_id===a)return!0});r.length&&l.crosses.push(e)}}),l.crosses=l.crosses.slice(0,f),u.registerHelper("alink",function(e){var t="",n=e.time.begin_at,r=(new Date(n.date.replace(/\-/g,"/")+" "+n.time)).getTime();return i<=r&&r<=s?t='<li class="tag"><i class="icon10-now"></i>':o<=r&&r<i?t='<li class="tag"><i class="icon10-24hr"></i>':t="<li>",t+='<a data-id="'+this.id+'" href="/#!'+this.id+'">'+this.title+"</a>"+"</li>",t});var c='{{#if crosses}}<div>Upcoming:</div><ul class="unstyled crosses">{{#each crosses}}{{{alink this}}}{{/each}}</ul>{{/if}}',h=u.compile(c);t(".user-panel .body").html(h(l))})}),i.on(h,function(e,t){t.then(function(t){i.emit(g,e,t.response.user)})}),i.on(m,function(e,t,s){var u=e[0],a=s[u],f=a.user_id,l;r.setToken(u),o.set("signin",{token:u,user_id:f}),l=r.request("getUser",{resources:{user_id:f}},function(e){var t=o.get("last_external_id"),r;t?r=n.filter(e.user.identities,function(e){if(t===e.external_id)return!0})[0]:r=e.user.default_identity,o.set("lastIdentity",r),o.set("last_external_id",r.external_id)}),l.done(function(e){i.emit(h,t,l)})}),i.on(v,function(e){switch(e.type){case 1:case 2:i.emit(y,e.tokens,e.type,e.statuses);break;case 3:i.emit(m,e.tokens,e.type,e.statuses);break;default:}}),i.once(c,function(){f.lastIndex=0;var e=f.exec(a.search),t=e&&e[1]||!1,n=o.get("signin"),s=n&&n.token||!1,u=[],l=0,c;t&&u.push(t),s&&t!==s&&u.push(s);if(0===(c=u.length))return i.emit(d);r.request("checkAuthorization",{type:"POST",data:{tokens:JSON.stringify(u)}},function(e){var t=e.statuses,n=u[0],r=t[n],s,o="CROSS_TOKEN",a="USER_TOKEN";r&&(s=r.type,o===s?(l=1,2===c&&(l=2)):a===s&&(l=3,2===c&&(l=4))),i.emit(v,{tokens:u,type:l,statuses:t})})});var E=t(document.body);t(function(){function n(n){var r=t(this),i=r.data("timer"),s=r.find("div.user-panel"),o=-s.outerHeight();n.preventDefault();if(n.type==="mouseleave")return i=setTimeout(function(){s.stop().animate({top:o},200,function(){r.prev().addClass("hide"),r.parent().removeClass("user")}),clearTimeout(i),r.data("timer",i=null)},500),r.data("timer",i),!1;if(i)return clearTimeout(i),r.data("timer",i=null),!1;e||(s.css("top",o),r.find(".user-panel").addClass("show"),e=!0),r.prev().removeClass("hide"),r.parent().addClass("user"),s.stop().animate({top:56},100)}var e=!1;E.on("mouseenter.dropdown mouseleave.dropdown",".navbar .dropdown-wrapper",n),E.on("click","#js-signout",function(e){e.preventDefault(),o.remove("signin"),window.location="/s/logout"})})});