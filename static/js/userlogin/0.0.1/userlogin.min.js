define("middleware",[],function(e,t,n){function m(e,t){if(t){r("#js-signin").hide();var n=r(".nav li.dropdown").remove("user").show(),i=f.compile(g[t]);r(i(e)).appendTo(n.find(".dropdown-wrapper"))}}var r=e("jquery"),i=e("rex"),s=e("api"),o=e("bus"),u=e("util"),a=e("store"),f=e("handlebars"),l=u.tokenRegExp,c=n.exports={};c.login=function(e,t,n){l.lastIndex=0;var r=l.exec(e.url),i=r&&r[1]||!1,u=a.get("signin"),f=u&&u.token||!1,c=[],h=0,d;i&&c.push(i),f&&i!==f&&c.push(f),t.loginable=!0;if(0===(d=c.length)){t.loginable=!1,e.url!=="/"&&e.url!=="/#gather"?o.emit("xapp:goto_home"):n();return}var u=a.get("signin");s.request("checkAuthorization",{type:"POST",data:{tokens:JSON.stringify(c)}},function(e){var t=e.statuses,r=c[0],i=t[r];i&&(h=3,2===d&&(h=4)),o.emit(p,{tokens:c,type:h,statuses:t}),n()})};var h="xapp:usertoken";o.on(h,function(e,t,n){var r;s.setToken(e),a.set("signin",{token:e,user_id:t}),r=s.request("getUser",{resources:{user_id:t}},function(e){var t=a.get("last_external_id"),n;t?n=i.filter(e.user.identities,function(e){if(t===e.external_id)return!0})[0]:n=e.user.default_identity,a.set("user",e.user),a.set("lastIdentity",n),a.set("last_external_id",n.external_id)}),r.done(function(e){o.emit(d,n,r)})});var p="xapp:userstatus";o.on(p,function(e){switch(e.type){case 1:case 2:o.emit(XAPP_CROSS_TOKEN,e.tokens,e.type,e.statuses);break;case 3:var t=e.tokens[0],n=e.statuses[t],r=n.user_id;o.emit(h,t,r,e.type);break;default:}});var d="xapp:logindone";o.on(d,function(e,t){t.then(function(t){o.emit(v,e,t.response.user),o.emit("xapp:home_profile")})});var v="xapp:userpanel";o.on(v,function(e,t){if(r(".user-panel").length)return;m(t,e),r("#user-name").attr("href","/#"+t.default_identity.external_id),r("#user-name > span").html(t.name);var n=a.get("signin"),o=n.user_id;s.request("crosslist",{resources:{user_id:o}},function(e){var t=e.crosses;if(0===t.length)return;var n=+(new Date),s=n+108e5,u=n-864e5,a=5,l={crosses:[]};i.map(t,function(e,t){if(e.exfee&&e.exfee.invitations&&e.exfee.invitations.length){var n=i.filter(e.exfee.invitations,function(e,t){if(e.rsvp_status==="ACCEPTED"&&e.identity.connected_user_id===o)return!0});n.length&&l.crosses.push(e)}}),l.crosses=l.crosses.slice(0,a),f.registerHelper("alink",function(e){var t="",r=e.time.begin_at,i=(new Date(r.date.replace(/\-/g,"/")+" "+r.time)).getTime();return n<=i&&i<=s?t='<li class="tag"><i class="icon10-now"></i>':u<=i&&i<n?t='<li class="tag"><i class="icon10-24hr"></i>':t="<li>",t+='<a data-id="'+this.id+'" href="/#!'+this.id+'">'+this.title+"</a>"+"</li>",t});var c='{{#if crosses}}<div>Upcoming:</div><ul class="unstyled crosses">{{#each crosses}}{{{alink this}}}{{/each}}</ul>{{/if}}',h=f.compile(c);r(".user-panel .body").html(h(l))})});var g={1:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body"><div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon16-identity-{{provider}}"></i><span>{{external_id}}</span></div></div><div class="footer"><button class="xbtn xbtn-signin" data-widget="dialog" data-identity-id={{id}} data-dialog-tab="{{__tab__}}" data-dialog-type="{{__dialogtype__}}" data-source="{{external_id}}">Sign In</button></div></div>',2:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body"><div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon-envelope"></i><span>{{external_id}}</span></div><div class="set-up"><a href="#" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d02" data-source="{{external_id}}">Set Up</a> as your independent new <span class="x-sign">EXFE</span> identity.</div></div><div class="footer"><button class="xbtn xbtn-gather" id="js-xgather">Gather</button></div></div>',3:'<div class="dropdown-menu user-panel"><div class="header"><div class="meta"><a class="pull-right avatar" href="/#{{default_identity.external_id}}"><img width="40" height="40" alt="" src="{{avatar_filename}}" /></a><a class="attended" href="/#{{default_identity.external_id}}"><span class="attended-nums">{{cross_quantity}}</span><span class="attended-x"><em class="x-sign">X</em> attended</span></a></div></div><div class="body"></div><div class="footer"><a href="/#gather" class="xbtn xbtn-gather" id="js-xgather">Gather</a><div class="spliterline"></div><div class="actions"><a href="#" class="pull-right" id="js-signout">Sign out</a></div></div></div>'},y=r(document.body);r(function(){function t(t){var n=r(this),i=n.data("timer"),s=n.find("div.user-panel").addClass("show"),o=-s.outerHeight();t.preventDefault();if(t.type==="mouseleave")return i=setTimeout(function(){s.stop().animate({top:o},200,function(){n.prev().addClass("hide"),n.parent().removeClass("user")}),clearTimeout(i),n.data("timer",i=null)},500),n.data("timer",i),!1;if(i)return clearTimeout(i),n.data("timer",i=null),!1;e||(s.css("top",o),n.find(".user-panel").addClass("show")),n.prev().removeClass("hide"),n.parent().addClass("user"),s.stop().animate({top:56},100)}var e=!1;y.on("mouseenter.dropdown mouseleave.dropdown",".navbar .dropdown-wrapper",t),y.on("click.dropdown",'.navbar .dropdown-wrapper a[href^="/#"]',function(e){var t=r(".navbar .dropdown-wrapper"),n=t.find("div.user-panel").addClass("show"),i=t.data("timer"),s=-n.outerHeight();clearTimeout(i),t.data("timer",i=null),n.css("top",s),t.prev().addClass("hide").end().parent().removeClass("user")}),y.on("click","#js-signout",function(e){e.preventDefault(),o.emit("xapp:cross:end"),r(".navbar .dropdown-wrapper").find(".user-panel").remove(),r("#js-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),a.remove("signin"),o.emit("xapp:goto_home")})})});