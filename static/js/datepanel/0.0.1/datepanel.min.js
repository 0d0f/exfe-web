define("datepanel",function(e,t,n){function m(e){return e=e.replace(/-/,"/").replace(/-/,"/"),e.length>10&&(e=e.replace(/\.\d\d\d/,""),e=e.replace(/T/," "),e=e.replace(/([\+\-]\d\d):?(\d\d)/," UTC$1$2"),e=e.replace(/Z/," UTC+0000")),e=new Date(e),e}var r=e("jquery"),i=e("api"),s=e("panel"),o=s.extend({options:{template:'<div class="panel date-panel" tabindex="-1" data-widget="panel" id="date-panel"><div class="panel-header"><input type="text" name="date-string" id="date-string" /></div><div class="panel-body"><div class="pull-right date-timeline"><ul class="unstyled"></ul></div><div class="date-container" tabindex="-1"><ul class="unstyled clearfix" id="date-head"><li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li></ul><div class="full-month"></div><table class="table" id="date-table"><tbody></tbody></table></div></div><div class="panel-footer"></div></div>',parentNode:null,srcNode:null,eftime:null},init:function(){var e=this.options,t;this.eftime=t=e.eftime,delete e.eftime,this.render(),this.dateInput=new u(this.$("#date-string"),this),this.dateInput.eftime=t;var n="",i;if(t.outputformat)n=t.origin,i=new Date;else{var i=m(t.begin_at.date+""+(t.begin_at.time?"T"+t.begin_at.time:"")+"Z");n=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate()+(t.begin_at.time?" "+i.getHours()+":"+i.getMinutes()+":"+i.getSeconds():"")}this.dateInput.input(n),this.calendarTable=new l(this.$(".date-container"),this,{maxRows:3,cursor:0,date:i}),this.dataController=new c,this.on("updateDate",function(e,t){this.dateInput.input(e+(e?" ":"")+t)}),this.on("refresh",function(e){this.calendarTable.clean();var t=e.split("-");this.calendarTable.date=new Date(t[0],t[1]-1,t[2]),this.calendarTable.refresh()}),this.generateTimeLine(),this.on("enter",function(e){r("body").trigger("click")})},generateTimeLine:function(){var e=this,t=this.$(".date-timeline ul"),n=24,i=0,s="";for(;i<24;++i)s=i<10?"0"+i:i,t.append("<li>"+s+":00</li><li>"+s+":30</li>");t.find("li").click(function(t){var n=r(this).text();e.emit("updateDate","",n)}),setTimeout(function(){this.$(".date-timeline").scrollTop(360)},0)},showBefore:function(){this.element.attr("editarea","date-panel")},showAfter:function(){var e=this.srcNode;if(e){var t=e.offset(),n=this.element.outerWidth();this.element.css({left:t.left-n-15,top:t.top})}this.dateInput.el.focus()},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),u=function(e,t,n){this.component=t,this.el=e,this.el.on("keypress.dateinput",r.proxy(this.keypress,this)),this.el.on("keyup.dateinput",r.proxy(this.keyup,this)),r.browser.webkit|r.browser.msie|r.browser.mozilla&&this.el.on("keydown.dateinput",r.proxy(this.keypress,this)),this.befer=null,this.timezone=this.el.data("timezone"),this.timezone||(this.timezone=h())};u.prototype={input:function(e){/^\d\d:\d\d$/.test(e)&&(e=(this.component.element.find("table td.selected").data("date")||this.component.element.find("table td.today").data("date"))+" "+e),this.el.val(r.trim(e)),this.oldVal=e},output:function(){return r.trim(this.el.val())},lookup:function(){var e=this,t=e.component;e.befer&&e.befer.abort();var n=r.trim(e.el.val());if(!n)return;if(e.oldVal===n)return;e.befer=i.request("recognize",{type:"POST",data:{time_string:n,timezone:e.timezone}},function(e){var n=e.cross_time,r;if(n.begin_at.date)r=n.begin_at.date;else{var i=new Date;r=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate()}t.emit("refresh",r)},function(e){})},keyup:function(e,t){var n=this;t=e.keyCode;switch(t){case 40:case 38:break;case 9:break;case 13:break;case 27:break;default:n.lookup()}e.stopPropagation(),e.preventDefault()},keypress:function(e,t){var n=this;t=e.keyCode;switch(t){case 9:n.el.parent().next().find(".date-container").focus(),e.preventDefault();break;case 13:var r=n.output();n.component.emit("enter",r);break;case 27:e.preventDefault();break;case 38:break;case 40:}e.stopPropagation()}};var a="January February March April May June July August September October November December".split(" "),f="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),l=function(e,t,n){this.el=e,this.component=t,this.length=0,this.lines=0,this.columns=7,this.options=n,this.options||(this.options={}),n=this.options,n.maxRows||(n.maxRows=3),n.cursor||(n.cursor=0),this.today=new Date,this.date=n.date||new Date,this.todayString=p(this.today),this.nextPage(this.date),this.initCursor(p(this.date)),this.setCursorClass(),this.select(),this.lines=n.maxRows,this.line=0,this.column=this.date.getDay(),this.table=this.el.find("table"),this.keyDown(),this.handlers()};l.prototype={refresh:function(){var e=this.options;this.length=0,this.nextPage(this.date),this.initCursor(p(this.date)),this.setCursorClass(),this.select(),this.lines=e.maxRows,this.line=0,this.column=this.date.getDay(),this.scrollTop(0)},scrollTop:function(e){this.table.css("margin-top",e)},handlers:function(){var e=this,t=this.el,n=e.options;t.on("mouseleave.calendar","table",function(t){var n=e.getSelected();e.setCursor(n),e.line=n.parent().index(),e.column=n.index()}),t.on("hover.calendar","table td",function(n){t.find(".full-month").text(""),n.preventDefault();var i=n.type,s=i==="mouseenter",o=r(this);s?(e.setCursor(o),e.setCursorClass(),e.line=o.parent().index(),e.column=o.index()):e.currentCursor.removeClass("hover").find(".m").addClass("hide")}).on("click.calendar","table td",function(t){var n=r(this),i=n.data("date");e.el.find("td.selected").removeClass("selected"),n.addClass("selected"),e.component.emit("updateDate",i,"")})},keyDown:function(){var e=this,t=this.el,n=e.options;t.on("keydown.calendar",function(t){var n=t.keyCode,r=t.shiftKey,i=!1;t.preventDefault();switch(n){case 32:e.el.find("td.selected").removeClass("selected"),e.select();var s=e.currentCursor.data("date");e.component.emit("updateDate",s,"");break;case 13:var s="",o=e.getSelected();o.size()&&(s=o.data("date")),e.component.emit("enter",s);break;case 37:i=!0,0===e.column?(e.column=6,0===e.line?(e.prevPage(),e.scrollTop(0),e.line=2):(0===e.line%3&&e.scrollTop("+=135"),e.line--)):e.column--,e.left();break;case 38:i=!0,0===e.line?(e.prevPage(),e.scrollTop(0),e.line=2):(0===e.line%3&&e.scrollTop("+=135"),e.line--),e.top();break;case 39:i=!0,6===e.column?(e.column=0,e.line===e.lines-1?(e.nextPage(),e.scrollTop("-=135")):0===(e.line+1)%3&&e.scrollTop("-=135"),e.line++):e.column++,e.right();break;case 40:i=!0,e.line===e.lines-1?(e.nextPage(),e.scrollTop("-=135")):0===(e.line+1)%3&&e.scrollTop("-=135"),e.line++,e.bottom();break;case 9:e.el.parent().prev().find("input#date-string").focus()}e.el.find(".full-month").text(i?a[e.date.getMonth()]:"")})},generateHTML:function(e){var t=this.options,n=t.maxRows,r=this.todayString,i='<span class="m hide">{{m}}</span><span class="d">{{d}}</span>',s="";this.lines+=n;for(var o=0;o<n;++o){var u="<tr>",a="",l="",c;for(var h=0;h<7;h++){l=p(e),c=l===r,a+='<td data-date="'+l+'"'+(c?' class="today"':"")+">";var d=i;a+=d.replace("{{m}}",f[e.getMonth()]).replace("{{d}}",c?"Today":e.getDate()),a+="</td>",e.setDate(e.getDate()+1)}u+=a+"</tr>",s+=u}return s},prevPage:function(){var e=this.options,t=e.maxRows,n=this.startOf,r;this.startOf=n=new Date(n.getFullYear(),n.getMonth(),n.getDate()-7*t),r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),this.el.find("tbody").prepend(this.generateHTML(r))},nextPage:function(e){var t=this.options,n=this.endOf;if(e){var r=e.getDate(),i=e.getDay();this.startOf=new Date(e.getFullYear(),e.getMonth(),r-i),this.endOf=new Date(e.getFullYear(),e.getMonth(),r-i)}this.length++,this.el.find("tbody").append(this.generateHTML(this.endOf))},getSelected:function(){return this.el.find("td.selected, td.today").eq(0)},initCursor:function(e){this.setCursor(this.el.find('td[data-date="'+e+'"]'))},setCursor:function(e){this.currentCursor=e;var t=this.currentCursor.data("date");this.date=new Date(t)},select:function(){this.currentCursor.addClass("selected")},setCursorClass:function(){this.el.find("td.hover, td.today").removeClass("hover").find(".m").addClass("hide"),this.currentCursor.addClass("hover").find(".m").removeClass("hide")},move:function(){},moveX:function(){},moveY:function(){},left:function(){var e;6!==this.column?e=this.currentCursor.prev():e=this.currentCursor.parent().prev().find("td").eq(this.column),this.setCursor(e),this.setCursorClass()},top:function(){var e=this.currentCursor.parent().prev().find("td").eq(this.column);this.setCursor(e),this.setCursorClass()},right:function(){var e;0===this.column?e=this.currentCursor.parent().next().find("td").eq(this.column):e=this.currentCursor.next(),this.setCursor(e),this.setCursorClass()},bottom:function(){var e=this.currentCursor.parent().next().find("td").eq(this.column);this.setCursor(e),this.setCursorClass()},clean:function(){this.el.find("tbody").empty()}};var c=function(){};c.prototype={};var h=function(){var e=(new Date).toString(),t=e.replace(/^.*([\+\-]\d\d):?(\d\d).*$/,"$1:$2"),n=e.replace(/^.*\(([a-z]*)\).*$/i,"$1");return n=n==="UTC"||n==="GMT"?"":n,t+(n?" "+n:"")},p=function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},d=function(e,t){var n=new Date(0);return n.setUTCFullYear(e,t,0),n.getUTCDate()},v=function(e,t){var n=new Date(0);return n.setUTCFullYear(e,t-1,1),n.getUTCDay()};return o});