define("datepanel",function(e,t,n){function y(e){return e=e.replace(/-/,"/").replace(/-/,"/"),e.length>10&&(e=e.replace(/\.\d\d\d/,""),e=e.replace(/T/," "),e=e.replace(/([\+\-]\d\d):?(\d\d)/," UTC$1$2"),e=e.replace(/Z/," UTC+0000")),e=new Date(e),e}function b(e){var t=s(),n=t.format("Z"),r=e.begin_at,i=r.timezone&&/(^[\+\-]\d\d:\d\d)/.exec(r.timezone)[1]||"",o="",u="";r.date&&(o+=r.date,u+="YYYY-MM-DD"),r.time&&(o+=" "+r.time,u+=" HH:mm:ss"),(r.date||r.time)&&i&&(o+=" +0000",u+=" ZZ");var a=s(o,u),o="",f,l,c=n===i;return e.outputformat?(o=e.origin,c||(o+=" "+i),o||"Sometime"):(r.time_word&&(o+=r.time_word+" (at) "),r.time&&(o+=a.format("HH:mm:ss")),!c&&i&&(o+=" ("+i+") "),r.date_word&&(o+=r.date_word+" (on) "),r.date&&(o+=" "+a.format("YYYY-MM-DD")),a&&a.year()!==1900&&a.year()!==t.year()&&(o+=" "+a.year()),o||(u?a.format(u):"Sometime"))}var r=e("jquery"),i=e("api"),s=e("moment"),o=e("panel"),u=o.extend({options:{template:'<div class="panel date-panel" tabindex="-1" data-widget="panel" id="date-panel"><div class="panel-header"><input type="text" name="date-string" id="date-string" /></div><div class="panel-body"><div class="pull-right date-timeline"><ul class="unstyled"></ul></div><div class="date-container" tabindex="-1"><ul class="unstyled clearfix" id="date-head"><li>Sun</li><li>Mon</li><li>Tue</li><li>Wed</li><li>Thu</li><li>Fri</li><li>Sat</li></ul><div class="full-month"></div><table class="table" id="date-table"><tbody></tbody></table></div></div><div class="panel-footer"></div></div>',parentNode:null,srcNode:null,eftime:null},init:function(){var e=this.options,t;this.eftime=t=e.eftime,delete e.eftime,this.render(),this.dateInput=new a(this.$("#date-string"),this),this.dateInput.eftime=t;var n,i;if(t.outputformat)n=new Date,i=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate();else{var o="",u="",f="",l=t.begin_at.timezone&&/(^[\+\-]\d\d:\d\d)/.exec(t.begin_at.timezone)[1]||"";t.begin_at.date&&(o+=t.begin_at.date,u+="YYYY-MM-DD",f+="YYYY-MM-DD"),t.begin_at.time&&(o+=" "+t.begin_at.time,u+=" HH:mm:ss",f+=" HH:mm:ss"),(t.begin_at.date||t.begin_at.time)&&l&&(o+=" +0000",u+=" ZZ"),n=s(o,u),i=n.format(f),n=y(n.format(u))}this.dateInput.input(i),this.calendarTable=new c(this.$(".date-container"),this,{maxRows:3,cursor:0,date:n}),this.dataController=new h,this.on("updateDate",function(e,t){this.dateInput.input(t+(t?" ":"")+e)}),this.on("refresh",function(e){this.calendarTable.clean();var t=e.split("-");this.calendarTable.date=new Date(t[0],t[1]-1,t[2]),this.calendarTable.refresh()}),this.generateTimeLine(),this.on("enter",function(e){this.dateInput.el.data("date",e),r("body").trigger("click")})},generateTimeLine:function(){var e=this,t=this.$(".date-timeline ul"),n=24,i=0,s="";for(;i<24;++i)s=i<10?"0"+i:i,t.append("<li>"+s+":00</li><li>"+s+":30</li>");t.find("li").click(function(t){var n=r(this).text();e.emit("updateDate","",n)}),setTimeout(function(){this.$(".date-timeline").scrollTop(360)},0)},showBefore:function(){this.element.attr("editarea","date-panel")},showAfter:function(){var e=this.srcNode;if(e){var t=e.offset(),n=this.element.outerWidth();this.element.css({left:t.left-n-15,top:t.top})}this.dateInput.el.focus()},destory:function(){this.element.off(),this.element.remove(),this._destory()}}),a=function(e,t,n){this.component=t,this.el=e,this.el.on("keypress.dateinput",r.proxy(this.keypress,this)),this.el.on("keyup.dateinput",r.proxy(this.keyup,this)),r.browser.webkit|r.browser.msie|r.browser.mozilla&&this.el.on("keydown.dateinput",r.proxy(this.keypress,this)),this.befer=null,this.timezone=this.el.data("timezone"),this.timezone||(this.timezone=p())};a.prototype={input:function(e){/^\d\d:\d\d$/.test(r.trim(e))&&(e=(this.component.element.find("table td.selected").data("date")||this.component.element.find("table td.today").data("date"))+" "+e),this.el.val(r.trim(e)),this.el.data("date",e)},output:function(){return r.trim(this.el.val())},lookup:function(){var e=this,t=e.component;e.befer&&e.befer.abort();var n=r.trim(e.el.val());if(!n)return;var o=e.el.data("date");if(o===n)return;e.befer=i.request("recognize",{type:"POST",data:{time_string:n,timezone:e.timezone}},function(n){var r=n.cross_time,i;e.eftime=n.cross_time;if(r.begin_at.date)i=s(r.begin_at.date+" +0000","YYYY-MM-DD ZZ"),i=i.format("YYYY-MM-DD");else{var o=new Date;i=o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()}e.el.data("date",i),t.emit("refresh",i)},function(e){})},keyup:function(e,t){var n=this;t=e.keyCode;switch(t){case 40:case 38:break;case 9:break;case 13:break;case 27:break;default:n.lookup()}e.preventDefault()},keypress:function(e,t){var n=this;t=e.keyCode;switch(t){case 9:n.el.parent().next().find(".date-container").focus(),e.preventDefault();break;case 13:var r=n.el.data("date"),i,o=[];if(i=r.match(/(\d{4})\-(\d{2})\-(\d{2})/))o[0]=i[1],o[1]=+i[2]-1,o[2]=i[3],i=!1;(i=r.match(/(\d{2}):(\d{2}):?(\d{2})?/))?(o[3]=+i[1],o[4]=+i[2],o[5]=+i[3]||0):i=!1,o=s.utc(o);var u=n.eftime;u.begin_at.date=o.format("YYYY-MM-DD"),i&&(u.begin_at.time=o.format("HH:mm:ss"));var a,f="",l="",c="",h=u.begin_at.timezone&&/(^[\+\-]\d\d:\d\d)/.exec(u.begin_at.timezone)[1]||"";u.begin_at.date&&(f+=u.begin_at.date,l+="YYYY-MM-DD",c+="YYYY-MM-DD"),u.begin_at.time&&(f+=" "+u.begin_at.time,l+=" HH:mm:ss",c+=" HH:mm:ss"),(u.begin_at.date||u.begin_at.time)&&h&&(f+=" +0000",l+=" ZZ"),d=s(f,l),n.el.data("date",a=d.format(c)),n.component.emit("enter",a);break;case 27:e.preventDefault();break;case 38:break;case 40:}}};var f="January February March April May June July August September October November December".split(" "),l="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),c=function(e,t,n){this.el=e,this.component=t,this.length=0,this.lines=0,this.columns=7,this.options=n,this.options||(this.options={}),n=this.options,n.maxRows||(n.maxRows=3),n.cursor||(n.cursor=0),this.today=new Date,this.date=n.date||new Date,this.todayString=v(this.today),this.nextPage(this.date),this.initCursor(v(this.date)),this.setCursorClass(),this.select(),this.lines=n.maxRows,this.line=0,this.column=this.date.getDay(),this.table=this.el.find("table"),this.keyDown(),this.handlers()};c.prototype={refresh:function(){var e=this.options;this.length=0,this.nextPage(this.date),this.initCursor(v(this.date)),this.setCursorClass(),this.select(),this.lines=e.maxRows,this.line=0,this.column=this.date.getDay(),this.scrollTop(0)},scrollTop:function(e){this.table.css("margin-top",e)},handlers:function(){var e=this,t=this.el,n=e.options;t.on("mouseleave.calendar","table",function(t){var n=e.getSelected();e.setCursor(n),e.line=n.parent().index(),e.column=n.index()}),t.on("hover.calendar","table td",function(n){t.find(".full-month").text(""),n.preventDefault();var i=n.type,s=i==="mouseenter",o=r(this);s?(e.setCursor(o),e.setCursorClass(),e.line=o.parent().index(),e.column=o.index()):e.currentCursor.removeClass("hover").find(".m").addClass("hide")}).on("click.calendar","table td",function(t){var n=r(this),i=n.data("date");e.el.find("td.selected").removeClass("selected"),n.addClass("selected"),e.component.emit("updateDate",i,"")})},keyDown:function(){var e=this,t=this.el,n=e.options;t.on("keydown.calendar",function(t){var n=t.keyCode,r=t.shiftKey,i=!1;t.preventDefault();switch(n){case 32:e.el.find("td.selected").removeClass("selected"),e.select();var s=e.currentCursor.data("date");e.component.emit("updateDate",s,"");break;case 13:e.el.find("td.selected").removeClass("selected"),e.select();var s=e.currentCursor.data("date");e.component.emit("updateDate",s,""),e.component.emit("enter",s);break;case 37:i=!0,0===e.column?(e.column=6,0===e.line?(e.prevPage(),e.scrollTop(0),e.line=2):(0===e.line%3&&e.scrollTop("+=132"),e.line--)):e.column--,e.left();break;case 38:i=!0,0===e.line?(e.prevPage(),e.scrollTop(0),e.line=2):(0===e.line%3&&e.scrollTop("+=132"),e.line--),e.top();break;case 39:i=!0,6===e.column?(e.column=0,e.line===e.lines-1?(e.nextPage(),e.scrollTop("-=132")):0===(e.line+1)%3&&e.scrollTop("-=132"),e.line++):e.column++,e.right();break;case 40:i=!0,e.line===e.lines-1?(e.nextPage(),e.scrollTop("-=132")):0===(e.line+1)%3&&e.scrollTop("-=132"),e.line++,e.bottom();break;case 9:e.el.parent().prev().find("input#date-string").focus()}e.el.find(".full-month").text(i?f[e.date.getMonth()]:"")})},generateHTML:function(e){var t=this.options,n=t.maxRows,r=this.todayString,i='<span class="m hide">{{m}}</span><span class="d">{{d}}</span>',s="";this.lines+=n;for(var o=0;o<n;++o){var u="<tr>",a="",f="",c;for(var h=0;h<7;h++){f=v(e),c=f===r,a+='<td data-date="'+f+'"'+(c?' class="today"':"")+">";var p=i;a+=p.replace("{{m}}",l[e.getMonth()]).replace("{{d}}",c?"Today":e.getDate()),a+="</td>",e.setDate(e.getDate()+1)}u+=a+"</tr>",s+=u}return s},prevPage:function(){var e=this.options,t=e.maxRows,n=this.startOf,r;this.startOf=n=new Date(n.getFullYear(),n.getMonth(),n.getDate()-7*t),r=new Date(n.getFullYear(),n.getMonth(),n.getDate()),this.el.find("tbody").prepend(this.generateHTML(r))},nextPage:function(e){var t=this.options,n=this.endOf;if(e){var r=e.getDate(),i=e.getDay();this.startOf=new Date(e.getFullYear(),e.getMonth(),r-i),this.endOf=new Date(e.getFullYear(),e.getMonth(),r-i)}this.length++,this.el.find("tbody").append(this.generateHTML(this.endOf))},getSelected:function(){return this.el.find("td.selected, td.today").eq(0)},initCursor:function(e){this.setCursor(this.el.find('td[data-date="'+e+'"]'))},setCursor:function(e){this.currentCursor=e;var t=this.currentCursor.data("date");this.date=new Date(t)},select:function(){this.currentCursor.addClass("selected")},setCursorClass:function(){this.el.find("td.hover, td.today").removeClass("hover").find(".m").addClass("hide"),this.currentCursor.addClass("hover").find(".m").removeClass("hide")},move:function(){},moveX:function(){},moveY:function(){},left:function(){var e;6!==this.column?e=this.currentCursor.prev():e=this.currentCursor.parent().prev().find("td").eq(this.column),this.setCursor(e),this.setCursorClass()},top:function(){var e=this.currentCursor.parent().prev().find("td").eq(this.column);this.setCursor(e),this.setCursorClass()},right:function(){var e;0===this.column?e=this.currentCursor.parent().next().find("td").eq(this.column):e=this.currentCursor.next(),this.setCursor(e),this.setCursorClass()},bottom:function(){var e=this.currentCursor.parent().next().find("td").eq(this.column);this.setCursor(e),this.setCursorClass()},clean:function(){this.el.find("tbody").empty()}};var h=function(){};h.prototype={};var p=function(){var e=(new Date).toString(),t=e.replace(/^.*([\+\-]\d\d):?(\d\d).*$/,"$1:$2"),n=e.replace(/^.*\(([a-z]*)\).*$/i,"$1");return n=n==="UTC"||n==="GMT"?"":n,t+(n?" "+n:"")},v=function(e){return e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()},m=function(e,t){var n=new Date(0);return n.setUTCFullYear(e,t,0),n.getUTCDate()},g=function(e,t){var n=new Date(0);return n.setUTCFullYear(e,t-1,1),n.getUTCDay()};return u});