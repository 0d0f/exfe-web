define("routes",function(e,t,n){function f(e,t){function i(e,t){var n=o.printExtUserName(e.identities[0]);t.redirect("/#"+n)}var n=e.session,r=u.get("user");if(r){i(r,t);return}var a=n.authorization;s.emit("app:user:signin",a.token,a.user_id,!0)}var r=e("rex"),i=e("api"),s=e("bus"),o=e("util"),u=e("store");e("user");var a=n.exports={};a.index=function(e,t,n){if(e.session.authorization){f(e,t);return}s.emit("app:page:home",!0),t.render("index.html",function(t){var n=$("#app-main");n.append(t);var r=n.find("div.page-main"),i=$('<img class="exfe-toy" id="js-exfe-toy" src="/static/img/exfe.png" alt="" />');r.append(i),i.load(function(){$.ajax({dataType:"script",cache:!0,url:"/static/js/home/0.0.1/home.js?t="+e.app.set("timestamp")})})})},a.gather=function(e,t,n){var r=e.session;s.emit("app:page:home",!1);if(!r.initMenuBar){var i=r.authorization,o=r.user;s.emit("app:page:usermenu",!!i),i&&(r.initMenuBar=!0,s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id))}t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",0)})},a.resolveToken=function(e,t,n){e.origin="resolveToken";var r=e.params[0];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),r?n():t.redirect("/#invalid/token="+r)},a.resolveRequest=function(e,t,n){var r=e.session,a=r.user,f=r.authorization,l=e.params[0];r.originToken=l;var c=i.request("resolveToken",{type:"POST",data:{token:l}},function(e){r.resolveData=e;var t=e.token,i=e.user_id,c=e.user_name,h=e.identity_id,p=e.token_type,d=e.action,v;f&&f.user_id===i||!f&&p==="VERIFY"&&d==="VERIFIED"?(f={token:t,user_id:i},u.set("authorization",f=r.authorization),r.auto_sign=!0,delete r.originToken):r.browsing_authorization=v=e,s.emit("app:api:getuser",t,i,function(t){var i=t.user;if(v){var h=o.printExtUserName(i.identities[0]),p;f?p="/#"+h+"/token="+l:p="/#"+h,s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:i,action:d,setup:d==="INPUT_NEW_PASSWORD",originToken:l,tokenType:"user",page:"resolve",readOnly:!0,user_name:c||i.name,forward:p},"browsing_identity")}else u.set("user",a=r.user=t.user),s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",f.token,f.user_id);n()})},function(){t.redirect("/#invalid/token="+l)})},a.resolveShow=function(e,t,n){var i=e.session,s=i.auto_sign,o=i.originToken,u=i.user,a=i.authorization,f=i.browsing_authorization,l=i.resolveData,c=l.identity_id,h=l.token_type,p=l.action,d="identity_verified.html";if(s&&a&&!f){delete i.auto_sign,t.render(d,function(e){var n=$("#app-main");n.append(e),n.find(".tab01").removeClass("hide"),n.find(".tab01 > p").animate({opacity:0},2333,function(){t.redirect("/")})});return}if(!s&&h==="VERIFY"&&p==="VERIFIED"){t.render(d,function(e){var t=$("#app-main");t.append(e),$("#app-browsing-identity").trigger("click.data-api"),$(".modal-bi").css("top",200)});return}p==="INPUT_NEW_PASSWORD"&&(d="forgot_password.html",t.render(d,function(e){$("#app-main").append(e);if(a&&!f){var t=r.find(u.identities,function(e){if(e.id===c)return!0}),n=$('<div class="merge set-up" data-destory="true" data-user-action="setup" data-widget="dialog" data-dialog-type="setup_email">');n.data("source",{browsing_user:u,identity:t,originToken:o,user_name:l.user_name,tokenType:"user"}),n.appendTo($("#app-tmp")),n.trigger("click.dialog.data-api")}else $("#app-user-menu").find(".set-up").trigger("click.dialog.data-api");$(".modal-su").css("top",230)})),delete i.browsing_authorization,delete i.resolveData,delete i.originToken},a.cross=function(e,t,n){var r=e.session,i=r.authorization,o=r.user;if(!i){s.emit("app:page:home",!1),s.emit("app:page:usermenu",!1),s.emit("app:cross:forbidden",e.params[0],null);return}s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),r.initMenuBar||(s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id));var u=e.params[0];t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",u)})},s.on("app:cross:forbidden",function(e,t){$("#app-main").load("/static/views/forbidden.html",function(){var e=u.get("authorization"),n={options:{keyboard:!1,backdrop:!1,viewData:{cls:"modal-id"}}};t&&$(".sign-in").data("source",t.external_username),$(".sign-in").data("dialog-settings",n),$(".sign-in").trigger("click.dialog.data-api"),$(".sign-in").data("dialog-settings",null),$(".popmenu").addClass("hide");if(!e)$(".please-signin").removeClass("hide"),$(".modal-id").css("top",260);else{var r=u.get("user");$(".details").removeClass("hide"),$(".details .avatar img").attr("src",r.avatar_filename),$(".details .identity-name").text(r.name),$(".please-access").removeClass("hide"),$(".modal-id").css({top:380})}})}),a.crossInvitation=function(e,t,n){var u=e.session,a=u.authorization,f=u.user,l=f&&f.id,c=e.params[0],h=e.params[1];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!!a),a&&(s.emit("app:usermenu:updatenormal",f),s.emit("app:usermenu:crosslist",a.token,a.user_id)),i.request("getInvitationByToken",{type:"POST",resources:{cross_id:c},data:{token:h}},function(e){var n=e.invitation,i=n.identity,u=n.by_identity,h;if(l){h=r.filter(f.identities,function(e){if(e.connected_user_id===i.connected_user_id&&e.id===i.id)return!0});if(h.length){t.redirect("/#!"+c);return}}if(i.provider==="email"){s.emit("app:cross:forbidden",c,i);return}t.render("invite.html",function(e){$("#app-main").append(e),a?($(".please-access").removeClass("hide"),$(".form-horizontal").addClass("fh-left"),$(".details").removeClass("hide"),$(".details .avatar img").attr("src",f.avatar_filename),$(".details .identity-name").text(f.name)):$(".please-signin").removeClass("hide"),$(".invite-to").find("img").attr("src",i.avatar_filename).parent().next().text(o.printExtUserName(i)),$(".invite-from").find("img").attr("src",u.avatar_filename).parent().next().text(o.printExtUserName(u));var t=$(".x-invite").find(".redirecting"),n=t.next(),r=!1;$(".xbtn-authenticate").on("click",function(e){e.stopPropagation(),e.preventDefault();if(r)return;$.ajax({url:"/OAuth/twitterAuthenticate",type:"POST",dataType:"JSON",data:{callback:window.location.href},beforeSend:function(e){r=!0,n.addClass("hide"),t.removeClass("hide")},success:function(e){r=!1;var i=e.meta.code;i===200?window.location.href=e.response.redirect:(t.addClass("hide"),n.removeClass("hide"))}})})})},function(e){e.meta.code===404&&t.location("/404")})},a.crossToken=function(e,t,n){var r=e.session,o=r.authorization,a=r.user,f=o&&o.token,l=e.params[0],c=e.params[1],h,p={},d;f&&(p.token=f),h=u.get("cat:"+l),h?d={cross_access_token:h}:d={invitation_token:l},i.request("getCrossByInvitationToken",{type:"POST",params:p,data:d},function(e){function v(){t.render("x.html",function(e){$("#app-main").empty().append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",null,i,f,d,h,!!c)})}var n=e.authorization,i=e.browsing_identity,o=e.action,f=e.cross,p=e.cross_access_token,d=e.read_only;!1===d&&p&&u.set("cat:"+l,h=p),s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0);if(n||!i){if(!r.initMenuBar){if(n){s.once("app:user:signin:after",function(){t.redirect("/#!"+f.id)}),s.emit("app:user:signin",n.token,n.user_id);return}t.redirect("/#!"+f.id)}}else i&&s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:{identities:[i],name:i.name},action:o,setup:o==="setup",originToken:l,tokenType:"cross",page:"cross",readOnly:d},"browsing_identity");v()},function(e){e.meta.code===404&&t.location("/404")})},a.profile=function(e,t,n){var i=e.session,u=i.authorization,a=i.user,f=i.browsing_authorization,l=i.browsing_user,c=i.action,h=i.oauth;s.emit("app:page:home",!1);var p=e.params[2],d=p&&p.match(o.tokenRegExp),v=d&&d[1];if(v&&!f){t.redirect("/#token="+v);return}u||f?(document.title="EXFE - Profile",s.emit("app:page:usermenu",!0),u&&!f?(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",u.token,u.user_id),t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",a);var t=$.Deferred();t.resolve(u),s.emit("app:profile:show",t);if(h&&h.identity_status!=="connected"){var n=a.identities,o=r.filter(n,function(e){if(e.id===h.identity_id)return!0})[0];$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-oauth-provider="'+h.provider+'"></div>').appendTo(document.body).trigger({type:"click",following:h.following,identity:o,token:u.token}).remove(),delete i.oauth}})):f?($(document.body).attr("data-browsing"),s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:l,action:c,setup:c==="INPUT_NEW_PASSWORD",originToken:i.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete i.originToken,t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",l);var t=$.Deferred();t.resolve(f),s.emit("app:profile:show",t)})):t.redirect("/")):t.redirect("/")},a.invalid=function(e,t,n){var r=e.session,i=r.authorization,o=r.user;document.title="EXFE - Invalid Link",s.emit("app:page:home",!1),i?(s.emit("app:page:usermenu",!0),s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id)):s.emit("app:page:usermenu",!1),t.render("invalid.html",function(e){$("#app-main").append(e)})},a.signout=function(e,t,n){u.remove("user"),u.remove("authorization"),window.location.href="/"},a.refreshAuthUser=function(e,t,n){var r=e.session,i=r.authorization;if(!i){n();return}s.emit("app:api:getuser",i.token,i.user_id,function(e){var t=e.user;u.set("user",r.user=t),n()},function(e){e&&e.meta.code===401&&(u.remove("user"),u.remove("authorization"),delete r.user,delete r.authorization),n()})}});