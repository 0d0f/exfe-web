define("routes",function(e,t,n){function f(e,t){function i(e,t){var n=o.printExtUserName(e.identities[0]);t.redirect("/#"+n)}var n=e.session,r=u.get("user");if(r){i(r,t);return}var a=n.authorization;s.emit("app:user:signin",a.token,a.user_id,!0)}var r=e("rex"),i=e("api"),s=e("bus"),o=e("util"),u=e("store");e("user");var a=n.exports={};a.index=function(e,t,n){if(e.session.authorization){f(e,t);return}s.emit("app:page:home",!0),t.render("index.html",function(t){var n=$("#app-main");n.append(t);var r=n.find("div.page-main"),i=$('<img class="exfe-toy" id="js-exfe-toy" src="/static/img/exfe.png" alt="" />');r.append(i),i.load(function(){$.ajax({dataType:"script",cache:!0,url:"/static/js/home/0.0.1/home.js?t="+e.app.set("timestamp")})})})},a.gather=function(e,t,n){var r=e.session;s.emit("app:page:home",!1);if(!r.initMenuBar){var i=r.authorization,o=r.user;s.emit("app:page:usermenu",!!i),i&&(r.initMenuBar=!0,s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id))}t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",0)})},a.resolveToken=function(e,t,n){e.origin="resolveToken";var r=e.params[0];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),r?n():t.redirect("/#invalid/token="+r)},a.resolveRequest=function(e,t,n){var r=e.session,a=r.user,f=r.authorization,l=e.params[0];r.originToken=l;var c=i.request("resolveToken",{type:"POST",data:{token:l}},function(e){r.resolveData=e;var t=e.token,i=e.user_id,c=e.user_name,h=e.identity_id,p=e.mergeable_user,d=e.token_type,v=e.action,m;!p&&(f&&f.user_id===i||!f&&d==="VERIFY"&&v==="VERIFIED")?(f={token:t,user_id:i},u.set("authorization",r.authorization=f),r.auto_sign=v!=="INPUT_NEW_PASSWORD"):r.browsing_authorization=m=e,s.emit("app:api:getuser",t,i,function(t){var i=t.user;r.resolveData.setup=v==="INPUT_NEW_PASSWORD"&&d==="VERIFY"&&i.password===!1;if(m){r.browsing_user=i;var h=o.printExtUserName(i.identities[0]),g;f?g="/#"+h+"/token="+l:g="/#"+h,s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:i,action:v,setup:v==="INPUT_NEW_PASSWORD"&&d==="VERIFY"&&i.password===!1,originToken:l,tokenType:"user",page:"resolve",readOnly:!0,user_name:c||i.name,mergeable_user:p,forward:g},"browsing_identity")}else u.set("user",a=r.user=t.user),s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",f.token,f.user_id);n()})},function(){t.redirect("/#invalid/token="+l)})},a.resolveShow=function(e,t,n){var i=e.session,o=i.auto_sign,u=i.originToken,a=i.user,f=i.authorization,l=i.browsing_authorization,c=i.browsing_user,h=i.resolveData,p=h.identity_id,d=h.user_name,v=h.user_id,m=h.token,g=h.token_type,y=h.mergeable_user,b=h.action,w="identity_verified.html";if(y){t.render(w,function(e){var t=$("#app-main");t.append(e);var n=$('<div id="js-dialog-merge" data-destory="true" data-widget="dialog" data-dialog-type="mergeidentity">');n.data("source",{merged_identity:r.find(c.identities,function(e){if(e.id===p)return!0}),browsing_token:u,mergeable_user:y}),n.appendTo($("#app-tmp")),n.trigger("click.dialog.data-api"),$(".modal-mi").css("top",230)});return}if(o&&f&&!l){delete i.auto_sign,t.render(w,function(e){var n=$("#app-main");n.append(e),n.find(".tab01").removeClass("hide"),n.find(".tab01 > p").animate({opacity:0},2333,function(){t.redirect("/")})});return}if(!o&&g==="VERIFY"&&b==="VERIFIED"){t.render(w,function(e){var t=$("#app-main");t.append(e),$("#app-browsing-identity").trigger("click.data-api"),$(".modal-bi").css("top",200)});return}b==="INPUT_NEW_PASSWORD"&&(w="forgot_password.html",t.render(w,function(e){$("#app-main").append(e);if(f&&!l){var t=r.find(a.identities,function(e){if(e.id===p)return!0}),n;g==="VERIFY"?(n=$('<div class="merge set-up" data-destory="true" data-user-action="setup" data-widget="dialog" data-dialog-type="setup_email">'),n.data("source",{browsing_user:a,identity:t,originToken:u,user_name:h.user_name,tokenType:"user"})):g==="SET_PASSWORD"&&(n=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),n.data("source",{user:a,token:h.setup?f.token:u,setup:h.setup})),n.appendTo($("#app-tmp")),n.trigger("click.dialog.data-api")}else g==="VERIFY"?(s.once("app:user:signin:after",function(){var e=$('<div class="addidentity" data-destory="true" data-widget="dialog" data-dialog-type="addIdentityAfterSignIn">');e.data("source",{identity:c.identities[0]}),e.appendTo($("#app-tmp")),e.trigger("click.dialog.data-api")}),$("#app-user-menu").find(".set-up").trigger("click.dialog.data-api")):(n=$('<div class="setpassword" data-destory="true" data-widget="dialog" data-dialog-type="setpassword">'),n.data("source",{user:c,token:h.setup?l.token:u,setup:h.setup}),n.appendTo($("#app-tmp")),n.trigger("click.dialog.data-api"));$(".modal-su, .modal-sp, .modal-bi").css("top",230)})),delete i.browsing_authorization,delete i.resolveData,delete i.originToken},a.cross=function(e,t,n){var r=e.session,i=r.authorization,o=r.user;if(!i){s.emit("app:page:home",!1),s.emit("app:page:usermenu",!1),s.emit("app:cross:forbidden",e.params[0],null);return}s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),r.initMenuBar||(s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id));var u=e.params[0];t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",u)})},s.on("app:cross:forbidden",function(e,t){$("#app-main").load("/static/views/forbidden.html",function(){var e=u.get("authorization"),n={options:{keyboard:!1,backdrop:!1,viewData:{cls:"modal-id"}}};t&&$(".sign-in").data("source",t.external_username),$(".sign-in").data("dialog-settings",n),$(".sign-in").trigger("click.dialog.data-api"),$(".sign-in").data("dialog-settings",null),$(".popmenu").addClass("hide");if(!e)$(".please-signin").removeClass("hide"),$(".modal-id").css("top",260);else{var r=u.get("user");$(".details").removeClass("hide"),$(".details .avatar img").attr("src",r.avatar_filename),$(".details .identity-name").text(r.name),$(".please-access").removeClass("hide"),$(".modal-id").css({top:380})}})}),a.crossInvitation=function(e,t,n){var u=e.session,a=u.authorization,f=u.user,l=f&&f.id,c=e.params[0],h=e.params[1];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!!a),a&&(s.emit("app:usermenu:updatenormal",f),s.emit("app:usermenu:crosslist",a.token,a.user_id)),i.request("getInvitationByToken",{type:"POST",resources:{cross_id:c},data:{token:h}},function(e){var n=e.invitation,i=n.identity,u=n.by_identity,h;if(l){h=r.find(f.identities,function(e){if(e.connected_user_id===i.connected_user_id&&e.id===i.id)return!0});if(h){t.redirect("/#!"+c);return}}if(i.provider==="email"){s.emit("app:cross:forbidden",c,i);return}t.render("invite.html",function(e){$("#app-main").append(e),a?($(".please-access").removeClass("hide"),$(".form-horizontal").addClass("fh-left"),$(".details").removeClass("hide"),$(".details .avatar img").attr("src",f.avatar_filename),$(".details .identity-name").text(f.name)):$(".please-signin").removeClass("hide"),$(".invite-to").find("img").attr("src",i.avatar_filename).parent().next().text(o.printExtUserName(i)),$(".invite-from").find("img").attr("src",u.avatar_filename).parent().next().text(o.printExtUserName(u));var t=$(".x-invite").find(".redirecting"),n=t.next(),r=!1;$(".xbtn-authenticate").on("click",function(e){e.stopPropagation(),e.preventDefault();if(r)return;var i=$(this).data("oauth");$.ajax({url:"/OAuth/Authenticate?provider="+i,type:"POST",dataType:"JSON",data:{refere:window.location.href},beforeSend:function(e){r=!0,n.addClass("hide"),t.removeClass("hide")},success:function(e){r=!1;var i=e.meta.code;i===200?window.location.href=e.response.redirect:(t.addClass("hide"),n.removeClass("hide"))}})})})},function(e){e.meta.code===404&&t.location("/404")})},a.crossToken=function(e,t,n){var r=e.session,o=r.authorization,a=r.user,f=o&&o.token,l=e.params[0],c=e.params[1],h=u.get("cats"),p,d={},v;f&&(d.token=f),h&&(p=h[l]),p?v={cross_access_token:p}:v={invitation_token:l},i.request("getCrossByInvitationToken",{type:"POST",params:d,data:v},function(e){function m(){t.render("x.html",function(e){$("#app-main").empty().append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",null,i,f,v,p,!!c)})}var n=e.authorization,i=e.browsing_identity,o=e.action,f=e.cross,d=e.cross_access_token,v=e.read_only;!1===v&&d&&(h||(h={}),h[l]=d,u.set("cats",h)),s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0);if(n||!i){if(!r.initMenuBar){if(n){s.once("app:user:signin:after",function(){t.redirect("/#!"+f.id)}),s.emit("app:user:signin",n.token,n.user_id);return}t.redirect("/#!"+f.id)}}else i&&s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:{identities:[i],name:i.name},action:o,setup:o==="setup",originToken:l,tokenType:"cross",page:"cross",readOnly:v},"browsing_identity");m()},function(e){e.meta.code===404&&t.location("/404")})},a.profile=function(e,t,n){var r=e.session,i=r.authorization,a=r.user,f=r.browsing_authorization,l=r.browsing_user,c=r.action,h=r.oauth;s.emit("app:page:home",!1);var p=e.params[2],d=p&&p.match(o.tokenRegExp),v=d&&d[1];if(v&&!f){t.redirect("/#token="+v);return}i||f?(document.title="EXFE - Profile",s.emit("app:page:usermenu",!0),i&&!f?(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",i.token,i.user_id),t.render("profile.html",function(e){$("#app-main").data("event",r.event),delete r.event,$("#app-main").append(e),s.emit("app:profile:identities",a);var t=$.Deferred();t.resolve(i),s.emit("app:profile:show",t);if(h){if(h.identity_status!=="connected"){var n=$.Event("click.dialog.data-api");n.following=h.following,n.identity=h.identity,n.token=i.token,$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-destory="true"></div>').appendTo($("#app-tmp")).trigger(n)}u.remove("oauth"),delete r.oauth}else if(r.verification_token){var n=$.Event("click.dialog.data-api");$('<div id="app-oauth-resetpassword" class="hide" data-widget="dialog" data-dialog-type="setpassword" data-destory="true"></div>').data("token",r.verification_token).appendTo($("#app-tmp")).trigger(n),delete r.verification_token}})):f?($(document.body).attr("data-browsing"),s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:l,action:c,setup:c==="INPUT_NEW_PASSWORD",originToken:r.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete r.originToken,t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",l);var t=$.Deferred();t.resolve(f),s.emit("app:profile:show",t)})):t.redirect("/")):t.redirect("/")},a.invalid=function(e,t,n){var r=e.session,i=r.authorization,o=r.user;document.title="EXFE - Invalid Link",s.emit("app:page:home",!1),i?(s.emit("app:page:usermenu",!0),s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id)):s.emit("app:page:usermenu",!1),t.render("invalid.html",function(e){$("#app-main").append(e)})},a.signout=function(e,t,n){u.remove("cats"),u.remove("user"),u.remove("authorization"),window.location.href="/"},a.refreshAuthUser=function(e,t,n){var r=e.session,i=r.authorization;if(!i){n();return}s.emit("app:api:getuser",i.token,i.user_id,function(e){var t=e.user;u.set("user",r.user=t);if(0===t.identities.length){a.signout();return}n()},function(e){e&&e.meta&&e.meta.code===401&&(u.remove("user"),u.remove("authorization"),delete r.user,delete r.authorization),n()})}});