define("routes",function(a,b,c){function j(a,b){function e(a,b){var c=g.printExtUserName(a.default_identity);b.redirect("/#"+c)}var c=a.session,d=h.get("user");if(d){e(d,b);return}var i=c.authorization;f.emit("app:user:signin",i.token,i.user_id,!0)}var d=a("rex"),e=a("api"),f=a("bus"),g=a("util"),h=a("store");a("user");var i=c.exports={};i.index=function(a,b,c){if(a.session.authorization){j(a,b);return}f.emit("app:page:home",!0),b.render("index.html",function(b){var c=$("#app-main");c.append(b);var d=c.find("div.page-main"),e=$('<img class="exfe-toy" id="js-exfe-toy" src="/static/img/exfe.png" alt="" />');d.append(e),e.load(function(){$.ajax({dataType:"script",cache:!0,url:"/static/js/home/0.0.1/home.js?t="+a.app.set("timestamp")})})})},i.gather=function(a,b,c){var d=a.session;f.emit("app:page:home",!1);if(!d.initMenuBar){var e=d.authorization,g=d.user;f.emit("app:page:usermenu",!!e),e&&(d.initMenuBar=!0,f.emit("app:usermenu:updatenormal",g),f.emit("app:usermenu:crosslist",e.token,e.user_id))}b.render("x.html",function(a){$("#app-main").append(a),f.emit("xapp:cross:main"),f.emit("xapp:cross",0)})},i.resolveToken=function(a,b,c){a.origin="resolveToken";var d=a.params[0];f.emit("app:page:home",!1),f.emit("app:page:usermenu",!0),d?c():b.redirect("/#invalid/token="+d)},i.resolveRequest=function(a,b,c){var d=a.session,i=a.params[0],j=d.authorization,k=d.user,l,m,n,o=0,p,q=e.request("resolveToken",{type:"POST",data:{token:i}},function(a){m=a.token_type,n=a.action,p=a.user_name,d.browsing_authorization=l=a,d.originToken=i,j&&j.token===a.token&&j.user_id===a.user_id?(o=0,delete d.browsing_authorization,delete d.originToken):!j&&m==="VERIFY"&&n==="VERIFIED"?(h.set("authorization",j=d.authorization=d.browsing_authorization),delete d.browsing_authorization,delete d.originToken,o=1):j&&m==="VERIFY"&&n==="VERIFIED"?o=2:!j&&m==="VERIFY"&&n==="INPUT_NEW_PASSWORD"?o=3:j&&m==="VERIFY"&&n==="INPUT_NEW_PASSWORD"?o=4:!j&&m==="SET_PASSWORD"?o=5:j&&m==="SET_PASSWORD"?o=6:o=7,d.resolveTab=o,f.emit("app:api:getuser",a.token,a.user_id,function(b){if(o===0||o===1)h.set("user",k=d.user=b.user),f.emit("app:usermenu:updatenormal",k),f.emit("app:usermenu:crosslist",j.token,j.user_id);else{d.browsing_user=b.user;var e=g.printExtUserName(b.user.default_identity),l="";j?l="/#"+e+"/token="+i:l="/#"+e,f.emit("app:usermenu:updatebrowsing",{normal:k,browsing:b.user,action:n,setup:n==="INPUT_NEW_PASSWORD",originToken:i,tokenType:"user",page:"resolve",readOnly:!0,user_name:p,forward:l},"browsing_identity")}c()})},function(){b.redirect("/#invalid/token="+i)})},i.resolveShow=function(a,b,c){var d=a.session,e=d.resolveTab,f;switch(e){case 0:case 1:case 2:case 3:case 4:f="identity_verified.html",b.render(f,function(a){var c=$("#app-main");c.append(a),e===0||e===1?(c.find(".tab01").removeClass("hide"),c.find(".tab01 > p").animate({opacity:0},2333,function(){b.redirect("/")})):e===2?($("#app-browsing-identity").trigger("click.data-api"),$(".modal-bi").css("top",200)):e===3?($("#app-user-menu").find(".set-up").trigger("click.dialog.data-api"),$(".modal-su").css("top",200)):($("#app-user-menu").find(".set-up").trigger("click.dialog.data-api"),$(".modal-su").css("top",200))});break;case 5:case 6:f="forgot_password.html",b.render(f,function(a){var b=$("#app-main");b.append(a),$("#app-user-menu").find(".set-up").trigger("click.dialog.data-api"),$(".modal-su").css("top",230)});break;default:}},i.cross=function(a,b,c){var d=a.session,e=d.authorization,g=d.user;if(!e){f.emit("app:page:home",!1),f.emit("app:page:usermenu",!1),f.emit("app:cross:forbidden",a.params[0]);return}f.emit("app:page:home",!1),f.emit("app:page:usermenu",!0),d.initMenuBar||(f.emit("app:usermenu:updatenormal",g),f.emit("app:usermenu:crosslist",e.token,e.user_id));var h=a.params[0];b.render("x.html",function(a){$("#app-main").append(a),f.emit("xapp:cross:main"),f.emit("xapp:cross",h)})},f.on("app:cross:forbidden",function(a){$("#app-main").load("/static/views/forbidden.html",function(){var a=h.get("authorization");if(!a){$(".please-signin").removeClass("hide");var b=$("#app-signin a").clone().addClass("hide"),c={options:{keyboard:!1,backdrop:!1,viewData:{cls:"mblack modal-id"}}};$(".sign-in").data("dialog-settings",c),$(".sign-in").trigger("click.dialog.data-api"),$(".sign-in").data("dialog-settings",null),$(".popmenu").addClass("hide"),$(".modal-id").css("top",260)}})}),i.crossInvitation=function(a,b,c){var d=a.session,h=d.authorization,i=d.user,j=i&&i.id,k=a.params[0],l=a.params[1];f.emit("app:page:home",!1),f.emit("app:page:usermenu",!0),h&&(f.emit("app:usermenu:updatenormal",i),f.emit("app:usermenu:crosslist",h.token,h.user_id)),e.request("getInvitationByToken",{type:"POST",resources:{cross_id:k},data:{token:l}},function(a){var c=a.invitation,d=c.identity,e=c.by_identity;if(j===d.connected_user_id){b.redirect("/#!"+k);return}b.render("invite.html",function(a){$("#app-main").append(a),$(".invite-to").find("img").attr("src",d.avatar_filename).next().text(g.printExtUserName(d)),$(".invite-from").find("img").attr("src",e.avatar_filename).next().text(g.printExtUserName(e));var b=$(".x-invite").find(".redirecting"),c=b.next(),f=!1;$(".xbtn-authenticate").on("click",function(a){if(f)return;$.ajax({url:"/OAuth/twitterAuthenticate",dataType:"JSON",beforeSend:function(a){f=!0,c.addClass("hide"),b.removeClass("hide")},success:function(a){f=!1;var d=a.meta.code;d===200?window.location.href=a.response.redirect:(b.addClass("hide"),c.removeClass("hide"))}})})})})},i.crossToken=function(a,b,c){var d=a.session,g=d.authorization,h=d.user,i=g&&g.token,j=a.params[0],k=a.params[1],l={};i&&(l.token=i),e.request("getCrossByInvitationToken",{type:"POST",params:l,data:{invitation_token:j}},function(a){function m(){b.render("x.html",function(a){$("#app-main").append(a),f.emit("xapp:cross:main"),f.emit("xapp:cross",null,e,i,l,j,!!k)})}var c=a.authorization,e=a.browsing_identity,g=a.action,i=a.cross,l=a.read_only;f.emit("app:page:home",!1),f.emit("app:page:usermenu",!0);if(c||!e){if(!d.initMenuBar){if(c){f.once("app:user:signin:after",function(){b.redirect("/#!"+i.id)}),f.emit("app:user:signin",c.token,c.user_id);return}b.redirect("/#!"+i.id)}}else e&&f.emit("app:usermenu:updatebrowsing",{normal:h,browsing:{default_identity:e,name:e.name},action:g,setup:g==="setup",originToken:j,tokenType:"cross",page:"cross",readOnly:l},"browsing_identity");m()},function(a){window.location.href="/error/404"})},i.profile=function(a,b,c){var e=a.session,h=e.authorization,i=e.user,j=e.browsing_authorization,k=e.browsing_user,l=e.action,m=e.oauth;f.emit("app:page:home",!1);var n=a.params[2],o=n&&n.match(g.tokenRegExp),p=o&&o[1];if(p&&!j){b.redirect("/#token="+p);return}h||j?(document.title="EXFE - Profile",f.emit("app:page:usermenu",!0),h&&!j?(f.emit("app:usermenu:updatenormal",i),f.emit("app:usermenu:crosslist",h.token,h.user_id),b.render("profile.html",function(a){$("#app-main").append(a),f.emit("app:profile:identities",i);var b=$.Deferred();b.resolve(h),f.emit("app:profile:show",b);if(m&&m.identity_status!=="connected"){var c=i.identities,e=d.filter(c,function(a){if(a.id===m.identity_id)return!0})[0];$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-oauth-provider="'+m.provider+'"></div>').appendTo(document.body).trigger({type:"click",following:m.following,identity:e,token:h.token}).remove()}})):j?($(document.body).attr("data-browsing"),f.emit("app:usermenu:updatebrowsing",{normal:i,browsing:k,action:l,setup:l==="INPUT_NEW_PASSWORD",originToken:e.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete e.originToken,b.render("profile.html",function(a){$("#app-main").append(a),f.emit("app:profile:identities",k);var b=$.Deferred();b.resolve(j),f.emit("app:profile:show",b)})):b.redirect("/")):b.redirect("/")},i.invalid=function(a,b,c){var d=a.session,e=d.authorization,g=d.user;document.title="EXFE - Invalid Link",f.emit("app:page:home",!1),e?(f.emit("app:page:usermenu",!0),f.emit("app:usermenu:updatenormal",g),f.emit("app:usermenu:crosslist",e.token,e.user_id)):f.emit("app:page:usermenu",!1),b.render("invalid.html",function(a){$("#app-main").append(a)})},i.signout=function(a,b,c){h.remove("authorization"),window.location.href="/"},i.refreshAuthUser=function(a,b,c){var d=a.session,e=d.authorization;if(!e){c();return}f.emit("app:api:getuser",e.token,e.user_id,function(a){var b=a.user;h.set("user",d.user=b),c()},function(a){c()})}});