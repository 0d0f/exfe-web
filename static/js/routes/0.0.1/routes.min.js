define("routes",function(e,t,n){function a(e,t){var n=o.get("user"),r=s.printExtUserName(n.default_identity);t.redirect("/#"+r)}var r=e("api"),i=e("bus"),s=e("util"),o=e("store");e("user");var u=n.exports={};u.index=function(e,t,n){if(e.session.authorization){a(e,t);return}i.emit("app:page:home",!0),t.render("index.html",function(t){var n=$("#app-main");n.append(t);var r=n.find("div.page-main"),i=$('<img class="exfe-toy" id="js-exfe-toy" src="/static/img/exfe.png" alt="" />');r.append(i),i.load(function(){$.ajax({dataType:"script",cache:!0,url:"/static/js/home/0.0.1/home.js?t="+e.app.set("timestamp")})})})},u.gather=function(e,t,n){var r=e.session;i.emit("app:page:home",!1);if(!r.initMenuBar){var s=r.authorization,o=r.user;i.emit("app:page:usermenu",!!s),s&&(r.initMenuBar=!0,i.emit("app:usermenu:updatenormal",o),i.emit("app:usermenu:crosslist",s.token,s.user_id))}t.render("x.html",function(e){$("#app-main").append(e),i.emit("xapp:cross:main"),i.emit("xapp:cross",0)})},u.resolveToken=function(e,t,n){e.origin="resolveToken";var u=e.params[0];if(u){var a=e.session,f=a.authorization,l,c;r.request("resolveToken",{type:"POST",data:{token:u}},function(e){c=a.action=e.action,delete e.action,f?a.browsing_authorization=l=e:c==="VERIFY"?o.set("authorization",a.authorization=e):c==="INPUT_NEW_PASSWORD"&&(a.browsing_authorization=l=e),f&&l&&f.token===l.token&&f.user_id===l.user_id&&(l=null,delete a.browsing_authorization),i.emit("app:api:getuser",e.token,e.user_id,function(n){var r=n.user,i=s.printExtUserName(r.default_identity);l&&(a.browsing_user=r,i+="/token="+u),t.redirect("/#"+i)})},function(e){t.redirect("/#invalid/token="+u)})}else t.redirect("/#invalid")},u.cross=function(e,t,n){var r=e.session,s=r.authorization,o=r.user;s||t.redirect("/"),i.emit("app:page:home",!1),i.emit("app:page:usermenu",!0),r.initMenuBar||(i.emit("app:usermenu:updatenormal",o),i.emit("app:usermenu:crosslist",s.token,s.user_id));var u=e.params[0];t.render("x.html",function(e){$("#app-main").append(e),i.emit("xapp:cross:main"),i.emit("xapp:cross",u)})},u.crossToken=function(e,t,n){var s=e.session,o=s.authorization,u=s.user,a=o.token,f=e.params[0],l={};a&&(l.token=a),r.request("getCrossByInvitationToken",{type:"POST",params:l,data:{invitation_token:f}},function(e){var n=e.authorization,r=e.browsing_identity,a=e.action,l=e.cross,c=e.read_only;i.emit("app:page:home",!1),i.emit("app:page:usermenu",!0),n||!r?s.initMenuBar||(n?i.emit("app:user:signin",n.token,n.user_id):(i.emit("app:usermenu:updatenormal",u),i.emit("app:usermenu:crosslist",o.token,o.user_id))):r&&i.emit("app:usermenu:updatebrowsing",{normal:u,browsing:{default_identity:r,name:r.name},action:a,setup:a==="setup"},"browsing_identity"),t.render("x.html",function(e){$("#app-main").append(e),i.emit("xapp:cross:main"),i.emit("xapp:cross",null,r,l,c,f)})})},u.profile=function(e,t,n){var r=e.session,o=r.authorization,u=r.user,a=r.browsing_authorization,f=r.browsing_user,l=r.action;i.emit("app:page:home",!1);var c=e.params[2],h=c&&c.match(s.tokenRegExp),p=h&&h[1];if(p&&!a){t.redirect("/#token="+p);return}if(o||a)document.title="Profile",i.emit("app:page:usermenu",!0),o&&!a?(r.initMenuBar||(i.emit("app:usermenu:updatenormal",u),i.emit("app:usermenu:crosslist",o.token,o.user_id)),t.render("profile.html",function(e){$("#app-main").append(e),i.emit("app:profile:identities",u);var t=$.Deferred();t.resolve(o),i.emit("app:profile:show",t)})):a?(i.emit("app:usermenu:updatebrowsing",{normal:u,browsing:f,action:l,setup:l==="setup"},"browsing_identity"),t.render("profile.html",function(e){$("#app-main").append(e),i.emit("app:profile:identities",f);var t=$.Deferred();t.resolve(a),i.emit("app:profile:show",t)})):t.redirect("/")},u.invalid=function(e,t,n){document.title="Invalid Link",i.emit("app:page:home",!1),i.emit("app:page:usermenu",!1),t.render("invalid.html",function(e){$("#app-main").append(e)})}});