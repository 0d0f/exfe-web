define("routes",function(e,t,n){function f(e,t){function i(e,t){var n=o.printExtUserName(e.default_identity);t.redirect("/#"+n)}var n=e.session,r=u.get("user");if(r){i(r,t);return}var a=n.authorization;s.emit("app:user:signin",a.token,a.user_id,!0)}function l(){}var r=e("rex"),i=e("api"),s=e("bus"),o=e("util"),u=e("store");e("user");var a=n.exports={};a.index=function(e,t,n){if(e.session.authorization){f(e,t);return}s.emit("app:page:home",!0),t.render("index.html",function(t){var n=$("#app-main");n.append(t);var r=n.find("div.page-main"),i=$('<img class="exfe-toy" id="js-exfe-toy" src="/static/img/exfe.png" alt="" />');r.append(i),i.load(function(){$.ajax({dataType:"script",cache:!0,url:"/static/js/home/0.0.1/home.js?t="+e.app.set("timestamp")})})})},a.gather=function(e,t,n){var r=e.session;s.emit("app:page:home",!1);if(!r.initMenuBar){var i=r.authorization,o=r.user;s.emit("app:page:usermenu",!!i),i&&(r.initMenuBar=!0,s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id))}t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",0)})},a.resolveToken=function(e,t,n){e.origin="resolveToken";var r=e.params[0];if(r){var a=e.session,f=a.authorization,l,c;i.request("resolveToken",{type:"POST",data:{token:r}},function(e){c=a.action=e.action,delete e.action,f?(a.browsing_authorization=l=e,a.originToken=r):c==="VERIFY"?u.set("authorization",a.authorization=e):c==="INPUT_NEW_PASSWORD"&&(a.browsing_authorization=l=e,a.originToken=r),f&&l&&f.token===l.token&&f.user_id===l.user_id&&(l=null,delete a.browsing_authorization,delete a.originToken),s.emit("app:api:getuser",e.token,e.user_id,function(n){var i=n.user,s=o.printExtUserName(i.default_identity);l&&(a.browsing_user=i,s+="/token="+r),t.redirect("/#"+s)})},function(e){t.redirect("/#invalid/token="+r)})}else t.redirect("/#invalid")},a.cross=function(e,t,n){var r=e.session,i=r.authorization,o=r.user;if(!i){s.emit("app:page:home",!1),s.emit("app:page:usermenu",!1),s.emit("app:cross:forbidden",e.params[0]);return}s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),r.initMenuBar||(s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id));var u=e.params[0];t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",u)})},s.on("app:cross:forbidden",function(e){$("#app-main").load("/static/views/forbidden.html",function(){var e=u.get("authorization");e||$(".please-signin").removeClass("hide")})}),a.crossInvitation=function(e,t,n){var r=e.session,u=r.authorization,a=r.user,f=a&&a.id,l=e.params[0],c=e.params[1];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),u&&(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",u.token,u.user_id)),i.request("getInvitationByToken",{type:"POST",resources:{cross_id:l},data:{token:c}},function(e){var n=e.invitation,r=n.identity,i=n.by_identity;if(f===r.connected_user_id){t.redirect("/#!"+l);return}t.render("invite.html",function(e){$("#app-main").append(e),$(".invite-to").find("strong").text(o.printExtUserName(r)),$(".invite-from").find("img").attr("src",i.avatar_filename).next().text(o.printExtUserName(i));var t=$(".x-invite").find(".redirecting"),n=t.next(),s=!1;$(".xbtn-authenticate").on("click",function(e){if(s)return;$.ajax({url:"/OAuth/twitterAuthenticate",dataType:"JSON",beforeSend:function(e){s=!0,n.addClass("hide"),t.removeClass("hide")},success:function(e){s=!1;var r=e.meta.code;r===200?window.location.href=e.response.redirect:(t.addClass("hide"),n.removeClass("hide"))}})})})})},a.crossToken=function(e,t,n){var r=e.session,o=r.authorization,u=r.user,a=o&&o.token,f=e.params[0],l={};a&&(l.token=a),i.request("getCrossByInvitationToken",{type:"POST",params:l,data:{invitation_token:f}},function(e){function h(){t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",null,i,l,c,f)})}var n=e.authorization,i=e.browsing_identity,a=e.action,l=e.cross,c=e.read_only;s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0);if(n||!i){if(!r.initMenuBar){if(n){s.once("app:user:signin:after",function(){h()}),s.emit("app:user:signin",n.token,n.user_id);return}s.emit("app:usermenu:updatenormal",u),s.emit("app:usermenu:crosslist",o.token,o.user_id)}}else i&&s.emit("app:usermenu:updatebrowsing",{normal:u,browsing:{default_identity:i,name:i.name},action:a,setup:a!=="setup",originToken:f,tokenType:"cross",page:"cross"},"browsing_identity");h()})},a.profile=function(e,t,n){var i=e.session,u=i.authorization,a=i.user,f=i.browsing_authorization,l=i.browsing_user,c=i.action,h=i.oauth;s.emit("app:page:home",!1);var p=e.params[2],d=p&&p.match(o.tokenRegExp),v=d&&d[1];if(v&&!f){t.redirect("/#token="+v);return}u||f?(document.title="Profile",s.emit("app:page:usermenu",!0),u&&!f?(i.initMenuBar||(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",u.token,u.user_id)),t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",a);var t=$.Deferred();t.resolve(u),s.emit("app:profile:show",t);if(h&&h.new_identity&&!h.follow){var n=a.identities,i=r.filter(n,function(e){if(e.id===h.identity_id)return!0})[0];$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-oauth-type="'+h.type+'"></div>').appendTo(document.body).trigger({type:"click",identity:i,token:u.token,new_identity:h.new_identity}).remove()}})):f?($(document.body).attr("data-browsing"),s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:l,action:c,setup:c==="setup",originToken:i.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete i.originToken,t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",l);var t=$.Deferred();t.resolve(f),s.emit("app:profile:show",t)})):t.redirect("/")):t.redirect("/")},a.invalid=function(e,t,n){document.title="Invalid Link",s.emit("app:page:home",!1),s.emit("app:page:usermenu",!1),t.render("invalid.html",function(e){$("#app-main").append(e)})},a.signout=function(e,t,n){u.remove("authorization"),window.location.href="/"}});