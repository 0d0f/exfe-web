define("routes",function(e,t,n){function f(e,t){function i(e,t){var n=o.printExtUserName(e.default_identity);t.redirect("/#"+n)}var n=e.session,r=u.get("user");if(r){i(r,t);return}var a=n.authorization;s.emit("app:user:signin",a.token,a.user_id,!0)}var r=e("rex"),i=e("api"),s=e("bus"),o=e("util"),u=e("store");e("user");var a=n.exports={};a.index=function(e,t,n){if(e.session.authorization){f(e,t);return}s.emit("app:page:home",!0),t.render("index.html",function(t){var n=$("#app-main");n.append(t);var r=n.find("div.page-main"),i=$('<img class="exfe-toy" id="js-exfe-toy" src="/static/img/exfe.png" alt="" />');r.append(i),i.load(function(){$.ajax({dataType:"script",cache:!0,url:"/static/js/home/0.0.1/home.js?t="+e.app.set("timestamp")})})})},a.gather=function(e,t,n){var r=e.session;s.emit("app:page:home",!1);if(!r.initMenuBar){var i=r.authorization,o=r.user;s.emit("app:page:usermenu",!!i),i&&(r.initMenuBar=!0,s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id))}t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",0)})},a.resolveToken=function(e,t,n){e.origin="resolveToken";var r=e.params[0];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),r?n():t.redirect("/#invalid/token="+r)},a.resolveRequest=function(e,t,n){var r=e.session,a=e.params[0],f=r.authorization,l=r.user,c,h,p,d=0,v,m=i.request("resolveToken",{type:"POST",data:{token:a}},function(e){h=e.token_type,p=e.action,v=e.user_name,r.browsing_authorization=c=e,r.originToken=a,f&&f.token===e.token&&f.user_id===e.user_id?(d=0,delete r.browsing_authorization,delete r.originToken):!f&&h==="VERIFY"&&p==="VERIFIED"?(u.set("authorization",f=r.authorization=r.browsing_authorization),delete r.browsing_authorization,delete r.originToken,d=1):f&&h==="VERIFY"&&p==="VERIFIED"?d=2:!f&&h==="VERIFY"&&p==="INPUT_NEW_PASSWORD"?d=3:f&&h==="VERIFY"&&p==="INPUT_NEW_PASSWORD"?d=4:!f&&h==="SET_PASSWORD"?d=5:f&&h==="SET_PASSWORD"?d=6:d=7,r.resolveTab=d,s.emit("app:api:getuser",e.token,e.user_id,function(t){if(d===0||d===1)u.set("user",l=r.user=t.user),s.emit("app:usermenu:updatenormal",l),s.emit("app:usermenu:crosslist",f.token,f.user_id);else{r.browsing_user=t.user;var i=o.printExtUserName(t.user.default_identity),c="";f?c="/#"+i+"/token="+a:c="/#"+i,s.emit("app:usermenu:updatebrowsing",{normal:l,browsing:t.user,action:p,setup:p==="INPUT_NEW_PASSWORD",originToken:a,tokenType:"user",page:"resolve",readOnly:!0,user_name:v,forward:c},"browsing_identity")}n()})},function(){t.redirect("/#invalid/token="+a)})},a.resolveShow=function(e,t,n){var r=e.session,i=r.resolveTab,s;switch(i){case 0:case 1:case 2:case 3:case 4:s="identity_verified.html",t.render(s,function(e){var n=$("#app-main");n.append(e),i===0||i===1?(n.find(".tab01").removeClass("hide"),n.find(".tab01 > p").animate({opacity:0},2333,function(){t.redirect("/")})):i===2?($("#app-browsing-identity").trigger("click.data-api"),$(".modal-bi").css("top",200)):i===3?($("#app-user-menu").find(".set-up").trigger("click.dialog.data-api"),$(".modal-su").css("top",200)):($("#app-user-menu").find(".set-up").trigger("click.dialog.data-api"),$(".modal-su").css("top",200))});break;case 5:case 6:s="forgot_password.html",t.render(s,function(e){var t=$("#app-main");t.append(e),$("#app-user-menu").find(".set-up").trigger("click.dialog.data-api"),$(".modal-su").css("top",230)});break;default:}},a.cross=function(e,t,n){var r=e.session,i=r.authorization,o=r.user;if(!i){s.emit("app:page:home",!1),s.emit("app:page:usermenu",!1),s.emit("app:cross:forbidden",e.params[0]);return}s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),r.initMenuBar||(s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id));var u=e.params[0];t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",u)})},s.on("app:cross:forbidden",function(e){$("#app-main").load("/static/views/forbidden.html",function(){var e=u.get("authorization");if(!e){$(".please-signin").removeClass("hide");var t=$("#app-signin a").clone().addClass("hide"),n={options:{keyboard:!1,backdrop:!1,viewData:{cls:"mblack modal-id"}}};$(".sign-in").data("dialog-settings",n),$(".sign-in").trigger("click.dialog.data-api"),$(".sign-in").data("dialog-settings",null),$(".popmenu").addClass("hide"),$(".modal-id").css("top",260)}})}),a.crossInvitation=function(e,t,n){var r=e.session,u=r.authorization,a=r.user,f=a&&a.id,l=e.params[0],c=e.params[1];s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0),u&&(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",u.token,u.user_id)),i.request("getInvitationByToken",{type:"POST",resources:{cross_id:l},data:{token:c}},function(e){var n=e.invitation,r=n.identity,i=n.by_identity;if(f===r.connected_user_id){t.redirect("/#!"+l);return}t.render("invite.html",function(e){$("#app-main").append(e),$(".invite-to").find("img").attr("src",r.avatar_filename).next().text(o.printExtUserName(r)),$(".invite-from").find("img").attr("src",i.avatar_filename).next().text(o.printExtUserName(i));var t=$(".x-invite").find(".redirecting"),n=t.next(),s=!1;$(".xbtn-authenticate").on("click",function(e){if(s)return;$.ajax({url:"/OAuth/twitterAuthenticate",dataType:"JSON",beforeSend:function(e){s=!0,n.addClass("hide"),t.removeClass("hide")},success:function(e){s=!1;var r=e.meta.code;r===200?window.location.href=e.response.redirect:(t.addClass("hide"),n.removeClass("hide"))}})})})})},a.crossToken=function(e,t,n){var r=e.session,o=r.authorization,u=r.user,a=o&&o.token,f=e.params[0],l=e.params[1],c={};a&&(c.token=a),i.request("getCrossByInvitationToken",{type:"POST",params:c,data:{invitation_token:f}},function(e){function h(){t.render("x.html",function(e){$("#app-main").append(e),s.emit("xapp:cross:main"),s.emit("xapp:cross",null,i,a,c,f,!!l)})}var n=e.authorization,i=e.browsing_identity,o=e.action,a=e.cross,c=e.read_only;s.emit("app:page:home",!1),s.emit("app:page:usermenu",!0);if(n||!i){if(!r.initMenuBar){if(n){s.once("app:user:signin:after",function(){t.redirect("/#!"+a.id)}),s.emit("app:user:signin",n.token,n.user_id);return}t.redirect("/#!"+a.id)}}else i&&s.emit("app:usermenu:updatebrowsing",{normal:u,browsing:{default_identity:i,name:i.name},action:o,setup:o==="setup",originToken:f,tokenType:"cross",page:"cross",readOnly:c},"browsing_identity");h()},function(e){window.location.href="/error/404"})},a.profile=function(e,t,n){var i=e.session,u=i.authorization,a=i.user,f=i.browsing_authorization,l=i.browsing_user,c=i.action,h=i.oauth;s.emit("app:page:home",!1);var p=e.params[2],d=p&&p.match(o.tokenRegExp),v=d&&d[1];if(v&&!f){t.redirect("/#token="+v);return}u||f?(document.title="Profile",s.emit("app:page:usermenu",!0),u&&!f?(s.emit("app:usermenu:updatenormal",a),s.emit("app:usermenu:crosslist",u.token,u.user_id),t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",a);var t=$.Deferred();t.resolve(u),s.emit("app:profile:show",t);if(h&&h.identity_status!=="connected"){var n=a.identities,i=r.filter(n,function(e){if(e.id===h.identity_id)return!0})[0];$('<div id="app-oauth-welcome" class="hide" data-widget="dialog" data-dialog-type="welcome" data-oauth-provider="'+h.provider+'"></div>').appendTo(document.body).trigger({type:"click",following:h.following,identity:i,token:u.token}).remove()}})):f?($(document.body).attr("data-browsing"),s.emit("app:usermenu:updatebrowsing",{normal:a,browsing:l,action:c,setup:c==="INPUT_NEW_PASSWORD",originToken:i.originToken,tokenType:"user",page:"profile"},"browsing_identity"),delete i.originToken,t.render("profile.html",function(e){$("#app-main").append(e),s.emit("app:profile:identities",l);var t=$.Deferred();t.resolve(f),s.emit("app:profile:show",t)})):t.redirect("/")):t.redirect("/")},a.invalid=function(e,t,n){var r=e.session,i=r.authorization,o=r.user;document.title="Invalid Link",s.emit("app:page:home",!1),i?(s.emit("app:page:usermenu",!0),s.emit("app:usermenu:updatenormal",o),s.emit("app:usermenu:crosslist",i.token,i.user_id)):s.emit("app:page:usermenu",!1),t.render("invalid.html",function(e){$("#app-main").append(e)})},a.signout=function(e,t,n){u.remove("authorization"),window.location.href="/"},a.refreshAuthUser=function(e,t,n){var r=e.session,i=r.authorization;if(!i){n();return}s.emit("app:api:getuser",i.token,i.user_id,function(e){var t=e.user;u.set("user",r.user=t),n()},function(e){n()})}});