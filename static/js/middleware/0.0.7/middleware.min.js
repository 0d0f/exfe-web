define("middleware",function(e,t,n){function a(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n}var r=e("api"),i=e("bus"),s=e("store"),o=e("jquery"),u=n.exports={};u.basicAuth=function(e,t,n){u.FixedFaceBookURL(e,t,n);var r=e.session,i=s.get("authorization"),o=s.get("user"),f=a();i&&!f?(r.authorization=i,r.user=o):!i&&f&&f.authorization&&f.data&&!f.event?(s.set("oauth",r.oauth={identity:f.data.identity,following:f.data.identity.provider==="twitter"?!!f.data.twitter_following:!1,identity_status:f.data.identity_status}),delete r.user,s.remove("user"),s.set("authorization",r.authorization=f.authorization)):i&&f&&f.authorization&&f.data&&!f.event&&(i.user_id===f.authorization.user_id&&i.token!==f.authorization.token?(i.token=f.authorization.token,s.set("authorization",r.authorization=i)):i.user_id!==f.authorization.user_id&&i.token!==f.authorization.token&&f.identity&&(s.set("oauth",r.oauth={identity:f.data.identity,following:f.data.identity.provider==="twitter"?!!f.data.twitter_following:!1,identity_status:f.data.identity_status}),delete r.user,s.remove("user"),s.set("authorization",r.authorization=f.authorization))),f&&(f.event&&(r.event=JSON.parse(f.event),r.event.data=f.data),f.verification_token&&(r.verification_token=f.verification_token),f.refere&&f.refere!==window.location.protocol+"//"+window.location.hostname+"/"&&(window.location.href=f.refere||"/")),n()},u.errorHandler=function(e,t,n){var r=/^\/404/;if(r.exec(window.location.pathname)){i.emit("app:page:home",!1,!0);var o=s.get("authorization");i.emit("app:page:usermenu",!!o);if(o){var u=s.get("user");i.emit("app:usermenu:updatenormal",u),i.emit("app:usermenu:crosslist",o.token,o.user_id)}return}t.location("/404")},u.cleanupAppTmp=function(e,t,n){var r=o("#app-tmp"),i=r.find("[data-widget-id]");i.trigger("destory.widget"),n()},u.FixedFaceBookURL=function(e,t,n){window.location.hash==="#_=_"&&(window.location.hash="",e.updateUrl())}});