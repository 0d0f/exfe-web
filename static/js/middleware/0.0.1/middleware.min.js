define("middleware",function(e,t,n){function u(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n}var r=e("api"),i=e("bus"),s=e("store"),o=n.exports={};o.basicAuth=function(e,t,n){var r=e.session,i=s.get("authorization"),o=s.get("user"),a=u();i&&!a?(r.authorization=i,r.user=o):!i&&a?(s.set("authorization",r.authorization=a.authorization),s.set("user",r.user=null),s.set("oauth",r.oauth={type:a.type,following:a.following,identity_id:a.identity_id})):i&&a&&i.token!==a.authorization.token&&i.user_id!==a.authorization.user_id&&(s.set("oauth",r.oauth={type:a.type,following:a.following,identity_id:a.identity_id}),s.set("user",r.user=null),s.set("authorization",r.authorization=a.authorization)),n()},o.errorHandler=function(e,t,n){t.redirect("/404")}});