define("middleware",function(e,t,n){function u(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n}var r=e("api"),i=e("bus"),s=e("store"),o=n.exports={};o.basicAuth=function(e,t,n){var r=e.session,i=s.get("authorization"),o=s.get("user"),a=u();i&&!a?(r.authorization=i,r.user=o):!i&&a?(s.set("oauth",r.oauth={type:a.type,provider:a.provider,following:a.provider==="twitter"?a.twitter_following:!1,identity_id:a.identity_id,identity_status:a.identity_status}),delete r.user,s.remove("user"),s.set("authorization",r.authorization=a.authorization)):i&&a&&i.token!==a.authorization.token&&i.user_id!==a.authorization.user_id&&(s.set("oauth",r.oauth={type:a.type,provider:a.provider,following:a.provider==="twitter"?a.twitter_following:!1,identity_id:a.identity_id,identity_status:a.identity_status}),delete r.user,s.remove("user"),s.set("authorization",r.authorization=a.authorization)),n()},o.errorHandler=function(e,t,n){var r=/^\/404/;if(r.exec(window.location.pathname)){i.emit("app:page:home",!1,!0);var o=s.get("authorization");i.emit("app:page:usermenu",!!o);if(o){var u=s.get("user");i.emit("app:usermenu:updatenormal",u),i.emit("app:usermenu:crosslist",o.token,o.user_id)}return}t.redirect("/404")}});