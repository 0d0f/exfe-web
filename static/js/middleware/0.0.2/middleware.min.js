define("middleware",function(a,b,c){function h(){var a=document.getElementsByTagName("head")[0],b=document.getElementsByName("authorization")[0],c=null;return b&&(c=JSON.parse(b.content),a.removeChild(b)),c}var d=a("api"),e=a("bus"),f=a("store"),g=c.exports={};g.basicAuth=function(a,b,c){var d=a.session,e=f.get("authorization"),g=f.get("user"),i=h();e&&!i?(d.authorization=e,d.user=g):!e&&i?(f.set("oauth",d.oauth={type:i.type,provider:i.provider,following:i.provider==="twitter"?i.twitter_following:!1,identity_id:i.identity_id,identity_status:i.identity_status}),delete d.user,f.remove("user"),f.set("authorization",d.authorization=i.authorization)):e&&i&&e.token!==i.authorization.token&&e.user_id!==i.authorization.user_id&&(f.set("oauth",d.oauth={type:i.type,provider:i.provider,following:i.provider==="twitter"?i.twitter_following:!1,identity_id:i.identity_id,identity_status:i.identity_status}),delete d.user,f.remove("user"),f.set("authorization",d.authorization=i.authorization)),c()},g.errorHandler=function(a,b,c){b.redirect("/error/404")}});