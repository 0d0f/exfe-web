define("middleware",function(e,t,n){function a(){var e=document.getElementsByTagName("head")[0],t=document.getElementsByName("authorization")[0],n=null;return t&&(n=JSON.parse(t.content),e.removeChild(t)),n}var r=e("api"),i=e("bus"),s=e("store"),o=e("jquery"),u=n.exports={};u.basicAuth=function(e,t,n){var r=e.session,i=s.get("authorization"),o=s.get("user"),u=a();i&&!u?(r.authorization=i,r.user=o):!i&&u?(s.set("oauth",r.oauth={provider:u.provider,following:u.provider==="twitter"?u.twitter_following:!1,identity_id:u.identity_id,identity_status:u.identity_status}),delete r.user,s.remove("user"),s.set("authorization",r.authorization=u.authorization)):i&&u&&(i.user_id===u.authorization.user_id&&i.token!==u.authorization.token?(i.token=u.authorization.token,s.set("authorization",i)):i.user_id!==u.authorization.user_id&&i.token!==u.authorization.token&&(s.set("oauth",r.oauth={provider:u.provider,following:u.provider==="twitter"?u.twitter_following:!1,identity_id:u.identity_id,identity_status:u.identity_status}),delete r.user,s.remove("user"),s.set("authorization",r.authorization=u.authorization))),u&&u.callback!==window.location.protocol+"//"+window.location.hostname&&(window.location.href=u.callback),n()},u.errorHandler=function(e,t,n){var r=/^\/404/;if(r.exec(window.location.pathname)){i.emit("app:page:home",!1,!0);var o=s.get("authorization");i.emit("app:page:usermenu",!!o);if(o){var u=s.get("user");i.emit("app:usermenu:updatenormal",u),i.emit("app:usermenu:crosslist",o.token,o.user_id)}return}t.location("/404")},u.cleanupAppTmp=function(e,t,n){var r=o("#app-tmp"),i=r.find("[data-widget-id]");i.trigger("destory.widget"),n()}});