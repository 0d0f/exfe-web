define(function(e,t,n){var r=e("api"),i=e("bus"),s=e("store"),o=e("config"),u=e("odof"),a=e("middleware"),f=e("handlebars"),l=e("lightsaber"),c=l();c.on("launch",function(){console.log("app launch")}),c.on("launched",function(){console.log("app launched")}),c.use(a.basicAuth),c.set("timestamp",o.timestamp),c.set("view cache",!0),c.set("view engine",f),c.set("views","/static/views");var h=0;i.on("xapp:goto_home",function(e){0===h++&&(c.response.redirect("/","EXFE.COM",{id:"home"}),e&&e(),h=0)});var p="xapp:goto_profile";i.on(p,function(){if(c.request.url!=="/")return;var e=s.get("last_external_id");c.response.redirect("/#"+e,"Profile",{id:"profile"})}),i.on("xapp:home_profile",function(){c.response.loginable=!0,i.emit(p)}),c.get("/",function(e,t,n){if(t.loginable)return;$("#js-signin").show(),$(document).find("head").eq(0).append('<link rel="stylesheet" type="text/css" href="/static/_css/home.css?t='+o.timestamp+'" />'),t.render("index.html",function(e){$('.container > div[role="main"]').html(""),$("#home").append(e)})}),c.get("/#!token=:token",function(e,t,n){var o=s.get("signin"),u=o&&o.token||!1,a=e.params.token||!1,f;if(!a)return;f={},u&&(f.token=u),$('.container > div[role="main"]').html(""),$("#home").html(""),r.request("getCrossByInvitationToken",{type:"POST",params:f,data:{invitation_token:a}},function(t){var r=t.signin,o=t.browsing_identity,u="xapp:usertoken";r?(s.set("signin",r),i.emit(u,r.token,r.user_id,2)):o&&(console.log(o),createUserPanel(o,1)),e._data=t,n()})},function(e,t,n){var r=e._data,s=r.cross,o=r.browsing_identity,u=r.read_only;delete e._data,t.render("x.html",function(e){$('.container > div[role="main"]').append(e),i.emit("xapp:cross:main"),i.emit("xapp:cross",null,o,s,u)})}),c.param("crossId",function(e,t,n,r){r!=="0"?n():n(new Error("crossId fail"))}),c.get("/#!:crossId",function(e,t,n){var r=e.params.crossId;$('.container > div[role="main"]').html(""),$("#home").html(""),t.render("x.html",function(e){$('.container > div[role="main"]').append(e),i.emit("xapp:cross:main"),i.emit("xapp:cross",+r)})}),c.param("token",function(e,t,n,r){r.match(/^[a-zA-Z0-9]{32}$/)?n():n(new Error("invalid token"))}),c.get("/#gather",function(e,t,n){$('.container > div[role="main"]').html(""),$("#home").html(""),t.render("x.html",function(e){$('.container > div[role="main"]').append(e),i.emit("xapp:cross:main"),i.emit("xapp:cross",0),n()})}),c.get(/^\/#([^@\/\s\!]+)@([^@\/\s\.]+)/,function(e,t,n){$("#home").html(""),t.render("profile.html",function(e){$('.container > div[role="main"]').empty().append(e),n()})},function(e,t,n){var r=s.get("user");i.emit("app:signinsuccess",r);var o=$.Deferred(),u=s.get("signin");o.resolve(u),i.emit("app:signinothers",o)}),c.run(),$(document.body).on("click.xapp",'[href^="/#"]',function(e){i.emit("xapp:cross:end");var t=$(e.currentTarget),n=t.attr("href");if(n==="/#gather")c.response.redirect(n,"Gather a X",{id:"gather0"});else if(2===n.indexOf("!"))c.response.redirect(n,"Cross",{id:"cross"+n.substr(2)});else{var r=s.get("last_external_id");c.response.redirect("/#"+r,"Profile",{id:"profile"})}e.stopPropagation(),e.preventDefault()})});