define(function(e,t,n){var r=e("bus"),i=e("store"),s=e("config"),o=e("odof"),u=e("middleware"),a=e("handlebars"),f=e("lightsaber"),l=f();l.use(u.basicAuth),l.set("timestamp",s.timestamp),l.set("view cache",!0),l.set("view engine",a),l.set("views","/static/views");var c=0;r.on("xapp:goto_home",function(e){0===c++&&(l.response.redirect("/","EXFE.COM",{id:"home"}),e&&e(),c=0)});var h="xapp:goto_profile";r.on(h,function(){if(l.request.url!=="/")return;var e=i.get("last_external_id");l.response.redirect("/#"+e,"Profile",{id:"profile"})}),r.on("xapp:home_profile",function(){l.response.loginable=!0,r.emit(h)}),l.get("/",function(e,t,n){if(t.loginable)return;$("#js-signin").show(),$(document).find("head").eq(0).append('<link rel="stylesheet" type="text/css" href="/static/_css/home.css?t='+s.timestamp+'" />'),t.render("index.html",function(e){$('.container > div[role="main"]').html(""),$("#home").append(e)})}),l.get("/#!token=:token",function(e,t,n){var s=i.get("signin"),o=s&&s.token||!1,u=e.params.token||!1,a;if(!u)return;a={},o&&(a.token=o),$('.container > div[role="main"]').html(""),$("#home").html(""),Api.request("getCrossByInvitationToken",{type:"POST",params:a,data:{invitation_token:u}},function(e){var n=e.cross,s=e.browsing_identity,o=e.signin,u=e.read_only;o&&i.set("signin",o),t.render("x.html",function(e){$('.container > div[role="main"]').append(e),r.emit("xapp:cross:main"),r.emit("xapp:cross",null,s,n,u)})},function(e){})}),l.param("crossId",function(e,t,n,r){r!=="0"?n():n(new Error("crossId fail"))}),l.get("/#!:crossId",function(e,t,n){var i=e.params.crossId;$('.container > div[role="main"]').html(""),$("#home").html(""),t.render("x.html",function(e){$('.container > div[role="main"]').append(e),r.emit("xapp:cross:main"),r.emit("xapp:cross",+i)})}),l.param("token",function(e,t,n,r){r.match(/^[a-zA-Z0-9]{32}$/)?n():n(new Error("token"))}),l.get("/#gather",function(e,t,n){$('.container > div[role="main"]').html(""),$("#home").html(""),t.render("x.html",function(e){$('.container > div[role="main"]').append(e),r.emit("xapp:cross:main"),r.emit("xapp:cross",0),n()})}),l.get(/^\/#([^@\/\s\!]+)@([^@\/\s\.]+)/,function(e,t,n){$("#home").html(""),t.render("profile.html",function(e){$('.container > div[role="main"]').empty().append(e),n()})},function(e,t,n){var s=i.get("user");r.emit("app:signinsuccess",s);var o=$.Deferred(),u=i.get("signin");o.resolve(u),r.emit("app:signinothers",o)}),l.run(),$(document.body).on("click.xapp",'[href^="/#"]',function(e){r.emit("xapp:cross:end");var t=$(e.currentTarget),n=t.attr("href");if(n==="/#gather")l.response.redirect(n,"Gather a X",{id:"gather0"});else if(2===n.indexOf("!"))l.response.redirect(n,"Cross",{id:"cross"+n.substr(2)});else{var s=i.get("last_external_id");l.response.redirect("/#"+s,"Profile",{id:"profile"})}e.stopPropagation(),e.preventDefault()})});