define(function(e,t,n){function m(e,t,n){var r=u.filter(n,function(t){if(t.identity.id===e)return!0})[0];return r&&r.identity.connected_user_id===t?!0:!1}var r=e("jquery"),i=e("store"),s=e("config"),o=e("handlebars"),u=e("rex"),a=e("util"),f=e("bus"),l=e("api"),c=e("moment");c.calendar={sameDay:"ha, dddd MMMM D",nextDay:"h:ssA [Tomorrow], dddd MMMM D",nextWeek:"dddd [at] LT",lastDay:"hA, dddd MMMM D",lastWeek:"hA, dddd MMMM D",sameElse:"L"},o.registerHelper("each",function(e,t){var n=t.fn,r=t.inverse,i="",s,o;if(e&&e.length)for(s=0,o=e.length;s<o;++s)e[s].__index__=s,i+=n(e[s]);else i=r(this);return i}),o.registerHelper("ifFalse",function(e,t){return o.helpers["if"].call(this,!e,t)}),o.registerHelper("avatarFilename",function(e,t){return e}),o.registerHelper("printName",function(e,t){return e||(e=t.match(/([^@]+)@[^@]+/)[1]),e}),o.registerHelper("printTime",function(e){var t=c(),n=t.format("Z"),r=e.begin_at,i=r.timezone&&/(^[\+\-]\d\d:\d\d)/.exec(r.timezone)[1]||"",s="",o="";r.date&&(s+=r.date,o+="YYYY-MM-DD"),r.time&&(s+=" "+r.time,o+=" HH:mm:ss"),(r.date||r.time)&&i&&(s+=" "+i,o+=" ZZ");var u=c(s,o),s="",a,f,l=n===i;return e.outputformat?(s=e.origin,l||(s+=" "+i),s):(r.time_word&&(s+=r.time_word+" (at) "),r.time&&(s+=r.time),!l&&i&&(s+=" ("+i+") "),r.date_word&&(s+=r.date_word+" (on) "),r.date&&(s+=" "+r.date),u&&u.year()!==1900&&u.year()!==t.year()&&(s+=" "+u.year()),s||(o?u.format(o):"Sometime"))}),o.registerHelper("printTime2",function(e,t){return e=o.helpers.crossItem.call(this,e,t),o.helpers.printTime4.call(this,e)}),o.registerHelper("printTime5",function(e){var t=o.helpers.printTime4.call(this,e);return t||"To be decided"}),o.registerHelper("printPlace",function(e){return e||"To be decided"}),o.registerHelper("printTime4",function(e){var t=c(),n=t.format("Z"),r=e.begin_at,i=r.timezone&&/(^[\+\-]\d\d:\d\d)/.exec(r.timezone)[1]||"",s="",o="",u=n===i;if(e.outputformat)return s=e.origin,u||(s+=" "+i),s;var s="",a="";r.date&&(s+=r.date,a+="YYYY-MM-DD"),r.time&&(s+=" "+r.time,a+=" HH:mm:ss"),i&&(s+=" "+i,a+=" ZZ");var f=c(s,a);return r.time&&(o+="hA "),r.date&&(o+="ddd MMM D"),o?f.format(o):"Sometime"}),o.registerHelper("printTime3",function(e,t){var n=e.begin_at;if(!n.date)return n.date_word||"";var r=n.timezone&&/(^[\+\-]\d\d:\d\d)/.exec(n.timezone)[1]||"",i="",s="";n.date&&(i+=n.date,s+="YYYY-MM-DD"),n.time&&(i+=" "+n.time,s+=" HH:mm:ss"),r&&(i+=" "+r,s+=" ZZ");var o=c(i,s);return s?o.fromNow():"Sometime"}),o.registerHelper("rsvpAction",function(e,t){var n={ACCEPTED:"Accepted",INTERESTED:"Interested",DECLINED:"Unavailable",NORESPONSE:"Pending"},r=u.filter(e,function(e){if(e.identity.id===t)return!0})[0],i="";if(r&&r.rsvp_status!=="INTERESTED"){var i='<div><i class="';i+="icon-rsvp-"+r.rsvp_status.toLowerCase()+'"></i> ',i+=n[r.rsvp_status]+": "+r.identity.name+"</div>"}var s=u.map(e,function(e){if(e.by_identity.id===t&&e.identity.id!==t)return e.identity.name}).filter(function(e){if(e)return!0}).join(", ");return i+='<div><i class="icon-invite"></i> ',i+="Invited: "+s,i+="</div>",s?i:""}),o.registerHelper("ifPlace",function(e){var t=o.helpers.crossItem.call(this,"place");return o.helpers["if"].call(this,t.length,e)}),o.registerHelper("ifOauthVerifying",function(e,t,n){var r=e==="twitter"&&t==="VERIFYING";return o.helpers["if"].call(this,r,n,n)}),o.registerHelper("makeDefault",function(e,t,n){var r=!e&&t==="CONNECTED";return o.helpers["if"].call(this,r,n,n)}),o.registerHelper("ifVerifying",function(e,t,n){var r=e==="email"&&t==="VERIFYING";return o.helpers["if"].call(this,r,n)}),o.registerHelper("atName",function(e,t){var n="";return e==="twitter"?n="@"+t:n=t,n}),o.registerHelper("editable",function(e,t,n){var r=e==="email"&&t==="CONNECTED";return o.helpers["if"].call(this,r,n)});var h=function(e){r(".user-xstats .attended").html(e.cross_quantity);var t=r("#jst-user-avatar"),n=o.compile(t.html()),i=n({avatar_filename:e.avatar_filename});r(".user-avatar").append(i),r("#profile .user-name").find("h3").html(e.name||e.nickname),r("#profile .user-name").find(".changepassword").attr("data-dialog-type",e.password?"changepassword":"setpassword").find("span").text(e.password?"Change Password...":"Set Password...");var s=r("#jst-identity-list"),n=o.compile(s.html()),a=e.default_identity;u.each(e.identities,function(e,t){e.id===a.id&&(e.__default__=!0)});var f=u.filter(e.identities,function(e){if(e.provider==="email"||e.provider==="twitter")return!0}),i=n({identities:f});r(".identity-list").append(i)},p=function(e){if(!e)return;var t=e.user_id,n=e.token;return l.request("crosslist",{params:{token:n},resources:{user_id:t}},function(e){var t=+(new Date),n=r("#jst-crosses-container");o.registerHelper("confirmed_nums",function(e){return u.filter(e,function(e){if(e.rsvp_status==="ACCEPTED")return!0}).length}),o.registerHelper("total",function(e){return e.length}),o.registerHelper("confirmed_identities",function(e){var t=u(e).filter(function(e){if(e.rsvp_status==="ACCEPTED")return!0});return u(t.slice(0,7)).map(function(e,t){return e.identity.name}).join(", ")}),o.registerPartial("jst-cross-box",r("#jst-cross-box").html());var i=o.compile(n.html()),s="",a="upcoming<Upcoming> sometime<Sometime> sevendays<Next 7 days> later<Later> past<Past>",f={};u.map(e.crosses,function(e,t){f[e.sort]||(f[e.sort]={crosses:[]}),f[e.sort].crosses.push(e)}),f.upcoming||(f.upcoming={}),f.upcoming.hasGatherAX=!0,f.upcoming.totalCrosses=e.crosses.length,f.upcoming.crosses=[],f.upcoming.crosses.push({title:"国庆吃饭",description:"终于有机会吃饭啦！",time:{begin_at:{date_word:"",date:"",time_word:"",time:"",timezone:"",id:0,type:"EFTime"},origin:"",outputformat:0,id:0,type:"CrossTime"},place:{title:"",description:"",lng:"",lat:"",provider:"",external_id:"",created_at:"2012-10-23 13:25:29 +0000",updated_at:"2012-10-23 13:25:29 +0000",id:0,type:"Place"},attribute:{state:"published"},exfee:{invitations:[{identity:{name:"daisy.cmh",nickname:"",bio:"",provider:"email",connected_user_id:-351,external_id:"daisy.cmh@gmail.com",external_username:"daisy.cmh@gmail.com",avatar_filename:"https://www.exfe.com/v2/avatar/default?name=daisy.cmh",created_at:"2012-10-03 01:17:01 +0000",updated_at:"2012-10-03 01:17:01 +0000",id:351,type:"identity"},by_identity:{name:"Leask Huang",nickname:"",bio:"",provider:"email",connected_user_id:5,external_id:"leaskh@gmail.com",external_username:"leaskh@gmail.com",avatar_filename:"http://www.gravatar.com/avatar/0b4d9df63e92a6002ce8018589aab61f",created_at:"2011-11-02 13:37:02 +0000",updated_at:"2012-09-10 08:15:50 +0000",id:5,type:"identity"},rsvp_status:"NORESPONSE",via:"",created_at:"2012-10-03 01:17:01 +0000",updated_at:"2012-10-03 01:17:01 +0000",token:"",host:!1,mates:0,id:616,type:"invitation"}]}});var l=e.more.join(" "),c=/<|>/;u.map(a.split(" "),function(e,t){e=e.split(c);var n=f[e[0]];n&&(n.cate=e[0],n.cate_date=e[1],n.hasMore=l.search(e[0])>-1,s+=i(n))}),r("#profile .crosses").append(s)})},d=function(e){if(!e)return;var t=e.user_id,n=e.token,i=new Date;i=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate();var s=l.request("crosses",{params:{token:n},resources:{user_id:t}},function(e){var n=new Date,i=e.crosses,s=[],a=[],f,l=[],h={},p=[];u.each(i,function(e,n){e.exfee&&e.exfee.invitations&&e.exfee.invitations.length&&u.each(e.exfee.invitations,function(e,r){h[e.id]=[n,r],t===e.identity.connected_user_id&&e.rsvp_status==="NORESPONSE"&&(e.__crossIndex=n,e.__identityIndex=r,s.push(e))})}),o.registerHelper("crossItem",function(e){return e==="place"?i[this.__crossIndex][e].title:e==="invitationid"?i[this.__crossIndex].exfee.invitations[this.__identityIndex].id:e==="exfeeid"?i[this.__crossIndex].exfee.id:i[this.__crossIndex][e]}),o.registerHelper("conversation_nums",function(){return this.__conversation_nums}),o.registerHelper("humanTime",function(e){return c().from(e)});if(s.length){var d=r("#jst-invitations"),v=o.compile(d.html()),m=v({crosses:s});r("#profile .gr-b .invitations").removeClass("hide").append(m)}});return s.done(g)},v=function(e){if(!e)return;var t=e.user_id,n=e.token,i=new Date,s=0;return i.setDate(i.getDate()-3),s=+i,i=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate(),l.request("crosses",{resources:{user_id:t},params:{updated_at:i,token:n}},function(e){var n=e.crosses,i;if(0===n.length)return;i=u.filter(n,function(e,n){var r=e.updated,i=!1;if(r){var o,u,a;for(o in r){if(o==="background")continue;u=r[o],a=+(new Date(u.updated_at.replace(/\-/g,"/"))),a>s?o==="exfee"?u.identity_id===e.by_identity.id||m(u.identity_id,t,e.exfee.invitations)?i|=!1:i|=!0:i|=!0:(i|=!1,r[o]=!1)}}if(i)return!0});if(0===i.length)return;var a=r("#jst-updates").html(),f=o.compile(a),l=f({updates:i});r(".siderbar.updates").append(l).removeClass("hide")})},g=function(e){if(!e)return;e=i.get("authorization");if(!e)return;var t=e.user_id,n=+r(".user-xstats > .attended").text(),o=i.get("newbie_guide:"+t);if(!o&&n<=3&&!r("#app-browsing-identity").size()){var u=document.createElement("script"),a=r("script#js-newbieguide");u.id="js-newbieguide",u.type="text/javascript",u.async=!0,u.src="/static/js/newbieguide/0.0.2/newbieguide.min.js?t="+s.timestamp,r(u).attr("data-exists",a.attr("data-exists")),a.remove();var f=document.body;f.appendChild(u)}},y=function(e){var t=i.get("iosapp_dismiss");t||r(".ios-app").removeClass("hide")};f.on("app:profile:show",function(e){e.done([p,d,v,y])}),f.on("app:profile:identities",function(e){h(e)}),f.on("app:addidentity",function(e){var t=r("#jst-identity-list"),n=o.compile(t.html()),i=n({identities:[e.identity]});r(".identity-list").append(i)});var b=r(document.body);r(function(){b.on("hover.profile",".identity-list > li",function(e){}),b.on("click.profile","i.icon-minus-sign",function(e){var t=r(this).parent().data("identity-id"),n=i.get("authorization"),s=n.token;return}),b.on("dblclick.profile",".user-name h3",function(e){var t=r.trim(r(this).html()),n=r('<input type="text" value="'+t+'" class="pull-left" />');n.data("oldValue",t),r(this).after(n).hide(),n.focusend(),r(".xbtn-changepassword").addClass("hide")}),b.on("focusout.profile keydown.profile",".user-name input",function(e){var t=e.type,n=e.keyCode;if(t==="focusout"||n===9||!e.shiftKey&&n===13){var s=r.trim(r(this).val()),o=r(this).data("oldValue");r(this).hide().prev().html(s).show(),r(this).remove(),!r(".settings-panel").data("hoverout")&&r(".xbtn-changepassword").removeClass("hide");if(!s||s===o)return;var u=i.get("authorization"),a=u.token;l.request("updateUser",{type:"POST",params:{token:a},data:{name:s}},function(e){i.set("user",e.user),f.emit("app:page:changeusername",s)})}}),b.on("dblclick.profile",".identity-list li .identity > span.identityname em",function(e){var t=r(this),n=t.parents("li"),i=n.data("provider"),s=n.data("status"),o=n.data("editable");if("twitter facebook google".indexOf(i)!==-1)n.find(".isOAuth").removeClass("hide");else if(o){var u=r.trim(t.text()),a=r('<input type="text" value="'+u+'" class="username-input" />');a.data("oldValue",u),t.after(a).hide(),a.focusend()}}),b.on("focusout.profile keydown.profile",".identity-list .username-input",function(e){var t=e.type,n=e.keyCode;if(t==="focusout"||n===9||!e.shiftKey&&n===13){var s=r.trim(r(this).val()),o=r(this).data("oldValue"),u=r(this).parents("li").data("identity-id");r(this).hide().prev().text(s).show(),r(this).remove();if(!s||s===o)return;var a=i.get("authorization"),f=a.token;l.request("updateIdentity",{params:{token:f},resources:{identity_id:u},type:"POST",data:{name:s}},function(e){var t=i.get("user");for(var n=0,r=t.identities.length;n<r;++n)if(t.identities[n].id===e.identity_id){t.identities[n]=identity;break}i.set("user",t)})}}),b.on("click.profile",".xbtn-accept",function(e){e.preventDefault(),e.stopPropagation();var t=i.get("lastIdentity"),n=r(this).parent(),s=n.data("id"),o=n.data("invitationid"),u=r('.gr-a [data-id="'+s+'"]'),a=n.data("exfeeid"),f=i.get("authorization"),c=f.token;l.request("rsvp",{params:{token:c},resources:{exfee_id:a},type:"POST",data:{rsvp:'[{"identity_id":'+t.id+', "rsvp_status": "ACCEPTED", "by_identity_id": '+t.id+"}]",by_identity_id:t.id}},function(e){var t=u.find(">div :first-child"),r=+t.text();t.text(r+1);var s=u.find(">div :last-child"),o=s.text(),a=i.get("lastIdentity");s.text(o+(o?", ":"")+a.name);var f;!n.parent().prev().length&&!n.parent().next().length&&(f=n.parents(".invitations")),n.parent().remove(),f&&f.remove()})}),b.on("click.profile.identity",".xbtn-addidentity",function(e){}),b.on("click.profile","#profile div.cross-type",function(e){e.preventDefault(),r(this).next().toggleClass("hide").next().toggleClass("hide"),r(this).find("span.arrow").toggleClass("lt rb")}),b.on("hover.profile",".changepassword",function(e){var t=e.type;r(this).data("hoverout",t==="mouseleave"),t==="mouseenter"?r(this).addClass("xbtn-changepassword"):r(this).removeClass("xbtn-changepassword")}),b.on("click.profile",".more > a",function(e){e.preventDefault();var t=r(this),n=t.parent(),s=n.data("cate"),a=i.get("authorization"),f=a.token,c=a.user_id,h=n.prev().find(" .cross-box").length,p=s;l.request("crosslist",{params:{token:f},resources:{user_id:c},data:{more_category:p,more_position:h}},function(e){if(e.crosses.length){var r="{{#crosses}}{{> jst-cross-box}}{{/crosses}}",i=o.compile(r);n.prev().append(i(e));var a=u.filter(e.more,function(e){if(e===s)return!0});a.length||t.remove()}})})}),b.on("click.profile.iosapp",".ios-app > .exfe-dismiss",function(e){e.preventDefault(),i.set("iosapp_dismiss",!0),b.off("click.profile.iosapp"),r(this).parent().fadeOut()});var w=null,E,S=null;b.on("click.data-link",".user-avatar .avatar, .identity-list > li > .avatar",function(t){var n=r(this),i=n.find("img");if(!n.parent().hasClass("editable"))return!1;var s=n.parent().data("identity-id"),o={};s&&(o.identity_id=s),o["80_80"]=i[0].src,o["80_80"]=decodeURIComponent(o["80_80"]),o["80_80"].match(/\/80_80_/)||(o["80_80"]=""),o.original=o["80_80"].replace(/80_80_/,"original_"),w||(w=e("uploader").Uploader,E=r.extend(!0,{},e("uploader").uploadSettings,{options:{onHideBefore:function(e){uploaderTarget=null,S=null}}})),S&&(S.hide(),S=null),S=(new w(E)).render(),S.show(o)})});