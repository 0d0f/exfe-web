define(function(e,t,n){var r=e("jquery"),i=e("store"),s=e("config"),o=e("handlebars"),u=e("rex"),a=e("util"),f=e("bus"),l=e("api"),c=e("moment");c.calendar={sameDay:"ha, dddd MMMM D",nextDay:"h:ssA [Tomorrow], dddd MMMM D",nextWeek:"dddd [at] LT",lastDay:"hA, dddd MMMM D",lastWeek:"hA, dddd MMMM D",sameElse:"L"},o.registerHelper("each",function(e,t){var n=t.fn,r=t.inverse,i="",s,o;if(e&&e.length)for(s=0,o=e.length;s<o;++s)e[s].__index__=s,i+=n(e[s]);else i=r(this);return i}),o.registerHelper("ifFalse",function(e,t){return o.helpers["if"].call(this,!e,t)}),o.registerHelper("avatarFilename",function(e,t){return e}),o.registerHelper("printName",function(e,t){return e||(e=t.match(/([^@]+)@[^@]+/)[1]),e}),o.registerHelper("printTime",function(e){var t=c(),n=t.format("Z"),r=e.begin_at,i=/(^[\+\-]\d\d:\d\d)/.exec(r.timezone)[1],s=c.utc(r.date+" "+r.time+" "+i,"YYYY-MM-DD HH:mm:ss Z"),o="",u,a=n===i;return e.outputformat?(o=e.origin,a||(o+=" "+i),o):(r.time_word&&(o+=r.time_word+" (at) "),o+=r.time,a||(o+=" ("+i+") "),r.date_word&&(o+=r.date_word+" (on) "),o+=" "+r.date,s.year()!==t.year()&&(o+=" "+s.year()),s.calendar())}),o.registerHelper("printTime2",function(e,t){return e=o.helpers.crossItem.call(this,e,t),o.helpers.printTime4.call(this,e)}),o.registerHelper("printTime4",function(e){var t=c(),n=t.format("Z"),r=e.begin_at,i=/(^[\+\-]\d\d:\d\d)/.exec(r.timezone)[1],s=c.utc(r.date+" "+r.time+" "+i,"YYYY-MM-DD HH:mm:ss Z"),o="",u="",a=n===i;return e.outputformat?(o=e.origin,a||(o+=" "+i),o):(r.time!=="00:00:00"&&(u+="hA "),r.date&&(u+="ddd MMM D"),s.format(u))}),o.registerHelper("printTime3",function(e,t){var n=e.begin_at,r=/(^[\+\-][\d]{2}:[\d]{2})/.exec(n.timezone)[1],i=c.utc(n.date+" "+n.time+" "+r,"YYYY-MM-DD HH:mm:ss Z");return i.fromNow()}),o.registerHelper("rsvpAction",function(e,t){var n=u.filter(e,function(e){if(e.identity.id===t)return!0})[0],r="";if(n.rsvp_status!=="INTERESTED"){var r='<div><i class="';r+="icon-rsvp-"+n.rsvp_status.toLowerCase()+'"></i> ',r+=n.rsvp_status.charAt(0)+n.rsvp_status.substr(1).toLowerCase()+": "+n.identity.name+"</div>"}var i=u.map(e,function(e){if(e.by_identity.id===t&&e.identity.id!==t)return e.identity.name}).filter(function(e){if(e)return!0}).join(", ");return r+='<div><i class="icon-invite"></i> ',r+="Invited: "+i,r+="</div>",r}),o.registerHelper("ifPlace",function(e){var t=o.helpers.crossItem.call(this,"place");return o.helpers["if"].call(this,t.length,e)}),o.registerHelper("ifOauthVerifying",function(e,t,n){var r=e==="twitter"&&t==="VERIFYING";return o.helpers["if"].call(this,r,n,n)}),o.registerHelper("makeDefault",function(e,t,n){var r=!e&&t==="CONNECTED";return o.helpers["if"].call(this,r,n,n)}),o.registerHelper("ifVerifying",function(e,t,n){var r=e==="email"&&t==="VERIFYING";return o.helpers["if"].call(this,r,n)}),o.registerHelper("atName",function(e,t){var n="";return e==="twitter"?n="@"+t:n=t,n}),o.registerHelper("editable",function(e,t,n){var r=e==="email"&&t==="CONNECTED";return o.helpers["if"].call(this,r,n)});var h=function(e){r(".user-xstats .attended").html(e.cross_quantity);var t=r("#jst-user-avatar"),n=o.compile(t.html()),i=n({avatar_filename:e.avatar_filename});r(".user-avatar").append(i),r("#profile .user-name").find("h3").html(e.external_username||e.name||e.nickname),r("#profile .user-name").find(".changepassword").attr("data-dialog-type",e.password?"changepassword":"setpassword");var s=r("#jst-identity-list"),n=o.compile(s.html()),a=e.default_identity;u.each(e.identities,function(e,t){e.id===a.id&&(e.__default__=!0)});var i=n({identities:e.identities});r(".identity-list").append(i)},p=function(e){if(!e)return;var t=e.user_id;return l.request("crosslist",{resources:{user_id:t}},function(e){var t=+(new Date),n=r("#jst-crosses-container");o.registerHelper("confirmed_nums",function(e){return u.filter(e,function(e){if(e.rsvp_status==="ACCEPTED")return!0}).length}),o.registerHelper("total",function(e){return e.length}),o.registerHelper("confirmed_identities",function(e){var t=u(e).filter(function(e){if(e.rsvp_status==="ACCEPTED")return!0});return u(t.slice(0,7)).map(function(e,t){return e.identity.name}).join(", ")}),o.registerPartial("jst-cross-box",r("#jst-cross-box").html());var i=o.compile(n.html()),s="",a="upcoming<Upcoming> sometime<Sometime> sevendays<Next 7 days> later<Later> past<Past>",f={};u.map(e.crosses,function(e,t){f[e.sort]||(f[e.sort]={crosses:[]}),f[e.sort].crosses.push(e)}),f.upcoming||(f.upcoming={}),f.upcoming.hasGatherAX=!0,f.upcoming.totalCrosses=e.crosses.length;var l=e.more.join(" "),c=/<|>/;u.map(a.split(" "),function(e,t){e=e.split(c);var n=f[e[0]];n&&(n.cate=e[0],n.cate_date=e[1],n.hasMore=l.search(e[0])>-1,s+=i(n))}),r("#profile .crosses").append(s)})},d=function(e){if(!e)return;var t=e.user_id,n=new Date;return n=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate(),l.request("crosses",{resources:{user_id:t}},function(e){var n=new Date,i=e.crosses,s=[],a=[],f,l=[],h={},p=[];u.each(i,function(e,n){e.exfee&&e.exfee.invitations&&e.exfee.invitations.length&&u.each(e.exfee.invitations,function(e,r){h[e.id]=[n,r],t===e.identity.connected_user_id&&e.rsvp_status==="NORESPONSE"&&(e.__crossIndex=n,e.__identityIndex=r,s.push(e))})}),o.registerHelper("crossItem",function(e){return e==="place"?i[this.__crossIndex][e].title:e==="invitationid"?i[this.__crossIndex].exfee.invitations[this.__identityIndex].id:e==="exfeeid"?i[this.__crossIndex].exfee.id:i[this.__crossIndex][e]}),o.registerHelper("conversation_nums",function(){return this.__conversation_nums}),o.registerHelper("humanTime",function(e){return c().from(e)});if(s.length){var d=r("#jst-invitations"),v=o.compile(d.html()),m=v({crosses:s});r("#profile .gr-b .invitations").removeClass("hide").append(m)}})},v=function(e){if(!e)return;var t=e.user_id,n=new Date;return n.setDate(n.getDate()-3),n=n.getFullYear()+"-"+(n.getMonth()+1)+"-"+n.getDate(),l.request("crosses",{resources:{user_id:t},params:{updated_at:n}},function(e){var i=e.crosses,s=[],a=[];i.length&&u.each(i,function(e,r){e.updated&&e.updated.conversation&&s.push(l.request("conversation",{resources:{exfee_id:e.exfee.id},params:{date:n}},function(n){var r=n.conversation;if(r&&r.length){var i=r[r.length-1];if(i.by_identity.connected_user_id===t)return;i.__conversation_nums=r.length,e.updated.conversation.item=i}}))});if(s.length){var f=r.when;f=f.apply(null,s),f.then(function(e){var t=r("#jst-updates").html(),n=o.compile(t),s=n({updates:i});r("#profile .ios-app").before(s)})}})},m=function(e){if(!e)return;e=i.get("signin");if(!e)return;var t=e.user_id,n=+r(".user-xstats > .attended").text(),o=i.get("newbie_guide:"+t);if(!o&&n<=3){var u=document.createElement("script");u.type="text/javascript",u.async=!0,u.src="/static/js/newbieguide/0.0.1/newbieguide.min.js?t="+s.timestamp;var a=document.body;a.appendChild(u)}},g=function(e){var t=i.get("iosapp_dismiss");t||r(".ios-app").removeClass("hide")},y="app:signinothers";f.on(y,function(e){e.then([p,d,v,g,m])});var b="app:signinsuccess";f.on(b,function(e){h(e)}),f.on("app:addidentity",function(e){var t=r("#jst-identity-list"),n=o.compile(t.html()),i=n({identities:[e.identity]});r(".identity-list").append(i)});var w=r(document.body);r(function(){w.on("hover.profile",".identity-list > li",function(e){}),w.on("click.profile","i.icon-minus-sign",function(e){var t=r(this).parent().data("identity-id"),n=i.get("signin"),s=n.token;return}),w.on("dblclick.profile",".user-name h3",function(e){var t=r.trim(r(this).html()),n=r('<input type="text" value="'+t+'" class="pull-left" />');n.data("oldValue",t),r(this).after(n).hide(),n.focusend(),r(".xbtn-changepassword").addClass("hide")}),w.on("focusout.profile keydown.profile",".user-name input",function(e){var t=e.type,n=e.keyCode;if(t==="focusout"||n===9||!e.shiftKey&&n===13){var s=r.trim(r(this).val()),o=r(this).data("oldValue");r(this).hide().prev().html(s).show(),r(this).remove(),!r(".settings-panel").data("hoverout")&&r(".xbtn-changepassword").removeClass("hide");if(!s||s===o)return;l.request("updateUser",{type:"POST",data:{name:s}},function(e){i.set("user",e.user),f.emit("app:changename",s)})}}),w.on("dblclick.profile",".identity-list li.editable .username > em",function(e){var t=r.trim(r(this).html()),n=r('<input type="text" value="'+t+'" class="username-input" />');n.data("oldValue",t),r(this).after(n).hide(),n.focusend()}),w.on("focusout.profile keydown.profile",".identity-list .username-input",function(e){var t=e.type,n=e.keyCode;if(t==="focusout"||n===9||!e.shiftKey&&n===13){var s=r.trim(r(this).val()),o=r(this).data("oldValue"),u=r(this).parent().parent().data("identity-id");r(this).hide().prev().html(s).show(),r(this).remove();if(!s||s===o)return;l.request("updateIdentity",{resources:{identity_id:u},type:"POST",data:{name:s}},function(e){var t=i.get("user");for(var n=0,r=t.identities.length;n<r;++n)if(t.identities[n].id===e.identity_id){t.identities[n]=identity;break}i.set("user",t)})}}),w.on("click.profile",".xbtn-accept",function(e){e.preventDefault(),e.stopPropagation();var t=i.get("lastIdentity"),n=r(this).parent(),s=n.data("id"),o=n.data("invitationid"),u=r('.gr-a [data-id="'+s+'"]'),a=n.data("exfeeid");l.request("rsvp",{resources:{exfee_id:a},type:"POST",data:{rsvp:'[{"identity_id":'+t.id+', "rsvp_status": "ACCEPTED", "by_identity_id": '+t.id+"}]",by_identity_id:t.id}},function(e){var t=u.find(">div :first-child"),r=+t.text();t.text(r+1);var s=u.find(">div :last-child"),o=s.text(),a=i.get("lastIdentity");s.text(o+(o?", ":"")+a.name);var f;!n.parent().prev().length&&!n.parent().next().length&&(f=n.parents(".invitations")),n.parent().remove(),f&&f.remove()})}),w.on("click.profile.identity",".xbtn-addidentity",function(e){}),w.on("click.profile","#profile div.cross-type",function(e){e.preventDefault(),r(this).next().toggleClass("hide").next().toggleClass("hide"),r(this).find("span.arrow").toggleClass("lt rb")}),w.on("hover.profile",".changepassword",function(e){var t=e.type;r(this).data("hoverout",t==="mouseleave"),t==="mouseenter"?r(this).addClass("xbtn-changepassword"):r(this).removeClass("xbtn-changepassword")}),w.on("click.profile",".more > a",function(e){e.preventDefault();var t=r(this),n=t.parent(),s=n.data("cate"),a=i.get("signin"),f=a.token,c=a.user_id,h=n.prev().find(" .cross-box").length,p=s;l.request("crosslist",{resources:{user_id:c},data:{more_category:p,more_position:h}},function(e){if(e.crosses.length){var r="{{#crosses}}{{> jst-cross-box}}{{/crosses}}",i=o.compile(r);n.prev().append(i(e));var a=u.filter(e.more,function(e){if(e===s)return!0});a.length||t.remove()}})})}),w.on("click.profile.iosapp",".ios-app > .exfe-dismiss",function(e){e.preventDefault(),i.set("iosapp_dismiss",!0),w.off("click.profile.iosapp"),r(this).parent().fadeOut()});var E=null,S,x=null;w.on("click.profile.uploader",".user-avatar .avatar, .identity-list > li > .avatar",function(t){var n=r(this),i=n.find("img");if(!n.parent().hasClass("editable"))return!1;var s=n.parent().data("identity-id"),o={};s&&(o.identity_id=s),o["80_80"]=i[0].src,o["80_80"]=decodeURIComponent(o["80_80"]),o["80_80"].match(/\/80_80_/)||(o["80_80"]=""),o.original=o["80_80"].replace(/80_80_/,"original_"),E||(E=e("uploader").Uploader,S=r.extend(!0,{},e("uploader").uploadSettings,{options:{onHideBefore:function(e){uploaderTarget=null,x=null}}})),x&&(x.hide(),x=null),x=(new E(S)).render(),x.show(o)})});