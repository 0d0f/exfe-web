define(function(e,t,n){function y(e,t,n){var r=f.filter(n,function(t){if(t.identity.id===e)return!0})[0];return r&&r.identity.connected_user_id===t?!0:!1}var r=e("jquery"),i=e("store"),s=e("config"),o=e("dialog"),u=e("xdialog").dialogs,a=e("handlebars"),f=e("rex"),l=e("util"),c=e("bus"),h=e("api"),p=e("moment");p.calendar={sameDay:"ha, dddd MMMM D",nextDay:"h:ssA [Tomorrow], dddd MMMM D",nextWeek:"dddd [at] LT",lastDay:"hA, dddd MMMM D",lastWeek:"hA, dddd MMMM D",sameElse:"L"},a.registerHelper("each",function(e,t){var n=t.fn,r=t.inverse,i="",s,o;if(e&&e.length)for(s=0,o=e.length;s<o;++s)e[s].__index__=s,i+=n(e[s]);else i=r(this);return i}),a.registerHelper("ifFalse",function(e,t){return a.helpers["if"].call(this,!e,t)}),a.registerHelper("avatarFilename",function(e,t){return e}),a.registerHelper("printName",function(e,t){return e||(e=t.match(/([^@]+)@[^@]+/)[1]),e}),a.registerHelper("printTime",function(e){var t=p(),n=t.format("Z"),r=e.begin_at,i=r.timezone&&/(^[\+\-]\d\d:\d\d)/.exec(r.timezone)[1]||"",s="",o="";r.date&&(s+=r.date,o+="YYYY-MM-DD"),r.time&&(s+=" "+r.time,o+=" HH:mm:ss"),(r.date||r.time)&&i&&(s+=" +0000",o+=" ZZ");var u=p(s,o),s="",a,f,l=n===i;return e.outputformat?(s=e.origin,l||(s+=" "+i),s||"Sometime"):(r.time_word&&(s+=r.time_word+" (at) "),r.time&&(s+=u.format("HH:mm:ss")),!l&&i&&(s+=" ("+i+") "),r.date_word&&(s+=r.date_word+" (on) "),r.date&&(s+=" "+u.format("YYYY-MM-DD")),u&&u.year()!==1900&&u.year()!==t.year()&&(s+=" "+u.year()),s||(o?u.format(o):"Sometime"))}),a.registerHelper("printTime2",function(e,t){return e=a.helpers.crossItem.call(this,e,t),a.helpers.printTime4.call(this,e)}),a.registerHelper("printTime5",function(e){var t=a.helpers.printTime4.call(this,e);return t||"To be decided"}),a.registerHelper("printPlace",function(e){return e||"To be decided"}),a.registerHelper("printTime4",function(e){var t=p(),n=t.format("Z"),r=e.begin_at,i=r.timezone&&/(^[\+\-]\d\d:\d\d)/.exec(r.timezone)[1]||"",s="",o="",u=n===i;if(e.outputformat)return s=e.origin,u||(s+=" "+i),s;var s="",a="";r.date&&(s+=r.date,a+="YYYY-MM-DD"),r.time&&(s+=" "+r.time,a+=" HH:mm:ss"),i&&(s+=" +0000",a+=" ZZ");var f=p(s,a);return r.time&&(o+="hA "),r.date&&(o+="ddd MMM D"),o?f.format(o):"Sometime"}),a.registerHelper("printTime3",function(e,t){var n=e.begin_at;if(!n.date)return n.date_word||"";var r=n.timezone&&/(^[\+\-]\d\d:\d\d)/.exec(n.timezone)[1]||"",i="",s="";n.date&&(i+=n.date,s+="YYYY-MM-DD"),n.time&&(i+=" "+n.time,s+=" HH:mm:ss"),r&&(i+=" +0000",s+=" ZZ");var o=p(i,s);return s?o.fromNow():"Sometime"}),a.registerHelper("rsvpAction",function(e,t){var n={ACCEPTED:"Accepted",INTERESTED:"Interested",DECLINED:"Unavailable",NORESPONSE:"Pending"},r=f.filter(e,function(e){if(e.identity.id===t)return!0})[0],i="";if(r&&r.rsvp_status!=="INTERESTED"){var i='<div><i class="';i+="icon-rsvp-"+r.rsvp_status.toLowerCase()+'"></i> ',i+=n[r.rsvp_status]+": "+r.identity.name+"</div>"}var s=f.map(e,function(e){if(e.by_identity.id===t&&e.identity.id!==t)return e.identity.name}).filter(function(e){if(e)return!0}).join(", ");return i+='<div><i class="icon-invite"></i> ',i+="Invited: "+s,i+="</div>",s?i:""}),a.registerHelper("ifPlace",function(e){var t=a.helpers.crossItem.call(this,"place");return a.helpers["if"].call(this,t.length,e)}),a.registerHelper("ifOauthVerifying",function(e,t,n){var r=e==="twitter"&&t==="VERIFYING",i=e==="facebook"&&t==="VERIFYING",s=r||i;return a.helpers["if"].call(this,s,n,n)}),a.registerHelper("makeDefault",function(e,t,n){var r=!e&&t==="CONNECTED";return a.helpers["if"].call(this,r,n,n)}),a.registerHelper("ifVerifying",function(e,t,n){var r=e==="email"&&t==="VERIFYING";return a.helpers["if"].call(this,r,n)}),a.registerHelper("atName",function(e){return l.printExtUserName(e)}),a.registerHelper("editable",function(e,t,n){var r=e==="email"&&t==="CONNECTED";return a.helpers["if"].call(this,r,n)});var d=function(e){r(".user-xstats .attended").html(e.cross_quantity);var t=r("#jst-user-avatar"),n=a.compile(t.html()),s=n({avatar_filename:e.avatar_filename});r(".user-avatar").append(s),r("#profile .user-name").find("h3").html(e.name||e.nickname),r("#profile .user-name").find(".changepassword").attr("data-dialog-type",e.password?"changepassword":"setpassword").find("span").text(e.password?"Change Password...":"Set Password..."),a.registerPartial("jst-identity-item",r("#jst-identity-item").html());var o=r("#jst-identity-list"),n=a.compile(o.html()),u=e.identities[0];u.__default__=!0;var l=0,c=f.filter(e.identities,function(e){e.status==="CONNECTED"&&++l;if(e.provider==="email"||e.provider==="twitter"||e.provider==="facebook")return!0});l&&r("#app-profile-addidentity").removeClass("hide");var s=n({identities:c});r(".identity-list").append(s);if(event=r("#app-main").data("event")){var p=event.action;if(p==="add_identity"){var d=event.data;function v(e,t,n){var s=i.get("authorization"),o=s.token,u=h.request("addIdentity",{type:"POST",params:{token:o},data:{external_username:e,provider:t}},function(e){var t=e.identity,s=i.get("user"),o=s.identities;o.push(t),i.set("user",s);var u=a.compile(r("#jst-identity-item").html()),f=u(e.identity);r(".identity-list").append(f),n&&n.destory()},function(i){var s=i&&i.meta;if(s&&s.code===401&&s.errorType==="authenticate_timeout"){n&&n.destory();var o=r('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');r("#app-tmp").append(o);var u=r.Event("click.dialog.data-api");u._data={callback:function(){v(e,t)}},o.trigger(u)}})}v(d.identity.external_username,d.identity.provider),r("#app-main").removeData("event")}}},v=function(e){if(!e)return;var t=e.user_id,n=e.token;return h.request("crosslist",{params:{token:n},resources:{user_id:t}},function(e){var t=+(new Date),n=r("#jst-crosses-container");a.registerHelper("confirmed_nums",function(e){var t=0,n=f.filter(e,function(e){if(e.rsvp_status==="ACCEPTED")return t+=e.mates,!0}).length||0;return n+t}),a.registerHelper("total",function(e){var t=0;return f.filter(e,function(e){if(e.rsvp_status==="ACCEPTED")return t+=e.mates,!0}),e.length+t}),a.registerHelper("confirmed_identities",function(e){var t=f(e).filter(function(e){if(e.rsvp_status==="ACCEPTED")return!0});return f(t.slice(0,7)).map(function(e,t){return e.identity.name}).join(", ")}),a.registerPartial("jst-cross-box",r("#jst-cross-box").html());var i=a.compile(n.html()),s="",o="upcoming<Upcoming> sometime<Sometime> sevendays<Next 7 days> later<Later> past<Past>",u={};f.map(e.crosses,function(e,t){u[e.sort]||(u[e.sort]={crosses:[]}),u[e.sort].crosses.push(e)}),u.upcoming||(u.upcoming={}),u.upcoming.hasGatherAX=!0,u.upcoming.totalCrosses=e.crosses.length,u.upcoming.crosses.reverse();var l=e.more.join(" "),c=/<|>/;f.map(o.split(" "),function(e,t){e=e.split(c);var n=u[e[0]];n&&(n.cate=e[0],n.cate_date=e[1],n.hasMore=l.search(e[0])>-1,s+=i(n))}),r("#profile .crosses").append(s)})},m=function(e){if(!e)return;var t=e.user_id,n=e.token,i=new Date;i=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate();var s=h.request("crosses",{params:{token:n},resources:{user_id:t}},function(e){var n=new Date,i=e.crosses,s=[],o=[],u,l=[],c={},h=[];f.each(i,function(e,n){e.exfee&&e.exfee.invitations&&e.exfee.invitations.length&&f.each(e.exfee.invitations,function(e,r){c[e.id]=[n,r],t===e.identity.connected_user_id&&e.rsvp_status==="NORESPONSE"&&(e.__crossIndex=n,e.__identityIndex=r,s.push(e))})}),a.registerHelper("crossItem",function(e){return e==="place"?i[this.__crossIndex][e].title:e==="invitationid"?i[this.__crossIndex].exfee.invitations[this.__identityIndex].id:e==="exfeeid"?i[this.__crossIndex].exfee.id:e==="identityid"?i[this.__crossIndex].exfee.invitations[this.__identityIndex].identity.id:e==="name"?i[this.__crossIndex].exfee.invitations[this.__identityIndex].identity.name:i[this.__crossIndex][e]}),a.registerHelper("conversation_nums",function(){return this.__conversation_nums}),a.registerHelper("humanTime",function(e){return p().from(e)});if(s.length){var d=r("#jst-invitations"),v=a.compile(d.html()),m=v({crosses:s});r("#profile .gr-b .invitations").removeClass("hide").append(m)}});return s.done(b)},g=function(e){if(!e)return;var t=e.user_id,n=e.token,i=new Date,s=0;return i.setDate(i.getDate()-3),s=+i,i=i.getFullYear()+"-"+(i.getMonth()+1)+"-"+i.getDate(),h.request("crosses",{resources:{user_id:t},params:{updated_at:i,token:n}},function(e){var n=e.crosses,i;if(0===n.length)return;i=f.filter(n,function(e,n){var r=e.updated,i=!1;if(r){var o,u,a;for(o in r){if(o==="background")continue;u=r[o],a=+(new Date(u.updated_at.replace(/\-/g,"/"))),a>s?o==="exfee"?u.identity_id===e.by_identity.id||y(u.identity_id,t,e.exfee.invitations)?i|=!1:i|=!0:i|=!0:(i|=!1,r[o]=!1)}}if(i)return!0});if(0===i.length)return;var o=r("#jst-updates").html(),u=a.compile(o),l=u({updates:i});r(".siderbar.updates").append(l).removeClass("hide")})},b=function(e){if(!e)return;e=i.get("authorization");if(!e)return;var t=e.user_id,n=+r(".user-xstats > .attended").text(),o=i.get("newbie_guide:"+t);if(!o&&n<=3&&!r("#app-browsing-identity").size()){var u=document.createElement("script"),a=r("script#js-newbieguide");u.id="js-newbieguide",u.type="text/javascript",u.async=!0,u.src="/static/js/newbieguide/0.0.2/newbieguide.min.js?t="+s.timestamp,r(u).attr("data-exists",a.attr("data-exists")),a.remove();var f=document.body;f.appendChild(u)}},w=function(e){var t=i.get("iosapp_dismiss");t||r(".ios-app").removeClass("hide")};c.on("app:profile:show",function(e){e.done([v,m,g,w])}),c.on("app:profile:identities",function(e){d(e)}),c.on("app:addidentity",function(e){var t=r("#jst-identity-list"),n=a.compile(t.html()),i=n({identities:[e.identity]});r(".identity-list").append(i)});var E=r(document.body);E.on("dblclick.profile",".user-name h3",function(e){var t=r.trim(r(this).html()),n=r('<input type="text" value="'+t+'" class="pull-left" />');n.data("oldValue",t),r(this).after(n).hide(),n.focusend(),r(".xbtn-changepassword").addClass("hide")}),E.on("focusout.profile keydown.profile",".user-name input",function(e){var t=e.type,n=e.keyCode;if(t==="focusout"||n===9||!e.shiftKey&&n===13){var s=r.trim(r(this).val()),o=r(this).data("oldValue");r(this).hide().prev().html(s).show(),r(this).remove(),!r(".settings-panel").data("hoverout")&&r(".xbtn-changepassword").removeClass("hide");if(!s||s===o)return;var u=i.get("authorization"),a=u.token;h.request("updateUser",{type:"POST",params:{token:a},data:{name:s}},function(e){i.set("user",e.user),c.emit("app:page:changeusername",s)})}}),E.on("dblclick.profile",".identity-list li .identity > span.identityname em",function(e){var t=r(this),n=t.parents("li"),i=n.data("provider"),s=n.data("status"),o=n.data("editable");if("twitter facebook google".indexOf(i)!==-1)n.find(".isOAuth").removeClass("hide");else if(o){var u=r.trim(t.text()),a=r('<input type="text" value="'+u+'" class="username-input" />');a.data("oldValue",u),t.after(a).hide(),a.focusend()}}),E.on("focusout.profile keydown.profile",".identity-list .username-input",function(e){var t=e.type,n=e.keyCode;if(t==="focusout"||n===9||!e.shiftKey&&n===13){var s=r.trim(r(this).val()),o=r(this).data("oldValue"),u=r(this).parents("li").data("identity-id");r(this).hide().prev().text(s).show(),r(this).remove();if(!s||s===o)return;var a=i.get("authorization"),f=a.token;h.request("updateIdentity",{params:{token:f},resources:{identity_id:u},type:"POST",data:{name:s}},function(e){var t=i.get("user");for(var n=0,r=t.identities.length;n<r;++n)if(t.identities[n].id===e.identity_id){t.identities[n]=identity;break}i.set("user",t)})}}),E.on("click.profile",".xbtn-accept",function(e){e.preventDefault(),e.stopPropagation();var t=r(this).parent(),n=t.data("id"),s=t.data("invitationid"),o=r('.gr-a [data-id="'+n+'"]'),u=t.data("exfeeid"),a=t.data("identity-id"),f=t.data("name"),l=i.get("authorization"),c=l.token;h.request("rsvp",{params:{token:c},resources:{exfee_id:u},type:"POST",data:{rsvp:'[{"identity_id":'+a+', "rsvp_status": "ACCEPTED", "by_identity_id": '+a+"}]",by_identity_id:a}},function(e){var n=o.find(">div :first-child"),r=+n.text();n.text(r+1);var i=o.find(">div :last-child"),s=i.text();i.text(s+(s?", ":"")+f);var u;!t.parent().prev().length&&!t.parent().next().length&&(u=t.parents(".invitations")),t.parent().remove(),u&&u.remove()})}),E.on("click.profile.identity",".xbtn-addidentity",function(e){}),E.on("click.profile","#profile div.cross-type",function(e){e.preventDefault(),r(this).next().toggleClass("hide").next().toggleClass("hide"),r(this).find("span.arrow").toggleClass("lt rb")}),E.on("hover.profile",".changepassword",function(e){var t=e.type;r(this).data("hoverout",t==="mouseleave"),t==="mouseenter"?r(this).addClass("xbtn-changepassword"):r(this).removeClass("xbtn-changepassword")}),E.on("click.profile",".more > a",function(e){e.preventDefault();var t=r(this),n=t.parent(),s=n.data("cate"),o=i.get("authorization"),u=o.token,l=o.user_id,c=n.prev().find(" .cross-box").length,p=s;h.request("crosslist",{params:{token:u},resources:{user_id:l},data:{more_category:p,more_position:c}},function(e){if(e.crosses.length){var r="{{#crosses}}{{> jst-cross-box}}{{/crosses}}",i=a.compile(r);n.prev().append(i(e));var o=f.filter(e.more,function(e){if(e===s)return!0});o.length||t.remove()}})}),E.on("click.profile.iosapp",".ios-app > .exfe-dismiss",function(e){e.preventDefault(),i.set("iosapp_dismiss",!0),E.off("click.profile.iosapp"),r(this).parent().fadeOut()});var S=null,x,T=null;E.on("click.data-link",".user-avatar .avatar, .identity-list > li > .avatar",function(t){var n=r(this),i=n.find("img");if(!n.parent().data("editable"))return!1;var s=n.parent().data("identity-id"),o={};s&&(o.identity_id=s),o["80_80"]=i[0].src,o["80_80"]=decodeURIComponent(o["80_80"]),o["80_80"].match(/\/80_80_/)||(o["80_80"]=""),o.original=o["80_80"].replace(/80_80_/,"original_"),S||(S=e("uploader").Uploader,x=r.extend(!0,{},e("uploader").uploadSettings,{options:{onHideBefore:function(e){uploaderTarget=null,T=null}}})),T&&(T.hide(),T=null),T=(new S(x)).render(),T.show(o)}),E.dndsortable({delay:300,wrap:!0,list:".identity-list",items:" > li",sort:function(e,t){},setData:function(e){return r(e).data("identity-id")},start:function(e){if(1===r(".settings-panel .identity-list > li").size())return!1;r(this).addClass("dragme"),r(".xbtn-addidentity").addClass("hide"),r(".identities-trash").removeClass("hide over")},end:function(){r(this).removeClass("dragme"),r(".xbtn-addidentity").removeClass("hide"),r(".identities-trash").addClass("hide over")},change:function(e){}}),E.on("dragenter.profile",".trash-overlay",function(e){return r(this).parent().addClass("over"),r(".icon24-trash").addClass("icon24-trash-red"),!1}),E.on("dragover.profile",".trash-overlay",function(e){return e.stopPropagation(),e.preventDefault(),!1}),E.on("dragleave.profile",".trash-overlay",function(e){return r(this).parent().removeClass("over"),r(".icon24-trash").removeClass("icon24-trash-red"),!1}),E.data("trash-overlay-deletable",!0),E.on("drop.profile",".trash-overlay",function(e){function o(e){var t=i.get("authorization"),n=t.token,s=h.request("deleteIdentity",{type:"POST",params:{token:n},data:{identity_id:e}},function(t){var n=i.get("user"),s=n.identities;f.some(s,function(t,n){if(t.id===e)return s.splice(n,1),!0}),i.set("user",n),r('.identity-list > li[data-identity-id="'+e+'"]').remove();var o=0;f.each(s,function(e){e.status==="CONNECTED"&&++o}),o||r("#app-profile-addidentity").addClass("hide")},function(t){var n=t&&t.meta;if(n&&n.code===401&&n.errorType==="authenticate_timeout"){var i=r('<div data-widget="dialog" data-dialog-type="authentication" data-destory="true" class="hide"></div>');r("#app-tmp").append(i);var s=r.Event("click.dialog.data-api");s._data={callback:function(){o(e)}},i.trigger(s)}});s.always(function(){E.data("trash-overlay-deletable",!0)})}var t=E.data("trash-overlay-deletable");if(!t)return;E.data("trash-overlay-deletable",!1),e.stopPropagation(),e.preventDefault();var n=e.originalEvent.dataTransfer,s=+n.getData("text/plain");return r(this).parent().removeClass("over"),r(".icon24-trash").removeClass("icon24-trash-red"),o(s),!1})});