define("user",function(e,t,n){function m(e,t){if(t){t===1?r(".user-name > span").addClass("browsing-identity").text(e.name||e.nickname):t===2&&r(".user-name > span").removeClass("browsing-identity").text(e.name||e.nickname),r("#js-signin").hide();var n=r(".nav li.dropdown").remove("user").show();f.registerHelper("_external_username",function(e,t){return t==="twitter"&&(e="@"+e),e});var i=f.compile(g[t]);n.find(".dropdown-wrapper").find(".user-panel").remove(),r(i(e)).appendTo(n.find(".dropdown-wrapper"))}}var r=e("jquery"),i=e("rex"),s=e("api"),o=e("bus"),u=e("util"),a=e("store"),f=e("handlebars"),l=u.tokenRegExp,c="xapp:crosstoken";o.on(c,function(e){m(e,1);var t=r("#user-name");t.attr("href",window.location.hash)});var h="xapp:usertoken";o.on(h,function(e,t,n){var r;s.setToken(e),a.set("signin",{token:e,user_id:t}),r=s.request("getUser",{resources:{user_id:t}},function(e){var t=a.get("last_external_username"),n;t&&(n=i.filter(e.user.identities,function(e){var n=e.external_username;e.provider==="twitter"&&(n="@"+n);if(t===n)return!0})[0]),n||(n=e.user.default_identity),a.set("user",e.user),a.set("lastIdentity",n);var r=n.external_username;n.provider==="twitter"&&(r="@"+r),a.set("last_external_username",r),window.location.hash.match(/^\/?#?$/)&&(alert(2),window.location.href="/#"+r)}),r.done(function(e){o.emit(d,n,r)})});var p="xapp:userstatus";o.on(p,function(e){switch(e.type){case 2:var t=e.token,n=e.data,r=e.data.user_id;o.emit(h,t,r,e.type);break;default:}});var d="xapp:logindone";o.on(d,function(e,t){t.then(function(t){o.emit(v,e,t.response.user)})});var v="xapp:userpanel";o.on(v,function(e,t){m(t,e);var n=r("#user-name"),o=a.get("user").default_identity,u=o.external_username;o.provider==="twitter"&&(u="@"+u),n.find(" > span").html(t.name||t.nickname||o.external_username);var l=a.get("signin"),c=l.user_id;s.request("crosslist",{resources:{user_id:c}},function(e){var t=e.crosses;if(0===t.length)return;var n=+(new Date),s=n+108e5,o=n-864e5,u=5,a={crosses:[]};i.map(t,function(e,t){if(e.exfee&&e.exfee.invitations&&e.exfee.invitations.length){var n=i.filter(e.exfee.invitations,function(e,t){if(e.rsvp_status==="ACCEPTED"&&e.identity.connected_user_id===c)return!0});n.length&&a.crosses.push(e)}}),a.crosses=a.crosses.slice(0,u),f.registerHelper("alink",function(e){var t="",r=e.time.begin_at,i=(new Date(r.date.replace(/\-/g,"/")+" "+r.time)).getTime();return n<=i&&i<=s?t='<li class="tag"><i class="icon10-now"></i>':o<=i&&i<n?t='<li class="tag"><i class="icon10-24hr"></i>':t="<li>",t+='<a data-id="'+this.id+'" href="/#!'+this.id+'">'+this.title+"</a>"+"</li>",t});var l='{{#if crosses}}<div>Upcoming:</div><ul class="unstyled crosses">{{#each crosses}}{{{alink this}}}{{/each}}</ul>{{/if}}',h=f.compile(l);r(".user-panel .body").html(h(a))})});var g={1:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body"><div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon16-identity-{{provider}}"></i><span>{{_external_username external_username provider}}</span></div>{{#if isSetup}}<div class="set-up"><a href="#" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d02" data-source="{{_external_username external_username provider}}">Set Up</a> as your independent new <span class="x-sign">EXFE</span> identity.</div>{{/if}}<div class="merge hide"><a href="#">Merge</a> with your currently signed in identities:</div><div class="identity hide"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon16-identity-{{provider}}"></i><span>{{_external_username external_username provider}}</span></div>{{#if isNotLogin}}<div class="spliterline"></div><div class="merge"><a href="#" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d00">Sign in</a> with browsing identity<br />(sign out from current account).</div>{{/if}}</div><div class="footer"></div></div>',2:'<div class="dropdown-menu user-panel"><div class="header"><div class="meta"><a class="pull-right avatar" href="/#{{_external_username default_identity.external_username default_identity.provider}}"><img width="40" height="40" alt="" src="{{avatar_filename}}" /></a><a class="attended" href="/#{{_external_username default_identity.external_username default_identity.provider}}"><span class="attended-nums">{{cross_quantity}}</span><span class="attended-x"><em class="x-sign">X</em> attended</span></a></div></div><div class="body"></div><div class="footer"><a href="/#gather" class="xbtn xbtn-gather" id="js-xgather">Gather</a><div class="spliterline"></div><div class="actions"><a href="#" class="pull-right" id="js-signout">Sign out</a></div></div></div>'},y=r(document.body);r(function(){function t(t){var n=r(this),i=n.data("timer"),s=n.find("div.user-panel").addClass("show"),o=-s.outerHeight();t.preventDefault();if(t.type==="mouseleave")return i=setTimeout(function(){s.stop().animate({top:o},200,function(){n.prev().addClass("hide"),n.parent().removeClass("user")}),clearTimeout(i),n.data("timer",i=null)},500),n.data("timer",i),!1;if(i)return clearTimeout(i),n.data("timer",i=null),!1;e||(s.css("top",o),n.find(".user-panel").addClass("show")),n.prev().removeClass("hide"),n.parent().addClass("user"),s.stop().animate({top:56},100)}var e=!1;y.on("mouseenter.dropdown mouseleave.dropdown",".navbar .dropdown-wrapper",t),y.on("click.dropdown",'.navbar .dropdown-wrapper a[href^="/#"]',function(e){var t=r(".navbar .dropdown-wrapper"),n=t.find("div.user-panel").addClass("show"),i=t.data("timer"),s=-n.outerHeight();clearTimeout(i),t.data("timer",i=null),n.css("top",s),t.prev().addClass("hide").end().parent().removeClass("user")}),y.on("click","#js-signout",function(e){e.preventDefault(),o.emit("xapp:cross:end"),r(".navbar .dropdown-wrapper").find(".user-panel").remove(),r("#js-signin").show().next().hide().removeClass("user").find(".fill-left").addClass("hide").end().find("#user-name span").text(""),a.remove("signin"),window.location="/"})})});