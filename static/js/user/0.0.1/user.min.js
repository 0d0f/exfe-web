define("user",function(e,t,n){function l(e,t,n,r){c(e,t,n||function(n){var r=a.get("last_external_username"),s,f=n.user;r&&(s=i.filter(f.identities,function(e){var t=u.printExtUserName(e);if(r===t)return!0})[0]),s||(s=f.default_identity,a.set("last_external_username",u.printExtUserName(s))),a.set("user",f),a.set("lastIdentity",s),o.emit("app:page:usermenu",!0),o.emit("app:usermenu:updatenormal",f),o.emit("app:usermenu:crosslist",e,t)},r||function(e){})}function c(e,t,n,r){s.request("getUser",{params:{token:e},resources:{user_id:t}},n||function(e){},r||function(e){})}function h(e,t,n,o){s.request("crosslist",{params:{token:e},resources:{user_id:t}},n||function(e){var n=e.crosses,s=n.length;if(0===s)return;var o=5,u;i.map(n,function(e,n){if(e.exfee&&e.exfee.invitations&&e.exfee.invitations.length){var r=i.filter(e.exfee.invitations,function(e,n){if("ACCEPTED"===e.rsvp_status&&t===e.identity.connected_user_id)return!0});r.length&&(!u&&(u=[]),u.push(e))}}),u=u.slice(0,o);if(0===u.length)return;var a=+(new Date),l=a+2592e5,c=a+108e5,h=a+864e5;u=i.filter(u,function(e,t){var n="",r=e.time.begin_at,i=(new Date(r.date.replace(/\-/g,"/")+" "+r.time)).getTime();if(a<=i&&i<=l)return!0});if(0===u.length)return;u.reverse(),f.registerHelper("upcoming",function(){var e="<li>",t=this.time.begin_at,n=(new Date(t.date.replace(/\-/g,"/")+" "+t.time)).getTime();return a<=n&&n<c?e='<li class="tag"><i class="icon10-now"></i>':c<=n&&n<h&&(e='<li class="tag"><i class="icon10-24hr"></i>'),e+='<a data-id="'+this.id+'" href="/#!'+this.id+'">'+this.title+"</a></li>",new f.SafeString(e)});var p='<div>Upcoming:</div><ul class="unstyled crosses">{{#each this}}{{upcoming}}{{/each}}</ul>',d=f.compile(p)(u);r("#app-user-menu .user-panel .body").append(d)},o||function(e){})}function d(e){var t=r("#app-user-menu"),n=r("#app-user-name"),i=n.find("span"),s=t.find(".dropdown-wrapper"),o=s.find(".user-panel"),a,l="/#"+u.printExtUserName(e.default_identity);n.attr("href",l),i.text(e.name||e.nickname).removeClass("browsing-identity"),a=f.compile(p.normal),o.size()&&o.remove(),e.profileLink=l,e.verifying="VERIFYING"===e.default_identity.status,s.append(a(e)),delete e.profileLink,delete e.verifying}function v(e){var t=r("#app-user-menu"),n=r("#app-user-name"),i=n.find("span"),s=t.find(".dropdown-wrapper"),o=s.find(".user-panel"),u=e.browsing,a;n.attr("href",location.href),i.text(u.name||u.nickname).addClass("browsing-identity"),a=f.compile(p.browsing_identity),o.size()&&o.remove(),s.append(a(e))}function m(e){e=!!e;var t=r(document.body),n=r("#app-menubar"),i=r("#app-main");i.empty(),t.toggleClass("hbg",e),n.toggleClass("hide",e)}function g(e){e=!!e;var t=r("#app-user-menu"),n=r("#app-signin");t.toggleClass("hide",!e),n.toggleClass("hide",e)}var r=e("jquery"),i=e("rex"),s=e("api"),o=e("bus"),u=e("util"),a=e("store"),f=e("handlebars");o.on("app:user:signin",l),o.on("app:api:getuser",c),o.on("app:usermenu:crosslist",h),o.on("app:usermenu:updatenormal",d),o.on("app:usermenu:updatebrowsing",v);var p={normal:'<div class="dropdown-menu user-panel"><div class="header"><div class="meta"><a class="pull-right avatar" href="{{profileLink}}"><img width="40" height="40" alt="" src="{{avatar_filename}}" /></a><a class="attended" href="{{profileLink}}"><span class="attended-nums">{{cross_quantity}}</span><span class="attended-x"><em class="x">路X路</em> attended</span></a></div></div><div class="body">{{#unless password}}<div class="merge set-up"><a href="#" data-source="{{default_identity.external_username}}" data-widget="dialog" data-dialog-type="setpassword">Set Up</a> your <span class="x-sign">EXFE</span> password</div>{{/unless}}{{#if verifying}}<div class="merge verify"><strong>Verify</strong> your identity</div>{{/if}}<div class="list"></div></div><div class="footer"><a href="/#gather" class="xbtn xbtn-gather" id="js-gatherax">Gather a <span class="x">路X路</span></a><div class="spliterline"></div><div class="actions"><a href="#" class="pull-right" id="app-signout">Sign out</a></div></div></div>',browsing_identity:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body">{{#with browsing}}<div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img src="{{default_identity.avatar_filename}}" width="20" height="20" alt="" /></span><i class="icon16-identity-{{default_identity.provider}}"></i><span>{{default_identity.external_username}}</span></div>{{#if ../setup}}<div class="merge set-up"><a href="#" data-source="{{default_identity.external_username}}" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d02">Set Up</a> new <span class="x-sign">EXFE</span> account with the browsing identity.</div>{{/if}}{{/with}}{{#if normal}}<div class="spliterline"></div><div class="merge"><a href="#">Merge</a> with existing identities in your current account:</div>{{#each normal.identities}}{{#ifConnected status}}<div class="identity"><span class="pull-right avatar"><img src="{{avatar_filename}}" width="20" height="20" alt="" /></span><i class="icon16-identity-{{provider}}"></i><span>{{external_username}}</span></div>{{/ifConnected}}{{/each}}{{/if}}<div class="spliterline"></div><div class="merge"><a href="#" data-source="{{browsing.default_identity.external_username}}" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d00">Sign In</a> with browsing identity<br />(sign out from current account).</div></div><div class="footer"></div></div>'};f.registerHelper("ifConnected",function(e,t){return f.helpers["if"].call(this,"CONNECTED"===e,t)}),o.on("app:page:home",m),o.on("app:page:usermenu",g)});