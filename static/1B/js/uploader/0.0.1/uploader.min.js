define("uploader",[],function(a,b,c){var d=a("jquery"),e=a("dialog"),f=a("filehtml5"),g=e.extend({_fileInputField:null,_buttonBinding:null,queue:null,init:function(){this._fileInputField=null,this.queue=null,this._buttonBinding=null,this._fileList=[]},sync:function(){var a=this.$(".selectfile");this._fileInputField=d(g.HTML5FILEFIELD_TEMPLATE),a.after(this._fileInputField),this._bindDropArea(),this._fileInputField.on("change",d.proxy(this._updateFileList,this))},_bindSelectFile:function(a){var b=this._fileInputField[0];b.click&&b.click()},_bindDropArea:function(a){var b=a||{prevVal:null};b.prevVal!==null&&(b.prevVal.detach("drop",this._ddEventhandler),b.prevVal.detach("dragenter",this._ddEventhandler),b.prevVal.detach("dragover",this._ddEventhandler),b.prevVal.detach("dragleave",this._ddEventhandler));var c=d.proxy(this._ddEventhandler,this);this.element.on("drop",".photozone",c),this.element.on("dragenter",".photozone",c),this.element.on("dragover",".photozone",c),this.element.on("dragleave",".photozone",c);var e=d.proxy(this._docddEventhandler,this);d(document).on("drop",e).on("dragenter",e).on("dragleave",e).on("dragover",e)},_ddEventhandler:function(a){a.stopPropagation(),a.preventDefault();switch(a.type){case"dragenter":this.emit("dragenter",a);break;case"dragover":this.emit("dragover",a);break;case"dragleave":this.emit("dragleave",a);break;case"drop":var b=this.$(".photozone")[0];if(!d.contains(b,a.target)&&a.target!==b)return!1;this._fileselect(a.originalEvent.dataTransfer.files),this.emit("drop",a)}return!1},_docddEventhandler:function(a){a.stopPropagation(),a.preventDefault();switch(a.type){case"dragenter":this.emit("docdragenter",a);break;case"dragover":this.emit("docdragover",a);break;case"dragleave":this.emit("docdragleave",a);break;case"drop":this.emit("docdrop",a)}return!1},_fileselect:function(a){var b=a,c=[],d,e=this.fileFilterFunction,g=0,h=b.length;if(e)for(;g<h;g++)d=new f(b[g]),e(d)&&c.push(d);else for(;g<h;g++)c.push(new f(b[g]));this.options.limit&&(c=c.slice(-this.options.limit)),c.length>0&&this.emit("fileselect",{fileList:c})},_updateFileList:function(a){this._fileselect(a.target.files)},fileFilterFunction:function(a){var b=!1;return/^image\/(png|gif|bmp|jpg|jpeg)$/.test(a._type)&&(b=!0),b}},{HTML5FILEFIELD_TEMPLATE:'<input type="file" style="visibility:hidden; width:0px; height:0px;" />'}),h={options:{limit:1,onDrop:function(a){console.log("drop")},onFileselect:function(a){var b=a.fileList[0];this.original=b._file,this.$(".overlay").addClass("hide"),this.$(".photozone").find(".back, .rotate").removeClass("hide");var c=document.getElementById("avatar240"),d=c.getContext("2d");d.clearRect(0,0,240,240);var e=document.getElementById("avatar80"),f=e.getContext("2d");f.clearRect(0,0,80,80);var g=document.createElement("img"),h=0,i=0,j=!1,k=0,l=0;clearInterval(this.__t);var m=this;this.__t=setInterval(function(){if(m.__mousepresed){var a=h,b=h+g.width,c=i,e=i+g.height;j||(k=m.__x-h,l=m.__y-i),m.__x<b&&m.__x>a&&m.__y<e&&m.__y>c&&(m.__dragging||(m.__dragging=!0,j=!0))}else j=!1;j&&(h=m.__x-k,i=m.__y-l,d.clearRect(0,0,240,240),d.drawImage(g,h,i),f.clearRect(0,0,80,80),f.drawImage(g,h/3,i/3,g.width*80/240,g.height*80/240))},10),g.onload=function(a){d.translate(120,120),console.log(g.width,g.height),d.drawImage(g,-g.width/2,-g.height/2),f.translate(40,40);var b=80/240;f.drawImage(g,-(g.width*b)/2,-(g.height*b)/2,g.width*b,g.height*b)},this.img240=g;if(window.URL&&window.URL.createObjectURL)g.src=window.URL.createObjectURL(b._file);else if(window.webkitURL.createObjectURL)g.src=window.webkitURL.createObjectURL(b._file);else{var n=new FileReader;n.onload=function(){g.src=this.result},n.readAsDataURL(b._file)}},backdrop:!1,events:{"click .selectfile":function(a){a.stopPropagation(),a.preventDefault(),this._bindSelectFile(a)},"mousedown #avatar240":function(a){this.__mousepresed=!0},"mousemove #avatar240":function(a){this.__x=a.offsetX,this.__y=a.offsetY},"mouseup #avatar240":function(a){this.__mousepresed=!1,this.__dragging=!1,this.__t&&clearInterval(this.__t)},"click .rotate":function(a){this._ii_||(this._ii_=0),this._ii_===3&&(this._ii_=0),a.preventDefault();var b=document.getElementById("avatar240"),c=b.getContext("2d");c.clearRect(0,0,240,240),c.translate(0,0),c.translate(120,120),c.rotate(90*++this._ii_*Math.PI/180),c.drawImage(this.img240,-(this.img240.width/2),-(this.img240.height/2)),c.drawImage(this.img240,0,0),c.restore()}},onHideAfter:function(){var a=this.element;this.offSrcNode(),this.destory(),a.remove()},viewData:{cls:"modal-uploader",title:"Portrait",body:'<div class="pull-right sider"><div class="pull-right smallphoto"><div class="avatar80"><canvas id="avatar80" width="80" height="80"></canvas></div><div class="overlay"></div></div><div class="uploader-form"><button class="pull-right xbtn xbtn-blue uploader-button">Done</button></div></div><div class="photozone"><i class="icon20-back back hide" style="width: 20px; height: 20px; background: red;"></i><i class="icon20-rotate rotate hide" style="width: 20px; height: 20px; background: black;"></i><div class="avatar240"><canvas id="avatar240" width="240" height="240"></canvas></div><div class="overlay dropbox"><div class="droptips">Drop your photo or URL here, <br /> or <span class="selectfile">open</span> local file.</div></div></div>',footer:'<button class="pull-right xbtn xbtn-yellow hide">Yes</button><button class="pull-right xbtn xbtn-white hide">No</button>',others:'<div class="help-portrait hide"><div class="modal-body"><div class="shadow title">Use default portrait?</div><p>You have no portrait set, thus a default one will be assigned automatically. It means you will lose your primary visual identification, consequently poor recognizability confuse your friends.</p><p>Confirm using default portrait?</p></div></div>'}}};return function(){return new g(h)}});