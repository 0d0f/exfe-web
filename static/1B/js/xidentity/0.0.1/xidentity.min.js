define(function(a){var b=a("jquery"),c=a("util"),d=a("bus"),e=a("api"),f=b(document.body),g=a("store"),h=a("typeahead"),i=a("handlebars"),j=h.extend({itemRender:function(a){var c=i.compile(this.options.viewData.item);return b(c(a))},matcher:function(a){var b=a.external_id;return~b.toLowerCase().indexOf(this.query.toLowerCase())},focus:function(){var a=c.trim(this.target.val());a||this.emit("nothing",a)},options:{url:null,useCache:!1,delay:200,extraParams:{},autoClearResults:!1,dataType:"JSON",minLength:1,viewData:{item:'<li data-value="{{external_id}}"><i class="pull-right icon16-identity-{{provider}}"></i><span>{{external_id}}</span></li>'},onSelect:function(a){this.emit("search",a)},onClearCache:function(){delete this.cache},onSearch:function(a){var d=this,f=d.options,g,h;d.cache||(d.cache={}),d.source&&d.source.length&&(h=b.grep(d.source,function(a){return d.matcher(a)}),h.length?d.render(h.slice(0)).show():d.isShown?d.hide():d),d.timer&&(clearTimeout(d.timer),d.target.next().addClass("hide"));if((g=c.parseId(a)).provider){var i={provider:g.provider,external_id:g.external_identity};d.timer=setTimeout(function(){clearTimeout(d.timer),k(a)},f.delay);function j(a){d.ajaxDefer&&d.ajaxDefer.readyState<4&&d.ajaxDefer.abort(),d.emit("autocomplete:beforesend"),f.useCache&&d.cache[a]?d.emit("autocomplete:finish",d.cache[a]):d.ajaxDefer=e.request("getRegistrationFlag",{data:i,beforesend:function(a){d.target.next().removeClass("hide")},complete:function(a){d.target.next().addClass("hide")}},function(b){a===d.target.val()&&(f.useCache&&(d.cache[a]=b),d.emit("autocomplete:finish",b))})}function k(a){a.length>=d.options.minLength?(j(a),d.searchValue=a):d.emit("autocomplete:clear")}}else d.emit("autocomplete:finish",null)}}});b(function(){var a=g.get("user"),c;a&&(c=a.identities),f.on("focus.typeahead.data-api",'[data-typeahead-type="identity"]',function(a){var e=b(this);if(e.data("typeahead"))return;a.preventDefault(),e.data("typeahead",new j({options:{source:c,useCache:!0,target:e,onNothing:function(){this.target.parent().removeClass("identity-avatar"),d.emit("widget-dialog-identification-nothing")},"onAutocomplete:finish":function(a){var b;a&&(b=a.identity)?(b.avatar_filename==="default.png"&&(b.avatar_filename="/img/default_portraituserface_20.png"),this.target.prev().attr("src",b.avatar_filename).parent().addClass("identity-avatar")):this.target.parent().removeClass("identity-avatar"),d.emit("widget-dialog-identification-auto",a)}}}))})})});