define(function(a,b,c){var d=a("jquery"),e=a("store"),f=a("config"),g=a("handlebars"),h=a("rex"),i=a("util"),j=a("bus"),k=a("api"),l=a("moment");l.calendar={sameDay:"ha, dddd MMMM D",nextDay:"h:ssA [Tomorrow], dddd MMMM D",nextWeek:"dddd [at] LT",lastDay:"hA, dddd MMMM D",lastWeek:"hA, dddd MMMM D",sameElse:"L"},g.registerHelper("each",function(a,b){var c=b.fn,d=b.inverse,e="",f,g;if(a&&a.length)for(f=0,g=a.length;f<g;++f)a[f].__index__=f,e+=c(a[f]);else e=d(this);return e}),g.registerHelper("ifFalse",function(a,b){return g.helpers["if"].call(this,!a,b)}),g.registerHelper("avatarFilename",function(a,b){return a}),g.registerHelper("printName",function(a,b){return a||(a=b.match(/([^@]+)@[^@]+/)[1]),a}),g.registerHelper("printTime",function(a){var b=l(),c=b.format("Z"),d=a.begin_at,e=/(^[\+\-]\d\d:\d\d)/.exec(d.timezone)[1],f=l.utc(d.date+" "+d.time+" "+e,"YYYY-MM-DD HH:mm:ss Z"),g="",h,i=c===e;return a.outputformat?(g=a.origin,i||(g+=" "+e),g):(d.time_word&&(g+=d.time_word+" (at) "),g+=d.time,i||(g+=" ("+e+") "),d.date_word&&(g+=d.date_word+" (on) "),g+=" "+d.date,f.year()!==b.year()&&(g+=" "+f.year()),f.calendar())}),g.registerHelper("printTime2",function(a,b){return a=g.helpers.crossItem.call(this,a,b),g.helpers.printTime4.call(this,a)}),g.registerHelper("printTime4",function(a){var b=l(),c=b.format("Z"),d=a.begin_at,e=/(^[\+\-]\d\d:\d\d)/.exec(d.timezone)[1],f=l.utc(d.date+" "+d.time+" "+e,"YYYY-MM-DD HH:mm:ss Z"),g="",h="",i=c===e;return a.outputformat?(g=a.origin,i||(g+=" "+e),g):(d.time!=="00:00:00"&&(h+="hA "),d.date&&(h+="ddd MMM D"),f.format(h))}),g.registerHelper("printTime3",function(a,b){var c=a.begin_at,d=/(^[\+\-][\d]{2}:[\d]{2})/.exec(c.timezone)[1],e=l.utc(c.date+" "+c.time+" "+d,"YYYY-MM-DD HH:mm:ss Z");return e.fromNow()}),g.registerHelper("rsvpAction",function(a,b){var c=h.filter(a,function(a){if(a.identity.id===b)return!0})[0],d="";if(c.rsvp_status!=="INTERESTED"){var d='<div><i class="';d+="icon-rsvp-"+c.rsvp_status.toLowerCase()+'"></i> ',d+=c.rsvp_status.charAt(0)+c.rsvp_status.substr(1).toLowerCase()+": "+c.identity.name+"</div>"}var e=h.map(a,function(a){if(a.by_identity.id===b&&a.identity.id!==b)return a.identity.name}).filter(function(a){if(a)return!0}).join(" ,");return d+='<div><i class="icon-invite"></i> ',d+="Invited: "+e,d+="</div>",d}),g.registerHelper("ifPlace",function(a){var b=g.helpers.crossItem.call(this,"place");return g.helpers["if"].call(this,b.length,a)}),g.registerHelper("ifOauthVerifying",function(a,b,c){var d=a==="twitter"&&b==="VERIFYING";return g.helpers["if"].call(this,d,c,c)}),g.registerHelper("makeDefault",function(a,b,c){var d=!a&&b==="CONNECTED";return g.helpers["if"].call(this,d,c,c)}),g.registerHelper("ifVerifying",function(a,b,c){var d=a==="email"&&b==="VERIFYING";return g.helpers["if"].call(this,d,c)}),g.registerHelper("atName",function(a,b){return b}),g.registerHelper("editable",function(a,b,c){var d=a==="email"&&b==="CONNECTED";return g.helpers["if"].call(this,d,c)});var m=function(a){if(!a)return;var b;a.response?b=a.response.user:a instanceof Array&&(b=a[0].response.user),e.set("user",b),d(".user-xstats .attended").html(b.cross_quantity),d("#user-name > span").html(b.name);var c=d("#jst-user-avatar"),f=g.compile(c.html()),i=f({avatar_filename:b.avatar_filename});d(".user-avatar").append(i),d(".user-name").find("h3").html(b.name);var j=d("#jst-identity-list"),f=g.compile(j.html()),k=b.default_identity;h.each(b.identities,function(a,b){a.id===k.id&&(a.__default__=!0)});var i=f({identities:b.identities});d(".identity-list").append(i)},n=function(a){if(!a)return;a=e.get("signin");if(!a)return;var b=a.user_id;return k.request("crosslist",{resources:{user_id:b}},function(a){var b=+(new Date),c=d("#jst-crosses-container");g.registerHelper("confirmed_nums",function(a){return h.filter(a,function(a){if(a.rsvp_status==="ACCEPTED")return!0}).length}),g.registerHelper("total",function(a){return a.length}),g.registerHelper("confirmed_identities",function(a){var b=h(a).filter(function(a){if(a.rsvp_status==="ACCEPTED")return!0});return h(b.slice(0,7)).map(function(a,b){return a.identity.name}).join(", ")}),g.registerPartial("jst-cross-box",d("#jst-cross-box").html());var e=g.compile(c.html()),f="",i="upcoming<Upcoming> sometime<Sometime> sevendays<Next 7 days> later<Later> past<Past>",j={};h.map(a.crosses,function(a,b){j[a.sort]||(j[a.sort]={crosses:[]}),j[a.sort].crosses.push(a)}),j.upcoming||(j.upcoming={}),j.upcoming.hasGatherAX=!0,j.upcoming.totalCrosses=a.crosses.length;var k=a.more.join(" "),l=/<|>/;h.map(i.split(" "),function(a,b){a=a.split(l);var c=j[a[0]];c&&(c.cate=a[0],c.cate_date=a[1],c.hasMore=k.search(a[0])>-1,f+=e(c))}),d("#profile .crosses").append(f)})},o=function(a){if(!a)return;a=e.get("signin");if(!a)return;var b=a.user_id,c=new Date;return c=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),k.request("crosses",{resources:{user_id:b}},function(a){var c=new Date,e=a.crosses,f=[],i=[],j,k=[],m={},n=[];h.each(e,function(a,c){a.exfee&&a.exfee.invitations&&a.exfee.invitations.length&&h.each(a.exfee.invitations,function(a,d){m[a.id]=[c,d],b===a.identity.connected_user_id&&a.rsvp_status==="NORESPONSE"&&(a.__crossIndex=c,a.__identityIndex=d,f.push(a))})}),g.registerHelper("crossItem",function(a){return a==="place"?e[this.__crossIndex][a].title:a==="invitationid"?e[this.__crossIndex].exfee.invitations[this.__identityIndex].id:a==="exfeeid"?e[this.__crossIndex].exfee.id:e[this.__crossIndex][a]}),g.registerHelper("conversation_nums",function(){return this.__conversation_nums}),g.registerHelper("humanTime",function(a){return l().from(a)});if(f.length){var o=d("#jst-invitations"),p=g.compile(o.html()),q=p({crosses:f});d("#profile .gr-b .invitations").removeClass("hide").append(q)}})},p=function(a){if(!a)return;a=e.get("signin");if(!a)return;var b=a.user_id,c=new Date;return c.setDate(c.getDate()-3),c=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),k.request("crosses",{resources:{user_id:b},params:{updated_at:c}},function(a){var e=a.crosses,f=[],i=[];e.length&&h.each(e,function(a,d){a.updated&&a.updated.conversation&&f.push(k.request("conversation",{resources:{exfee_id:a.exfee.id},params:{date:c}},function(c){var d=c.conversation;if(d&&d.length){var e=d[d.length-1];if(e.by_identity.connected_user_id===b)return;e.__conversation_nums=d.length,a.updated.conversation.item=e}}))});if(f.length){var j=d.when;j=j.apply(null,f),j.then(function(a){var b=d("#jst-updates").html(),c=g.compile(b),f=c({updates:e});d("#profile .ios-app").before(f)})}})},q=function(a){if(!a)return;a=e.get("signin");if(!a)return;var b=a.user_id,c=+d(".user-xstats > .attended").text(),g=e.get("newbie_guide:"+b);if(!g&&c<=3){var h=document.createElement("script");h.type="text/javascript",h.async=!0,h.src="/static/1b/js/newbieguide/0.0.1/newbieguide.min.js?t="+f.timestamp;var i=document.body;i.appendChild(h)}},r=function(a){var b=e.get("iosapp_dismiss");b||d(".ios-app").removeClass("hide")},s="app:signinothers";j.on(s,function(a){a.then([n,o,p,r,q])});var t="app:signinsuccess";j.on(t,function(a){m(a)}),j.on("app:addidentity",function(a){var b=d("#jst-identity-list"),c=g.compile(b.html()),e=c({identities:[a.identity]});d(".identity-list").append(e)});var u=d(document.body);d(function(){u.on("hover.profile",".identity-list > li",function(a){d(this).find(".xbtn-reverify, .xbtn-reauthorize").toggleClass("hide")}),u.on("click.profile","i.icon-minus-sign",function(a){var b=d(this).parent().data("identity-id"),c=e.get("signin"),f=c.token;return}),u.on("dblclick.profile",".user-name h3",function(a){var b=d.trim(d(this).html()),c=d('<input type="text" value="'+b+'" class="pull-left" />');c.data("oldValue",b),d(this).after(c).hide(),c.focusend(),d(".xbtn-changepassword").addClass("hide")}),u.on("focusout.profile keydown.profile",".user-name input",function(a){var b=a.type,c=a.keyCode;if(b==="focusout"||c===9||!a.shiftKey&&c===13){var f=d.trim(d(this).val()),g=d(this).data("oldValue");d(this).hide().prev().html(f).show(),d(this).remove(),!d(".settings-panel").data("hoverout")&&d(".xbtn-changepassword").removeClass("hide");if(!f||f===g)return;k.request("updateUser",{type:"POST",data:{name:f}},function(a){e.set("user",a.user),j.emit("app:changename",f)})}}),u.on("dblclick.profile",".identity-list li.editable .username > em",function(a){var b=d.trim(d(this).html()),c=d('<input type="text" value="'+b+'" class="username-input" />');c.data("oldValue",b),d(this).after(c).hide(),c.focusend()}),u.on("focusout.profile keydown.profile",".identity-list .username-input",function(a){var b=a.type,c=a.keyCode;if(b==="focusout"||c===9||!a.shiftKey&&c===13){var f=d.trim(d(this).val()),g=d(this).data("oldValue"),h=d(this).parent().parent().data("identity-id");d(this).hide().prev().html(f).show(),d(this).remove();if(!f||f===g)return;k.request("updateIdentity",{resources:{identity_id:h},type:"POST",data:{name:f}},function(a){var b=e.get("user");for(var c=0,d=b.identities.length;c<d;++c)if(b.identities[c].id===a.identity_id){b.identities[c]=identity;break}e.set("user",b)})}}),u.on("click.profile",".xbtn-accept",function(a){a.preventDefault(),a.stopPropagation();var b=e.get("lastIdentity"),c=d(this).parent(),f=c.data("id"),g=c.data("invitationid"),h=d('.gr-a [data-id="'+f+'"]'),i=c.data("exfeeid");k.request("rsvp",{resources:{exfee_id:i},type:"POST",data:{rsvp:'[{"identity_id":'+b.id+', "rsvp_status": "ACCEPTED", "by_identity_id": '+b.id+"}]",by_identity_id:b.id}},function(a){var b=h.find(">div :first-child"),d=+b.text();b.text(d+1);var f=h.find(">div :last-child"),g=f.text(),i=e.get("lastIdentity");f.text(g+(g?", ":"")+i.name);var j;!c.parent().prev().length&&!c.parent().next().length&&(j=c.parents(".invitations")),c.parent().remove(),j&&j.remove()})}),u.on("click.profile.identity",".xbtn-addidentity",function(a){}),u.on("click.profile","#profile div.cross-type",function(a){a.preventDefault(),d(this).next().toggleClass("hide").next().toggleClass("hide"),d(this).find("span.arrow").toggleClass("lt rb")}),u.on("hover.profile",".settings-panel",function(a){var b=a.type;d(this).data("hoverout",b==="mouseleave"),b==="mouseenter"?d(this).find(".xbtn-changepassword").removeClass("hide"):d(this).find(".xbtn-changepassword").addClass("hide")}),u.on("click.profile",".more > a",function(a){a.preventDefault();var b=d(this),c=b.parent(),f=c.data("cate"),i=e.get("signin"),j=i.token,l=i.user_id,m=c.prev().find(" .cross-box").length,n=f;k.request("crosslist",{resources:{user_id:l},data:{more_category:n,more_position:m}},function(a){if(a.crosses.length){var d="{{#crosses}}{{> jst-cross-box}}{{/crosses}}",e=g.compile(d);c.prev().append(e(a));var i=h.filter(a.more,function(a){if(a===f)return!0});i.length||b.remove()}})})}),u.on("click.profile.iosapp",".ios-app > .exfe-dismiss",function(a){a.preventDefault(),e.set("iosapp_dismiss",!0),u.off("click.profile.iosapp"),d(this).parent().fadeOut()}),u.on("click.profile.uploader",".user-avatar",function(b){var c=a("uploader")().render();c.show()})});