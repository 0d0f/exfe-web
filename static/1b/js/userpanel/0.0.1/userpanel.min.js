define(function(e){function h(e,n){if(n){t("#js-signin").remove();var r=t(".nav li.dropdown").show(),i=u.compile(a[n]);t(i(e)).appendTo(r.find(".dropdown-wrapper"))}}var t=e("jquery"),n=e("rex"),r=e("api"),i=e("bus"),s=e("util"),o=e("store"),u=e("handlebars"),a={1:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body"><div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon16-identity-{{provider}}"></i><span>{{external_id}}</span></div></div><div class="footer"><button class="xbtn xbtn-signin" data-widget="dialog" data-identity-id={{id}} data-dialog-tab="{{__tab__}}" data-dialog-type="{{__dialogtype__}}" data-source="{{external_id}}">Sign In</button></div></div>',2:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body"><div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon-envelope"></i><span>{{external_id}}</span></div><div class="set-up"><a href="#" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d02" data-source="{{external_id}}">Set Up</a> as your independent new <span class="x-sign">EXFE</span> identity.</div></div><div class="footer"><button class="xbtn xbtn-gather" id="js-xgather">Gather</button></div></div>',3:'<div class="dropdown-menu user-panel"><div class="header"><div class="meta"><a class="pull-right avatar" href="/s/profile"><img width="40" height="40" alt="" src="{{avatar_filename}}" /></a><a class="attended" href="/s/profile"><span class="attended-nums">{{cross_quantity}}</span><span class="attended-x"><em class="x-sign">X</em> attended</span></a></div></div><div class="body"></div><div class="footer"><a href="/x/gather" class="xbtn xbtn-gather" id="js-xgather">Gather</a><div class="spliterline"></div><div class="actions"><a href="/s/logout" class="pull-right" id="js-signout">Sign out</a></div></div></div>'},f="app:startup",l="app:nosignin",c="app:signin";i.on(l,function(){/^s\/profile.*$/.test(window.location.pathname),t("#js-signin").show()}),i.on(c,function(e,t){e.then(function(n){i.emit("app:signinsuccess",n);var r="app:signinothers";i.emit(r,e),i.emit("app:userpanel",{type:t,data:n})})}),i.on("app:changename",function(e){t("#user-name > span").html(e)}),i.on("app:crosstoken",function(e,n,s){var o=e[n],u=o.identity_id,a,f="";switch(o.identity_registration){case"VERIFY":a="identification",f="d01";break;case"SIGN_UP":a="identification",f="d02",s=2;break;case"SIGN_IN":a="identification",f="d01"}var l=t.when(r.request("getIdentityById",{resources:{identity_id:u}},function(e){var n=e.identity.external_id;t("#user-name > span").html(e.identity.name||n.split("@")[0]),a==="verification"&&(a+="_"+e.identity.provider),e.identity.__dialogtype__=a,e.identity.__tab__=f,h(e.identity,s)}));l.done(function(e){i.emit("app:crossdata",n,o)})}),i.on("app:userpanel",function(e){var i=e.type,s=e.data;h(s.response.user,i),t("#user-name > span").html(s.response.user.name);var a=o.get("signin"),f=a.user_id;r.request("crosslist",{resources:{user_id:f}},function(e){var r=e.crosses;if(r.length){var i=+(new Date),s=i+108e5,o=i-864e5,a=5,l={crosses:[]};n.map(r,function(e,t){if(e.exfee&&e.exfee.invitations&&e.exfee.invitations.length){var r=n.filter(e.exfee.invitations,function(e,t){if(e.rsvp_status==="ACCEPTED"&&e.identity.connected_user_id===f)return!0});r.length&&l.crosses.push(e)}}),l.crosses=l.crosses.slice(0,a),u.registerHelper("alink",function(e){var t="",n=e.time.begin_at,r=(new Date(n.date.replace(/\-/g,"/")+" "+n.time)).getTime();return i<=r&&r<=s?t='<li class="tag"><i class="icon10-now"></i>':o<=r&&r<i?t='<li class="tag"><i class="icon10-24hr"></i>':t="<li>",t+='<a data-id="'+this.id+'" href="/!'+this.id+'">'+this.title+"</a>"+"</li>",t});var c='{{#if crosses}}<div>Upcoming:</div><ul class="unstyled crosses">{{#each crosses}}{{{alink this}}}{{/each}}</ul>{{/if}}',h=u.compile(c);t(".user-panel .body").html(h(l))}})}),i.on("app:usertoken",function(e,s,u){var a=e[s],f=a.user_id;r.setToken(s),o.set("signin",{token:s,user_id:f});var l=t.when(r.request("getUser",{resources:{user_id:f}},function(e){var t=o.get("last_identity"),r=n.filter(e.user.identities,function(e){if(t===e.external_id)return!0})[0]||e.user.default_identity;o.set("lastIdentity",r)}));l.done(function(e){i.emit(c,l,u)})}),i.on("app:userstatus",function(e){var t=e.type,n=e.statuses,r=e.token;switch(t){case 1:case 2:i.emit("app:crosstoken",n,r,t);break;case 3:i.emit("app:usertoken",n,r,t);break;default:}}),i.once(f,function(){var e=decodeURIComponent(window.location.search),n=/token=([a-zA-Z0-9]{32})/.exec(e),s=n&&n[1]||!1,u=o.get("signin"),a=!1,f=[],c=0,h,p;u&&(a=u.token),s&&f.push(s),a&&s!==a&&f.push(a);if(!f.length){h=l,t.when().then(function(){i.emit(h)});return}r.request("checkAuthorization",{type:"POST",data:{tokens:JSON.stringify(f)}},function(e){var t=e.statuses,n=f[0],r=t[n];r&&(r.type==="CROSS_TOKEN"?(c=1,p===2&&(c=2)):r.type==="USER_TOKEN"&&(c=3,p===2&&delete t[f[1]])),i.emit("app:userstatus",{token:n,type:c,statuses:t})})}),i.emit(f);var p=t(document.body);t(function(){function n(n){var r=t(this),i=r.data("timer"),s=r.find("div.user-panel"),o=-s.outerHeight();n.preventDefault();if(n.type==="mouseleave")return i=setTimeout(function(){s.stop().animate({top:o},200,function(){r.prev().addClass("hide"),r.parent().removeClass("user")}),clearTimeout(i),r.data("timer",i=null)},500),r.data("timer",i),!1;if(i)return clearTimeout(i),r.data("timer",i=null),!1;e||(s.css("top",o),r.find(".user-panel").addClass("show"),e=!0),r.prev().removeClass("hide"),r.parent().addClass("user"),s.stop().animate({top:56},100)}function r(e){return e.stopPropagation(),e.preventDefault(),!1}var e=!1;p.on("mouseenter.dropdown mouseleave.dropdown",".navbar .dropdown-wrapper",n),t(document.body).on("drop",r).on("dragenter",r).on("dragleave",r).on("dragover",r),p.on("click","#js-signout",function(e){e.preventDefault(),o.remove("signin"),window.location="/s/logout"})})});