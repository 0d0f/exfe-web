define(function(a){function m(a,c){if(c){b("#js-signin").remove();var d=b(".nav li.dropdown").show(),e=h.compile(i[c]);b(e(a)).appendTo(d.find(".dropdown-wrapper"))}}var b=a("jquery"),c=a("rex"),d=a("api"),e=a("bus"),f=a("util"),g=a("store"),h=a("handlebars"),i={1:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body"><div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon16-identity-{{provider}}"></i><span>{{external_id}}</span></div></div><div class="footer"><button class="xbtn xbtn-signin" data-widget="dialog" data-identity-id={{id}} data-dialog-tab="{{__tab__}}" data-dialog-type="{{__dialogtype__}}" data-source="{{external_id}}">Sign In</button></div></div>',2:'<div class="dropdown-menu user-panel"><div class="header"><h2>Browsing Identity</h2></div><div class="body"><div>You are browsing this page as Email identity:</div><div class="identity"><span class="pull-right avatar"><img width="20" height="20" alt="" src="{{avatar_filename}}"></span><i class="icon-envelope"></i><span>{{external_id}}</span></div><div class="set-up"><a href="#" data-widget="dialog" data-dialog-type="identification" data-dialog-tab="d02" data-source="{{external_id}}">Set Up</a> as your independent new <span class="x-sign">EXFE</span> identity.</div></div><div class="footer"><button class="xbtn xbtn-gather" id="js-xgather">Gather</button></div></div>',3:'<div class="dropdown-menu user-panel"><div class="header"><div class="meta"><a class="pull-right avatar" href="/s/profile"><img width="40" height="40" alt="" src="{{avatar_filename}}" /></a><a class="attended" href="/s/profile"><span class="attended-nums">{{cross_quantity}}</span><span class="attended-x"><em class="x-sign">X</em> attended</span></a></div></div><div class="body"></div><div class="footer"><a href="/x/gather" class="xbtn xbtn-gather" id="js-xgather">Gather</a><div class="spliterline"></div><div class="actions"><a href="/s/logout" class="pull-right" id="js-signout">Sign out</a></div></div></div>'},j="app:startup",k="app:nosignin",l="app:signin";e.on(k,function(){!/^s\/profile.*$/.test(window.location.pathname),b("#js-signin").show()}),e.on(l,function(a,b){a.then(function(c){e.emit("app:signinsuccess",c);var d="app:signinothers";e.emit(d,a),e.emit("app:userpanel",{type:b,data:c})})}),e.on("app:changename",function(a){b("#user-name > span").html(a)}),e.on("app:crosstoken",function(a,c,f){var g=a[c],h=g.identity_id,i,j="";switch(g.identity_registration){case"VERIFY":i="identification",j="d01";break;case"SIGN_UP":i="identification",j="d02",f=2;break;case"SIGN_IN":i="identification",j="d01"}var k=b.when(d.request("getIdentityById",{resources:{identity_id:h}},function(a){var c=a.identity.external_id;b("#user-name > span").html(a.identity.name||c.split("@")[0]),i==="verification"&&(i+="_"+a.identity.provider),a.identity.__dialogtype__=i,a.identity.__tab__=j,m(a.identity,f)}));k.done(function(a){e.emit("app:crossdata",c,g)})}),e.on("app:userpanel",function(a){var e=a.type,f=a.data;m(f.response.user,e),b("#user-name > span").html(f.response.user.name);var i=g.get("signin"),j=i.user_id;d.request("crosslist",{resources:{user_id:j}},function(a){var d=a.crosses;if(d.length){var e=+(new Date),f=e+108e5,g=e-864e5,i=5,k={crosses:[]};c.map(d,function(a,b){if(a.exfee&&a.exfee.invitations&&a.exfee.invitations.length){var d=c.filter(a.exfee.invitations,function(a,b){if(a.rsvp_status==="ACCEPTED"&&a.identity.connected_user_id===j)return!0});d.length&&k.crosses.push(a)}}),k.crosses=k.crosses.slice(0,i),h.registerHelper("alink",function(a){var b="",c=a.time.begin_at,d=(new Date(c.date.replace(/\-/g,"/")+" "+c.time)).getTime();return e<=d&&d<=f?b='<li class="tag"><i class="icon10-now"></i>':g<=d&&d<e?b='<li class="tag"><i class="icon10-24hr"></i>':b="<li>",b+='<a data-id="'+this.id+'" href="/!'+this.id+'">'+this.title+"</a>"+"</li>",b});var l='{{#if crosses}}<div>Upcoming:</div><ul class="unstyled crosses">{{#each crosses}}{{{alink this}}}{{/each}}</ul>{{/if}}',m=h.compile(l);b(".user-panel .body").html(m(k))}})}),e.on("app:usertoken",function(a,f,h){var i=a[f],j=i.user_id;d.setToken(f),g.set("signin",{token:f,user_id:j});var k=b.when(d.request("getUser",{resources:{user_id:j}},function(a){var b=g.get("last_identity"),d=c.filter(a.user.identities,function(a){if(b===a.external_id)return!0})[0]||a.user.default_identity;g.set("lastIdentity",d)}));k.done(function(a){e.emit(l,k,h)})}),e.on("app:userstatus",function(a){var b=a.type,c=a.statuses,d=a.token;switch(b){case 1:case 2:e.emit("app:crosstoken",c,d,b);break;case 3:e.emit("app:usertoken",c,d,b);break;default:}}),e.once(j,function(){var a=decodeURIComponent(window.location.search),c=/token=([a-zA-Z0-9]{32})/.exec(a),f=c&&c[1]||!1,h=g.get("signin"),i=!1,j=[],l=0,m,n;h&&(i=h.token),f&&j.push(f),i&&f!==i&&j.push(i);if(!j.length){m=k,b.when().then(function(){e.emit(m)});return}d.request("checkAuthorization",{type:"POST",data:{tokens:JSON.stringify(j)}},function(a){var b=a.statuses,c=j[0],d=b[c];d&&(d.type==="CROSS_TOKEN"?(l=1,n===2&&(l=2)):d.type==="USER_TOKEN"&&(l=3,n===2&&delete b[j[1]])),e.emit("app:userstatus",{token:c,type:l,statuses:b})})}),e.emit(j);var n=b(document.body);b(function(){function c(c){var d=b(this),e=d.data("timer"),f=d.find("div.user-panel"),g=-f.outerHeight();c.preventDefault();if(c.type==="mouseleave")return e=setTimeout(function(){f.stop().animate({top:g},200,function(){d.prev().addClass("hide"),d.parent().removeClass("user")}),clearTimeout(e),d.data("timer",e=null)},500),d.data("timer",e),!1;if(e)return clearTimeout(e),d.data("timer",e=null),!1;a||(f.css("top",g),d.find(".user-panel").addClass("show"),a=!0),d.prev().removeClass("hide"),d.parent().addClass("user"),f.stop().animate({top:56},100)}var a=!1;n.on("mouseenter.dropdown mouseleave.dropdown",".navbar .dropdown-wrapper",c),n.on("click","#js-signout",function(a){a.preventDefault(),g.remove("signin"),window.location="/s/logout"})})});