define("uploader",[],function(a,b,c){function k(a,b){var c;a.split(",")[0].indexOf("base64")>=0?c=atob(a.split(",")[1]):c=unescape(a.split(",")[1]);var d=a.split(",")[0].split(":")[1].split(";")[0],e=new ArrayBuffer(c.length),f=new Uint8Array(e);for(var g=0;g<c.length;g++)f[g]=c.charCodeAt(g);var h=window.WebKitBlobBuilder||window.MozBlobBuilder||window.BlobBuilder,i=new h;return i.append(e),i.getBlob(d)}function l(a,b){if(a.mozGetAsFile)return a.mozGetAsFile(b,"image/png");var c=a.toDataURL(),d=k(c);return d}function m(a,b){var c=l(a,b);return c}var d=a("jquery"),e=a("api"),f=a("config"),g=a("dialog"),h=a("filehtml5"),i=g.extend({_fileInputField:null,_buttonBinding:null,queue:null,init:function(){this._fileInputField=null,this.queue=null,this._buttonBinding=null,this._fileList=[]},sync:function(){var a=this.$(".selectfile");this._fileInputField=d(i.HTML5FILEFIELD_TEMPLATE),a.after(this._fileInputField),this._bindDropArea(),this._fileInputField.on("change",d.proxy(this._updateFileList,this))},_bindSelectFile:function(a){var b=this._fileInputField[0];b.click&&b.click()},_bindDropArea:function(a){var b=a||{prevVal:null};b.prevVal!==null&&(b.prevVal.detach("drop",this._ddEventhandler),b.prevVal.detach("dragenter",this._ddEventhandler),b.prevVal.detach("dragover",this._ddEventhandler),b.prevVal.detach("dragleave",this._ddEventhandler));var c=d.proxy(this._ddEventhandler,this);this.element.on("drop",".dropbox",c),this.element.on("dragenter",".dropbox",c),this.element.on("dragover",".dropbox",c),this.element.on("dragleave",".dropbox",c);var e=d.proxy(this._docddEventhandler,this);d(document).on("drop",e).on("dragenter",e).on("dragleave",e).on("dragover",e)},_ddEventhandler:function(a){a.stopPropagation(),a.preventDefault();switch(a.type){case"dragenter":this.emit("dragenter",a);break;case"dragover":this.emit("dragover",a);break;case"dragleave":this.emit("dragleave",a);break;case"drop":var b=this.$(".photozone")[0];if(!d.contains(b,a.target)&&a.target!==b)return!1;this._fileselect(a.originalEvent.dataTransfer.files),this.emit("drop",a)}return!1},_docddEventhandler:function(a){a.stopPropagation(),a.preventDefault();switch(a.type){case"dragenter":this.emit("docdragenter",a);break;case"dragover":this.emit("docdragover",a);break;case"dragleave":this.emit("docdragleave",a);break;case"drop":this.emit("docdrop",a)}},_fileselect:function(a){var b=a,c=[],d,e=this.fileFilterFunction,f=0,g=b.length;if(e)for(;f<g;f++)d=new h(b[f]),e(d)&&c.push(d);else for(;f<g;f++)c.push(new h(b[f]));this.options.limit&&(c=c.slice(-this.options.limit)),c.length>0&&this.emit("fileselect",{fileList:c})},_updateFileList:function(a){this._fileselect(a.target.files)},fileFilterFunction:function(a){var b=!1;return/^image\/(png|gif|bmp|jpg|jpeg)$/.test(a._type)&&(b=!0),b}},{HTML5FILEFIELD_TEMPLATE:'<input type="file" style="visibility:hidden; width:0px; height:0px;" />'}),j={radian:Math.PI*90/180,ri:0,coord:[0,0],z240:1,z80:1,IW:0,IH:0,SCALE:80/240,options:{limit:1,onDrop:function(a){},onImageRotate:function(a,b,c,d,e,f,g,h){b.translate(-a.width/2,-a.height/2),b.clearRect(0,0,a.width,a.height),b.translate(a.width/2,a.height/2),b.save(),b.rotate(d*this.radian),h?b.drawImage(c,e*h,f*h,this.IW*h*g,this.IH*h*g):b.drawImage(c,e,f,this.IW*g,this.IH*g),b.restore(),b.rotate(0)},onFileselect:function(a){var b=this,c=this.filehtml5=a.fileList[0];c.on("uploadcomplete",function(a){}),this.original=c._file,this.$(".overlay").addClass("hide"),this.$(".photozone").find(".back, .rotate").removeClass("hide"),this.$(".resizeable").removeClass("hide");var d=document.getElementById("avatar240"),e=d.getContext("2d"),f=document.getElementById("avatar80"),g=f.getContext("2d"),h=this.img240=document.createElement("img");this.img240.onload=function(){b.ri=0,b.IW=h.width,b.IH=h.height,b.coord=[-b.IW/2,-b.IH/2],b.__dx=b.__dy=0,b.isDrag=!1,n=!1,e.translate(d.width/2,d.height/2),e.drawImage(h,b.coord[0],b.coord[1]),e.save(),g.translate(f.width/2,f.height/2),g.drawImage(h,b.coord[0]*b.SCALE,b.coord[1]*b.SCALE,b.IW*b.SCALE,b.IH*b.SCALE)};if(window.URL&&window.URL.createObjectURL)h.src=window.URL.createObjectURL(c._file);else if(window.webkitURL.createObjectURL)h.src=window.webkitURL.createObjectURL(c._file);else{var i=new FileReader;i.onload=function(){h.src=this.result},i.readAsDataURL(c._file)}b.timer&&clearInterval(b.timer),b.timer=setInterval(function(){if(b.isDrag||n){if(n){u=Math.min(o-q,p-r),u*=5e-4*v,b.z240+=u,b.z80+=u,b.z240<0&&(b.z240=0,b.z80=0),b.emit("imageRotate",d,e,h,b.ri,b.coord[0],b.coord[1],b.z240),b.emit("imageRotate",f,g,h,b.ri,b.coord[0],b.coord[1],b.z80,b.SCALE),b.z240||(b.z240=1,b.z80=1);return}var a,c;b.__dx=b.__mx-b.__sx,b.__dy=b.__my-b.__sy;if(b.__dx||b.__dy){switch(b.ri){case 0:a=b.coord[0]+b.__dx,c=b.coord[1]+b.__dy;break;case-1:a=b.coord[0]-b.__dy,c=b.coord[1]+b.__dx;break;case-2:a=b.coord[0]-b.__dx,c=b.coord[1]-b.__dy;break;case-3:a=b.coord[0]+b.__dy,c=b.coord[1]-b.__dx}b.emit("imageRotate",d,e,h,b.ri,a,c,b.z240),b.emit("imageRotate",f,g,h,b.ri,a,c,b.z80,b.SCALE)}}},20)},backdrop:!1,events:{"click .dropbox":function(a){return console.log(1),a.stopPropagation(),a.preventDefault(),this._bindSelectFile(a),!1},"mousedown #avatar240":function(a){a.preventDefault(),this.isDrag=!0,this.__mx=this.__sx=a.offsetX,this.__my=this.__sy=a.offsetY},"mouseleave #avatar240":function(a){a.preventDefault(),this.isDrag=!1},"mousemove #avatar240":function(a){a.preventDefault(),this.isDrag&&(this.__mx=a.offsetX,this.__my=a.offsetY)},"mouseup #avatar240":function(a){a.preventDefault(),this.isDrag&&(this.ri===-3?(this.coord[0]+=this.__dy,this.coord[1]-=this.__dx):this.ri===-2?(this.coord[0]-=this.__dx,this.coord[1]-=this.__dy):this.ri===-1?(this.coord[0]-=this.__dy,this.coord[1]+=this.__dx):(this.coord[0]+=this.__dx,this.coord[1]+=this.__dy),this.__dx=this.__dy=0,this.isDrag=!1)},"click .rotate":function(a){a.preventDefault(),this.ri--,this.ri===-4&&(this.ri=0);var b=document.getElementById("avatar240"),c=b.getContext("2d");this.emit("imageRotate",b,c,this.img240,this.ri,this.coord[0],this.coord[1],this.z240);var d=document.getElementById("avatar80"),e=d.getContext("2d");this.emit("imageRotate",d,e,this.img240,this.ri,this.coord[0],this.coord[1],this.z80,this.SCALE)},"click .uploader-button":function(a){var b=document.getElementById("avatar80"),c=document.createElement("canvas");c.width=c.height=Math.min(this.img240.width,this.img240.height);var d=c.getContext("2d");d.translate(c.width/2,c.height/2),d.save(),d.rotate(this.ri*this.radian),d.drawImage(this.img240,-c.width/2,-c.height/2),d.restore(),d.save(),this.filehtml5.startUpload(f.api_url+"/avatar/update?token="+e.getToken(),{original:m(c,"original.png"),"80_80":m(b,"80_80.png")})}},onHideAfter:function(){var a=this.element;this.offSrcNode(),this.destory(),a.remove()},viewData:{cls:"modal-uploader",title:"Portrait",body:'<div class="pull-right sider"><div class="pull-right smallphoto"><div class="avatar80"><canvas id="avatar80" width="80" height="80"></canvas></div><div class="overlay"></div></div><div class="uploader-form"><button class="pull-right xbtn xbtn-blue uploader-button">Done</button></div></div><div class="photozone"><i class="icon20-back back hide"></i><i class="icon20-rotate rotate hide"></i><div class="bdt resizeable hide"></div><div class="bdr resizeable hide"></div><div class="bdb resizeable hide"></div><div class="bdl resizeable hide"></div><div class="avatar240"><canvas id="avatar240" width="240" height="240"></canvas></div><div class="overlay dropbox"><div class="droptips">Drop your photo or URL here, <br /> or <span class="selectfile">open</span> local file.</div></div></div>',footer:'<button class="pull-right xbtn xbtn-yellow hide">Yes</button><button class="pull-right xbtn xbtn-white hide">No</button>',others:'<div class="help-portrait hide"><div class="modal-body"><div class="shadow title">Use default portrait?</div><p>You have no portrait set, thus a default one will be assigned automatically. It means you will lose your primary visual identification, consequently poor recognizability confuse your friends.</p><p>Confirm using default portrait?</p></div></div>'}}},n=!1,o,p,q,r,s,t,u,v=1;return d(function(){var a=d(document);a.on("mousedown",".resizeable",function(a){a.preventDefault(),d(this).is(".resizeable")&&(n=!0,o=q=a.pageX,p=r=a.pageY,d(a.target).hasClass("bdl")||d(a.target).hasClass("bdt")?v=-1:v=1)}),a.mouseup(function(a){a.stopPropagation(),a.preventDefault(),n&&(n=!1,o=q=p=r=u=0)}).mousemove(function(a){a.preventDefault(),n&&(o=a.pageX,p=a.pageY)})}),function(){return new i(j)}});